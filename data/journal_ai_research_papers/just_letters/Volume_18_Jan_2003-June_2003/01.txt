journal of artificial intelligence research                

submitted        published      

monte carlo methods for tempo tracking
and rhythm quantization
ali taylan cemgil
bert kappen

snn  geert grooteplein    cpk         university of nijmegen
nl      ez nijmegen  the netherlands

cemgil snn kun nl
bert snn kun nl

abstract

we present a probabilistic generative model for timing deviations in expressive music performance  the structure of the proposed model is equivalent to a switching state
space model  the switch variables correspond to discrete note locations as in a musical
score  the continuous hidden variables denote the tempo  we formulate two well known
music recognition problems  namely tempo tracking and automatic transcription  rhythm
quantization  as filtering and maximum a posteriori  map  state estimation tasks  exact computation of posterior features such as the map state is intractable in this model
class  so we introduce monte carlo methods for integration and optimization  we compare
markov chain monte carlo  mcmc  methods  such as gibbs sampling  simulated annealing and iterative improvement  and sequential monte carlo methods  particle filters   our
simulation results suggest better results with sequential methods  the methods can be
applied in both online and batch scenarios such as tempo tracking and transcription and
are thus potentially useful in a number of music applications such as adaptive automatic
accompaniment  score typesetting and music information retrieval 
   introduction
automatic music transcription refers to extraction of a human readable and interpretable
description from a recording of a musical performance  traditional music notation is such
a description that lists the pitch levels  notes  and corresponding timestamps 
ideally  one would like to recover a score directly from the audio signal  such a representation of the surface structure of music would be very useful in music information retrieval
 music ir  and content description of musical material in large audio databases  however 
when operating on sampled audio data from polyphonic acoustical signals  extraction of a
score like description is a very challenging auditory scene analysis task  vercoe  gardner 
  scheirer        
in this paper  we focus on a subproblem in music ir  where we assume that exact timing
information of notes is available  for example as a stream of midi  events from a digital
keyboard 
a model for tempo tracking and transcription from a midi like music representation
is useful in a broad spectrum of applications  one example is automatic score typesetting 
   musical instruments digital interface  a standard communication protocol especially designed for digital
instruments such as keyboards  each time a key is pressed  a midi keyboard generates a short message
containing pitch and key velocity  a computer can tag each received message by a timestamp for real time
processing and or recording into a file 

c      ai access foundation and morgan kaufmann publishers  all rights reserved 

ficemgil   kappen
the musical analog of word processing  almost all score typesetting applications provide a
means of automatic generation of a conventional music notation from midi data 
in conventional music notation  the onset time of each note is implicitly represented by
the cumulative sum of durations of previous notes  durations are encoded by simple rational
numbers  e g   quarter note  eighth note   consequently all events in music are placed on
a discrete grid  so the basic task in midi transcription is to associate onset times with
discrete grid locations  i e   quantization 
however  unless the music is performed with mechanical precision  identification of the
correct association becomes dicult  this is due to the fact that musicians introduce
intentional  and unintentional  deviations from a mechanical prescription  for example
timing of events can be deliberately delayed or pushed  moreover  the tempo can uctuate
by slowing down or accelerating  in fact  such deviations are natural aspects of expressive
performance  in the absence of these  music tends to sound rather dull and mechanical 
on the other hand  if these deviations are not accounted for during transcription  resulting
scores have often very poor quality 
robust and fast quantization and tempo tracking is also an important requirement for
interactive performance systems  applications that  listen  to a performer for generating an
accompaniment or improvisation in real time  raphael      b  thom         at last  such
models are also useful in musicology for systematic study and characterization of expressive
timing by principled analysis of existing performance data 
from a theoretical perspective  simultaneous quantization and tempo tracking is a
 chicken and egg  problem  the quantization depends upon the intended tempo interpretation and the tempo interpretation depends upon the quantization  apparently  human
listeners can resolve this ambiguity  in most cases  without any effort  even persons without
any musical training are able to determine the beat and the tempo very rapidly  however 
it is still unclear what precisely constitutes tempo and how it relates to the perception of
the beat  rhythmical structure  pitch  style of music etc  tempo is a perceptual construct
and cannot directly be measured in a performance 
the goal of understanding tempo perception has stimulated a significant body of research on the psychological and computational modeling aspects of tempo tracking and
beat induction  e g   see  desain   honing        large   jones        toiviainen        
these papers assume that events are presented as an onset list  attempts are also made
to deal directly with the audio signal  goto   muraoka        scheirer        dixon  
cambouropoulos        
another class of tempo tracking models are developed in the context of interactive
performance systems and score following  these models make use of prior knowledge in the
form of an annotated score  dannenberg        vercoe   puckette         more recently 
raphael      b  has demonstrated an interactive real time system that follows a solo player
and schedules accompaniment events according to the player s tempo interpretation 
tempo tracking is crucial for quantization  since one can not uniquely quantize onsets
without having an estimate of tempo and the beat  the converse  that quantization can
help in identification of the correct tempo interpretation has already been noted by desain
and honing         here  one defines correct tempo as the one that results in a simpler
quantization  however  such a schema has never been fully implemented in practice due
to computational complexity of obtaining a perceptually plausible quantization  hence

  

fimonte carlo methods for tempo tracking and rhythm quantization
quantization methods proposed in the literature either estimate the tempo using simple
heuristics  longuet higgins        pressing   lawrence        agon  assayag  fineberg 
  rueda        or assume that the tempo is known or constant  desain   honing       
cambouropoulos        hamanaka  goto  asoh    otsu        
our approach to transcription and tempo tracking is from a probabilistic  i e   bayesian
modeling perspective  in cemgil et al          we introduced a probabilistic approach to
perceptually realistic quantization  this work also assumed that the tempo was known or
was estimated by an external procedure  for tempo tracking  we introduced a kalman filter
model  cemgil  kappen  desain    honing         in this approach  we modeled the tempo
as a smoothly varying hidden state variable of a stochastic dynamical system 
in the current paper  we integrate quantization and tempo tracking  basically  our
model balances score complexity versus smoothness in tempo deviations  the correct tempo
interpretation results in a simple quantization and the correct quantization results in a
smooth tempo uctuation  an essentially similar model is proposed recently also by raphael
     a   however  raphael uses an inference technique that only applies for small models 
namely when the continuous hidden state is one dimensional  this severely restricts the
models one can consider  in the current paper  we survey general and widely used state ofthe art techniques for inference 
the outline of the paper is as follows  in section    we propose a probabilistic model for
timing deviations in expressive music performance  given the model  we will define tempo
tracking and quantization as inference of posterior quantities  it will turn out that our model
is a switching state space model in which computation of exact probabilities becomes intractable  in section    we will introduce approximation techniques based on simulation 
namely markov chain monte carlo  mcmc  and sequential monte carlo  smc   doucet 
de freitas    gordon        andrieu  de freitas  doucet    jordan         both approaches
provide exible and powerful inference methods that have been successfully applied in diverse fields of applied sciences such as robotics  fox  burgard    thrun         aircraft
tracking  gordon  salmond    smith         computer vision  isard   blake         econometrics  tanizaki         finally we will present simulation results and conclusions 

   model
assume that a pianist is improvising and we are recording the exact onset times of each key
she presses during the performance  we denote these observed onset times by y    y    y       
yk       yk or more compactly by y  k   we neither have access to a musical notation of the
piece nor know the initial tempo she has started her performance with  moreover  the
pianist is allowed to freely change the tempo or introduce expression  given only onset
time information y  k   we wish to find a score   k and track her tempo uctuations z  k  
we will refine the meaning of  and z later 
this problem is apparently ill posed  if the pianist is allowed to change the tempo
arbitrarily it is not possible to assign a  correct  score to a given performance  in other
words any performance y  k can be represented by using a suitable combination of an
arbitrary score with an arbitrary tempo trajectory  fortunately  the bayes theorem provides
an elegant and principled guideline to formulate the problem  given the onsets y  k   the
best score   k and tempo trajectory z  k can be derived from the posterior distribution

  

ficemgil   kappen
that is given by
 
p y j   z  p    z  
p y  k     k   k   k   k   k
a quantity  that is proportional to the product of the likelihood term p y  k j  k   z  k   and
the prior term p   k   z  k   
in rhythm transcription and tempo tracking  the prior encodes our background knowledge about the nature of musical scores and tempo deviations  for example  we can construct a prior that prefers  simple  scores and smooth tempo variations 
the likelihood term relates the tempo and the score to actual observed onset times  in
this respect  the likelihood is a model for short time expressive timing deviations and motor
errors that are introduced by the performer 

p   k   z  k jy  k    

  c 
  c 
       f
  ck
ee
ff
cc
f
ee
ee
cc
ff
ee
ee
cc
ff
ee
ee
cc
ff
cc
e  
e  
  
      

c  ee

 

k  

 

     
   
   
bb
  
bb
bb
  
bb
bb
  
bb
bb
  
bb
b
  
b  
b  
   
   
     

  b

 


y 



y 



y 

     
cc quantization
cc
hh
cc
hh
cc
hh
cc
h  
 
  ck

  hh

k

score

  k
   tempo
  
trajectory
  
ee
 
ee
  
ee
  
ee
  
e  
 
  k
     noiseless
 
onsets

k  e
 

 



k  


   

   

locations



yk  

yk

  observed
  
onsets

figure    graphical model  square and oval nodes correspond to discrete and continuous
variables respectively  in the text  we sometimes refer to the continuous hidden
variables  k   k   by zk   the dependence between  and c is deterministic  all
c      and  are hidden  only onsets y are observed 

    score prior
to define a score   k   we first introduce a sequence of quantization locations c  k   a
quantization location ck specifies the score time of the k th onset  we let k denote the
interval between quantization locations of two consecutive onsets
k   ck

ck  

   

for example consider the conventional music notation
which encodes the score      
             corresponding quantization locations are c                  
one simple way of defining a prior distribution on quantization locations p ck   is specifying a table of probabilities for ck mod    the fraction of ck    for example if we wish to


  





fimonte carlo methods for tempo tracking and rhythm quantization
allow for scores that have sixteenth notes and triplets  we define a table of probabilities for
the states c mod     f                  g f             g  technically  the resulting prior
p ck   is periodic and improper  since ck are in principle unbounded so we can not normalize
the distribution  
however  if the number of states of ck mod   is large  it may be dicult to estimate the
parameters of the prior reliably  for such situations we propose a  generic  prior as follows 
we define the probability  that the k th onset gets quantized at location ck   by p ck    
exp  d ck    where d ck   is the number of significant digits in the binary expansion of ck
mod    for example d         d           d               etc  the positive parameter  is
used to penalize quantization locations that require more bits to be represented  assuming
that quantization locations of onsets are independent a priori   besides being increasing in
k  i e   ck  ck      p
the prior probability of a sequence of quantization locations is given by
p c  k     exp   k
k   d ck     we further assume that c            one can check that
    p 
   we can generalize this
such a prior prefers simpler notations  e g   p 
prior to other subdivisions such triplets and quintiplets in appendix a 
formally  given a distribution on c  k   the prior of a score   k is given by






 

p   k    

x

c  k











 

p   k jc  k  p c  k  

   

since the relationship between c  k and   k is deterministic  p   k jc  k   is degenerate for
any given c  k   so we have

p   k     exp



k
k
x
x

 

d  k   
   
   k    
one might be tempted to specify a prior directly on   k and get rid of c  k entirely 
however  with this simpler approach it is not easy to devise realistic priors  for example 
consider a sequence of note durations                        assuming a factorized prior on
 that penalizes short note durations  this rhythm would have relatively high probability
whereas it is quite uncommon in conventional music 
k

    tempo prior
we represent the tempo in terms of its inverse  i e   the period  and denote it with   for
example a tempo of     beats per minute  bpm  corresponds to                 seconds 
at each onset the tempo changes by an unknown amount k   we assume the change k
is iid with n     q      we assume a first order gauss markov process for the tempo
k   k     k
   
eq    defines a distribution over tempo sequences   k   given a tempo sequence  the
 ideal  or  intended  time k of the next onset is given by

k   k     k k     k

   

   we denote a  scalar or multivariate  gaussian distribution p x  with mean vector  and covariance
 
matrix p by n    p   
  j p j   exp      x  t p    x    

  

ficemgil   kappen
the noise term k denotes the amount of accentuation  that is deliberately playing a
note ahead or back in time  without causing the tempo to be changed  we assume k 
n     q    ideal onsets and actually observed  noisy  onsets are related by

yk   k   k

   

the noise term k models small scale expressive deviations or motor errors in timing of individual notes  in this paper we will assume that k has a gaussian distribution parameterized
by n     r  
the initial tempo distribution p     specifies a range of reasonable tempi and is given
by a gaussian with a broad variance  we assume an uninformative  at  prior on     the
conditional independence structure is given by the graphical model in figure    table  
shows a possible realization from the model 
we note that our model is a particular instance of the well known switching state space
model  also known as conditionally linear dynamical system  jump markov linear system 
switching kalman filter   see  e g   bar shalom   li        doucet   andrieu       
murphy        

k  
 
 
 
k
   
ck                  
k                        
k                       
yk                       


 





 

table    a possible realization from the model  a ritardando  for clarity we assume      
in the following sections  we will sometimes refer use zk    k   k  t and refer to z  k
as a tempo trajectory  given this definition  we can compactly represent eq    and eq    by

zk  



  k
   



zk     k

   

where k    k   k   

    extensions
there are several possible extensions to this basic parameterization  for example  one could
represent the period  in the logarithmic scale  this warping ensures positivity and seems
to be perceptually more plausible since it promotes equal relative changes in tempo rather
than on an absolute scale  grubb        cemgil et al          although the resulting model
becomes nonlinear  it can be approximated fairly well by an extended kalman filter  barshalom   li        
a simple random walk model for tempo uctuations such as in eq    seems not to be
very realistic  we would expect the tempo deviations to be more structured and smoother 

  

fimonte carlo methods for tempo tracking and rhythm quantization
in our dynamical system framework such smooth deviations can be modeled by increasing
the dimensionality of z to include higher order  inertia  variables  cemgil et al          for
example consider the following model 

 
k
b
  k
b
b
  k
b
b
     

d   k

 
 
  
  k k          
k  
c
b
c
b
                c b   k  
c
b
c
b
c
b
  k  
  b   
c
c
b
c
b
c
b
 
 
  
a
       
a 
a
 
   

d   k  

 
c
c
c
  k
c
c
a

   

we choose this particular parameterization because we wish to interpret   as the slowly
varying  average  tempo and   as a temporary change in the tempo  such a model is useful
for situations where the performer uctuates around an almost constant tempo  a random
walk model is not sucient in this case because it forgets the initial values  additional state
variables             d   act like additional  memory  elements  by choosing the parameter
matrix a and noise covariance matrix q  one can model a rich range of temporal structures
in expressive timing deviations 
the score prior can be improved by using a richer model  for example to allow for
different time signatures and alternative rhythmic subdivisions  one can introduce additional
hidden variables  see cemgil et al         or appendix a  or use a markov chain  raphael 
    a   potentially  such extensions make it easier to capture additional structure in musical
rhythm  such as  weak  positions are followed more likely by  strong  positions   on the
other hand  the number of model parameters rapidly increases and one has to be more
cautious in order to avoid overfitting 
for score typesetting  we need to quantize note durations as well  i e   associate note
offsets with quantization locations  a simple way of accomplishing this is to define an
indicator sequence u  k that identifies whether yk is an onset  uk      or an offset  uk  
    given uk   we can redefine the observation model as p yk jk   uk     uk n     r      
uk  n     roff   where roff is the observation noise associated with offsets  a typical model
would have roff  r  for roff      the offsets would have no effect on the tempo process 
moreover  since uk are always observed  this extension requires just a simple lookup 
in principle  one must allow for arbitrary long intervals between onsets  hence k are
drawn from an infinite  but discrete  set  in our subsequent derivations  we assume that the
number of possible intervals is fixed a priori  given an estimate of zk   and observation yk  
almost all of the virtually infinite number of choices for k will have almost zero probability
and it is easy to identify candidates that would have significant probability mass 
conceptually  all of the above listed extensions are easy to incorporate into the model
and none of them introduces a fundamental computational diculty to the basic problems
of quantization and tempo tracking 

  

ficemgil   kappen
    problem definition
given the model  we define rhythm transcription  i e   quantization as a map state estimation problem
   k   argmax p   k jy  k  
   
p   k jy  k    

z   k

dz  k p   k   z  k jy  k  

and tempo tracking as a filtering problem
x
zk   argmax p   k   zk jy  k  
zk

  k

    

the quantization problem is a smoothing problem  we wish to find the most likely score

  k given all the onsets in the performance  this is useful in  oine  applications such as
score typesetting 
for real time interaction  we need to have an online estimate of the tempo beat zk  
this information is carried forth by the filtering density p   k   zk jy  k   in eq     our
definition of the best tempo zk as the maximum is somewhat arbitrary  depending upon
the requirements of an application  p
one can make use of other features of the filtering
density  for example  the variance of   k p   k   zk jy  k   can be used to estimate  amount
of confidence  in tempo interpretation or arg maxzk    k p   k   zk jy  k   to estimate most
likely score tempo pair so far 
unfortunately  the quantities in eq    and eq     are intractable due to the explosion in
the number of mixture components required to represent the exact posterior at each step k
 see figure     for example  to calculate the exact posterior in eq    we need to evaluate
the following expression 
z
 
dz  k p y  k jz  k     k  p z  k j  k  p   k  
    
p   k jy  k    

z
 
  p y  k j  k  p   k  
    
z
p
where the normalization constant is given by z   p y  k       k p y  k j  k  p   k    for
each trajectory   k   the integral over z  k can be computed stepwise in k by the kalman
filter  see appendix b     however  to find the map state of eq      we need to evaluate
p y  k j  k   independently for each of the exponentially many trajectories  consequently 
the quantization problem in eq    can only be solved approximately 
for accurate approximation  we wish to exploit any inherent independence structure of
the exact posterior  unfortunately  since z and c are integrated over  all k become coupled
and in general p   k jy  k   does not possess any conditional independence structure  e g  
a markov chain  that would facilitate ecient calculation  consequently  we will resort to
numerical approximation techniques 

   monte carlo simulation
consider a high dimensional probability distribution
 
p x    p  x 
z

  

    

fimonte carlo methods for tempo tracking and rhythm quantization

   

   

   

   

   

   

      

 

 

      
       





      

   

   
      
      

   

   

   

   
   

   

 

   

 

   


 

   

 

   

 a 

   
   

 

   

 

 

   

   


 

   

 

   

 b 

   

   
      
   

      
       
      



 

   

       
       
     

   

      

   

   
   

figure   

 

   

 

   


 

   

 c 

example demonstrating the explosion of the number of components to represent the
exact posterior  ellipses denote the conditional marginals p k    k jc  k   y  k     we show
the period in logarithmic scale where  k   log  k    in this toy example  we assume
that a score consists only of notes of length and   i e   k can be either     or   
 a  we start with a unimodal posterior p        jc    y     e g   a gaussian centered at
                since we assume that a score can only consist of eight  and quarter
notes  i e   k   f      g  the predictive distribution p       jc     y   is bimodal where
the modes are centered at          and        respectively  shown with a dashed contour
line   once the next observation y  is observed  shown with a dashed vertical line around
         the predictive distribution is updated to yield p        jc      y       the numbers
denote the respective log posterior weight of each mixture component   b  the predictive
distribution p       jc     y     at step k     has now   modes  two for each component
of p      jc     y       c  the number of components grows exponentially with k 




  

 

ficemgil   kappen
r
where the normalization constant z   dxp  x  is not known but p  x  can be evaluated
at any particular x  suppose we want to estimate the expectation of a function f  x  under
the distribution p x  denoted as
z

hf  x ip x    dxf  x p x 
e g   the mean of x under p x  is given by hxi  the intractable integration can be approximated by an average if we can find n points x i    i           n from p x 

hf  x ip x   n 

n
x

  

i

f  x i   

    

when x i  are generated by independently sampling from p x   it can be shown that as n
approaches infinity  the approximation becomes exact 
however  generating independent samples from p x  is a dicult task in high dimensions but it is usually easier to generate dependent samples  that is we generate x i    by
making use of x i    it is somewhat surprising  that even if x i  and x i    are correlated
 and provided ergodicity conditions are satisfied   eq     remains still valid and estimated
quantities converge to their true values when number of samples n goes to infinity 
a sequence of dependent samples x i  is generated by using a markov chain that has
the stationary distribution p x   the chain is defined by a collection of transition probabilities  i e   a transition kernel t  x i    jx i     the definition of the kernel is implicit  in
the sense that one defines a procedure to generate the x i    given x i    the metropolis
algorithm  metropolis   ulam        metropolis  rosenbluth  rosenbluth  teller    teller 
      provides a simple way of defining an ergodic kernel that has the desired stationary
distribution p x   suppose we have a sample x i    a candidate x  is generated by sampling from a symmetric proposal distribution q x  jx i     for example a gaussian centered
at x i     the candidate x  is accepted as the next sample x i    if p x      p x i     if x 
has a lower probability  it can be still accepted  but only with probability p x    p x i    
the algorithm is initialized by generating the first sample x    according to an  arbitrary 
proposal distribution 
however for a given transition kernel t   it is hard to assess the time required to converge
to the stationary distribution so in practice one has to run the simulation until a very large
number of samples have been obtained   see e g   roberts   rosenthal         the choice
of the proposal distribution q is also very critical  a poor choice may lead to the rejection of
many candidates x  hence resulting in a very slow convergence to the stationary distribution 
for a large class of probability models  where the full posterior p x  is intractable  one
can still eciently compute marginals of form p xk jx k    x k   x        xk     xk           xk
exactly  in this case one can apply a more specialized markov chain monte carlo  mcmc 
algorithm  the gibbs sampler given below 
   initialize x   
  k by sampling from a proposal q x  k  
   for i           n

 

  

fimonte carlo methods for tempo tracking and rhythm quantization

 for k              k   sample

 i 
x ki     p xk jx   i   
    
k     xk   k  
in contrast to the metropolis algorithm  where the new candidate is a vector x    the
gibbs sampler uses the exact marginal p xk jx k   as the proposal distribution  at each
step  the sampler updates only one coordinate of the current state x  namely xk   and the
new candidate is guaranteed to be accepted 
note that  in principle we don t need to sample xk sequentially  i e   we can choose k
randomly provided that each slice is visited equally often in the limit  however  a deterministic scan algorithm where k            k   provides important time savings in the type of
models that we consider here 
    simulated annealing and iterative improvement
now we shift our focus from sampling to map state estimation  in principle  one can use the
samples generated by any sampling algorithm  metropolis hastings or gibbs  to estimate
the map state x of p x  by argmax p x i     however  unless the posterior is very much
i   n
concentrated around the map state  the sampler may not visit x even though the samples
x i  are obtained from the stationary distribution  in this case  the problem can be simply
reformulated to sample not from p x  but from a distribution that is concentrated at local
maxima of p x   one such class of distributions are given by pj  x    p x j   a sequence of
exponents              j         is called to be a cooling schedule or annealing schedule
owing to the inverse temperature interpretation of j in statistical mechanics  hence the
name simulated annealing  sa   aarts   van laarhoven         when j     suciently
slowly in j   the cascade of mcmc samplers each with the stationary distribution pj  x  is
guaranteed  in the limit  to converge to the global maximum of p x   unfortunately  for this
convergence result to hold  the cooling schedule must go very slowly  in fact  logarithmically 
to infinity  in practice  faster cooling schedules must be employed 
iterative improvement  ii   aarts   van laarhoven        is a heuristic simulated annealing algorithm with a very fast cooling schedule  in fact  j     for all j   the eventual
advantage of this greedy algorithm is that it converges in a few iterations to a local maximum  by restarting many times from different initial configurations x  one hopes to find
different local maxima of p x  and eventually visit the map state x   in practice  by using
the ii heuristic one may find better solutions than sa for a limited computation time 
from an implementation point of view  it is trivial to convert mcmc code to sa  or ii 
code  for example  consider the gibbs sampler  to implement sa  we need to construct
a cascade of gibbs samplers  each with stationary distribution p x j   the exact one time
slice marginal of this distribution is p xk jx k  j   so  sa just samples from the actual
 temperature    marginal p xk jx k   raised to a power j  
    the switching state space model and map estimation
to solve the rhythm quantization problem  we need to calculate the map state of the
posterior in eq    
p   k jy  k  

z

  p   k   dz  k p y  k jz  k     k  p z  k j  k  
  

    

ficemgil   kappen
this is a combinatorial optimization problem  we seek the maximum of a function p   k jy  k  
that associates a number with each of the discrete configurations   k   since it is not feasible
to visit all of the exponentially many configurations to find the maximizing configuration
   k   we will resort to stochastic search algorithms such as simulated annealing  sa  and
iterative improvement  ii   due to the strong relationship between the gibbs sampler and
sa  or ii   we will first review the gibbs sampler for the switching state space model 
the first important observation is that  conditioned on   k   the model becomes a linear
state space model and the integration on z  k can be computed analytically using kalman
filtering equations  consequently  one can sample only   k and integrate out z   the
analytical marginalization  called rao blackwellization  casella   robert         improves
the eciency of the sampler  e g   see doucet  de freitas  murphy    russell      a  
suppose now that each switch variable k can have s distinct states and we wish to
    i           n g  a naive implementation of the
generate n samples  i e trajectories  f   ik
gibbs sampler requires that at each step k we run the kalman filter s times on the whole
observation sequence y  k to compute the proposal p k j   ik      k i     k   y  k    this would
result in an algorithm of time complexity o nk   s   that is prohibitively slow when k is
large  carter and kohn        have proposed a much more time ecient deterministic scan
gibbs sampler that circumvents the need to run the kalman filtering equations at each
step k on the whole observation sequence y  k   see also  doucet   andrieu        murphy 
      
the method is based on the observation that the proposal distribution p k j   can
be factorized as a product of terms that either depend on past observations y  k or the
future observations yk   k   so the contribution of the future can be computed a priori by
a backward filtering pass  subsequently  the proposal is computed and samples k i  are
generated during the forward pass  the sampling distribution is given by

p k j k   y  k     p k j k  p y  k j  k  

    

where the first term is proportional to the joint prior p k j k     p k    k    the second
term can be decomposed as

p y  k j  k    
 

z
z

dzk p yk   k jy  k   zk     k  p y  k   zk j  k  

    

dzk p yk   k jzk   k   k  p y  k   zk j  k  

    

both terms are  unnormalized  gaussian potentials hence the integral can be evaluated
analytically  the term p yk   k jzk   k   k   is an unnormalized gaussian potential in zk and
can be computed by backwards filtering  the second term is just the filtering distribution
p zk jy  k     k   scaled by the likelihood p y  k j  k   and can be computed during forward
filtering  the outline of the algorithm is given below  see the appendix b   for details 
   initialize      k by sampling from a proposal q   k  
   for i           n

 for k   k              
  

fimonte carlo methods for tempo tracking and rhythm quantization



  compute p yk   k jzk   k i     k  
for k              k  
  for s           s
 compute the proposal
p k   sj     p k   s   k  

z

dzk p y  k   zk j   ik      k   s p yk   k jzk   k i     k  

  sample k i  from p k j  
the resulting algorithm has a time complexity of o nks    an important saving in terms
of time  however  the space complexity increases from o    to o k   since expectations
computed during the backward pass need to be stored 
at each step  the gibbs sampler generates a sample from a single time slice k  in
certain types of  sticky  models  such as when the dependence between k and k   is
strong  the sampler may get stuck in one configuration  moving very rarely  this is due to
the fact that most singleton ips end up in low probability configurations due to the strong
dependence between adjacent time slices  as an example  consider the quantization model
and two configurations        k   k                                 and                          by updating
only a single slice  it may be dicult to move between these two configurations  consider
an intermediate configuration                        since the duration  k   k     increases  all
future quantization locations ck k are shifted by      that may correspond to a score that
is heavily penalized by the prior  thus  blocking  the path 
to allow the sampler move more freely  i e   to allow for more global jumps  one can
sample from l slices jointly  in this case the proposal distribution takes the form
p k k l  j     p k k l      k k l     
z
dzk l   p y  k l    zk l   j   ik      k k l   p yk l k jzk l     k i l   k  
similar to the one slice case  terms under the integral are unnormalized gaussian potentials
 on zk l     representing the contribution of past and future observations  since k k l  
has s l states  the resulting time complexity for generating n samples is o nks l    thus in
practice l must be kept rather small  one remedy would be to use a metropolis hastings
algorithm with a heuristic proposal distribution q k k l  jy  k   to circumvent exact calculation  but it is not obvious how to construct such a q 
one other shortcoming of the gibbs sampler  and related mcmc methods  is that the
algorithm in its standard form is inherently oine  we need to have access to all of the
observations y  k to start the simulation  for certain applications  e g   automatic score
typesetting  a batch algorithm might be still feasible  however in scenarios that require
real time interaction  such as in interactive music performance or tempo tracking  online
methods must be used 
    sequential monte carlo
sequential monte carlo  a k a  particle filtering  is a powerful alternative to mcmc for
generating samples from a target posterior distribution  smc is especially suitable for
application in dynamical systems  where observations arrive sequentially 

  

ficemgil   kappen
the basic idea in smc is to represent the posterior p x  k   jy  k     at time k   by
a  possibly weighted  set of samples fx   i k     i           n g and extend this representation
to f x   i k     x ki     i           n g when the observation yk becomes available at time k  the
common practice is to use importance sampling 
      importance sampling

consider again a high dimensional probability distribution p x    p  x  z with an unknown
normalization constant  suppose we are given a proposal distribution q x  that is close to
p x  such that high probability regions of both distributions fairly overlap  we
p generate
independent samples  i e   particles  x i  from the proposal such that q x   ni    x
x i    n   then we can approximate
  p  x 
q x 
    
p x   
z q x 
n

x
 z  pq  xx   n   x x i   
    
i  
n
x
w i 

    
pn  j   x x i   
j    w
i  
where w i    p  x i    q x i    are the importance weights  one can interpret w i  as correction factors to compensate for the fact that we have sampled from the  incorrect  distribution q x   given the approximation in eq    we can estimate expectations by weighted
averages
n
x
hf  x ip x  
w   i  f  x i   

where w   i    w i   

pn
j

  

    

i

   w

 j   are the normalized importance weights 

      sequential importance sampling

now we wish to apply importance sampling to the dynamical model

p x  k jy  k  

 

k
y
k

  

p yk jxk  p xk jx  k    

    

where x   fz   g  in principle one can naively apply standard importance sampling by using
an arbitrary proposal distribution q x  k    however finding a good proposal distribution
can be hard if k     the key idea in sequential importance sampling is the sequential
construction of the proposal distribution  possibly using the available observations y  k   i e  

q x  k jy  k    

k
y
k

  

  

q xk jx  k     y  k  

fimonte carlo methods for tempo tracking and rhythm quantization
given a sequentially constructed proposal distribution  one can compute the importance
weight recursively as

p  x   i k jy  k   p yk jx ki   p x ki  jx   i k     y  k     p y  k   jx   i k    p x   i k    
 
    
q x   i k jy  k  
q x ki  jx   i k   y  k  
q x   i k   jy  k    
p yk jx ki   p x ki  jx   i k     y  k      i 
 
wk  
    
q x ki  jx   i k   y  k  

wk i   

the sequential update schema is potentially more accurate than naive importance sampling since at each step k  one can generate a particle from a fairly accurate proposal
distribution that takes the current observation yk into account  a natural choice for the
proposal distribution is the filtering distribution given as

q xk jx   i k   y  k     p xk jx   i k     y  k  

    

in this case the weight update rule in eq     simplifies to

wk i    p yk jx   i k    wk i   
in fact  provided that the proposal distribution q is constructed sequentially and past sampled trajectories are not updated  the filtering distribution is the optimal choice in the sense
of minimizing the variance of importance weights w i   doucet  godsill    andrieu      b  
note that eq     is identical to the proposal distribution used in gibbs sampling at k   k
 eq      at k   k   the smc proposal does not take future observations into account  so
we introduce discount factors wk to compensate for sampling from the wrong distribution 
      selection

unfortunately  the sequential importance sampling may be degenerate  in fact  it can be
shown that the variance of wk i  increases with k  in practice  after a few iterations of
the algorithm  only one particle has almost all of the probability mass and most of the
computation time is wasted for updating particles with negligible probability 
to avoid the undesired degeneracy problem  several heuristic approaches are proposed
in the literature  the basic idea is to duplicate or discard particles according to their
normalized importance weights  the selection procedure can be deterministic or stochastic  deterministic selection is usually greedy  one chooses n particles with the highest
importance weights  in the stochastic case  called resampling  particles are drawn with a
probability proportional to their importance weight wk i    recall that normalized weights
fw k i    i           n g can be interpreted as a discrete distribution on particle labels  i  

    smc for the switching state space model
the sis algorithm can be directly applied to the switching state space model by sampling
directly from xk    zk   k    however  the particulate approximation can be quite poor if z

  

ficemgil   kappen
   

   

   



 

   

   

   

   
   

 

   

 

   


 

   

 

   

figure    outline of the algorithm  the ellipses correspond to the conditionals
p zk jk i    y  k    vertical dotted lines denote the observations yk   at each step
k  particles with low likelihood are discarded  surviving particles are linked to
their parents 

is high dimensional  hence  too many particles may be needed to accurately represent the
posterior 
similar to the mcmc methods introduced in the previous section  eciency can be
improved by analytically integrating out z  k and only sampling from   k   in fact  this
form of rao blackwellization is reported to give superior results when compared to standard
particle filtering where both  and z are sampled jointly  chen   liu        doucet et al  
    b   the improvement is perhaps not surprising  since importance sampling performs
best when the sampled space is low dimensional 
the algorithm has an intuitive interpretation in terms of a randomized breadth first tree
search procedure  at each new step k  we expand n kernels to obtain s  n new kernels 
consequently  to avoid explosion in the number of branches  we select n out of s  n
branches proportional to the likelihood  see figure    the derivation and technical details
of the algorithm are given in the appendix c 
the tree search interpretation immediately suggests a deterministic version of the algorithm where one selects  without replacement  the n branches with highest weight  we
will refer to this method as a greedy filter  gf   the method is also known as split track
filter  chen   liu        and is closely related to multiple hypothesis tracking  mht 
 bar shalom   fortmann         one problem with the greedy selection schema of gf is
the loss of particle diversity  even if the particles are initialized to different locations in z   
 e g   to different initial tempi   mainly due to the discrete nature of the state space of k  
most of the particles become identical after a few steps k  consequently  results can not
be improved by increasing the number of particles n   nevertheless  when only very few
particles can be used  say e g   in a real time application  gf may still be a viable choice 

  

fimonte carlo methods for tempo tracking and rhythm quantization

 i  is optimal  we
figure    a hypothetical situation where neither of the two particles    
would obtain eventually a higher likelihood configuration by interchanging  
between particles 
    smc and estimation of the map trajectory
like mcmc  smc is a sampling method  hence comments made in section     about the
  jy  
eventual suboptimality of estimating the map trajectory from particles as arg max p    ik
  k
also apply here  an hypothetical situation is shown in figure   
one obvious solution is to employ the sa  trick  and raise the proposal distribution to
a power p k j    however  such a proposal will be peaked on a very few  at each time
slice  consequently  most of the particles will become identical in time and the algorithm
eventually degenerates to greedy filtering 
an algorithm for estimating the map trajectory from a set of smc samples is recently
proposed in the literature  godsill  doucet    west         the algorithm relies on the
observation that once the particles x ki  are sampled during the forward pass  one is left with
n
a discrete distribution defined on the  discrete  supportn
x  k   k
k   xk   here xk denotes
is the support of the filtering distribution a time k and is the cartesian product between
s
sets  formally  xk is the set of distinct samples at time k and is given by xk   i fx ki  g 
the distribution p x  k jy  k    is markovian because the original state transition model
is markovian  i e   the posterior can be represented exactly by
p x  k jy  k    

k
y

p yk jxk  p xk jxk    
  
consequently  one can find the best map trajectory arg max p x  k   by using an algorithm
that is analogous to the viterbi algorithm for hidden markov models  rabiner        
however  this idea does not carry directly to the case when one applies rao blackwellization  in general  when a subset of the hidden variables
nisk integrated out sall time
slices of the posterior p    k jy  k   are coupled  where   k   k   k and k   i fk i  g 
one can still employ a chain approximation and run viterbi   e g   cemgil   kappen 
       but this does not guarantee to find arg max p    k jy  k   
on the other hand  because k i  are drawn from a discrete set  several particles become
identical so k has usually a small cardinality when compared to the number of particles
n   consequently  it becomes feasible to employ sa or ii on the reduced state space   k  
possibly using a proposal distribution that extends over several time slices l 
k

   by a slight abuse of notation we use the symbol xk both as a set and as a general element when used
in the argument of a density  p yk jxk   means p yk jxk   s t  xk   xk

  

ficemgil   kappen
    i           n g  we
in practice  for finding the map solution from the particle set f   ik
   p   i    and apply iterative
propose to find the best trajectory i   arg maxi p y  k j   ik
  k

improvement starting from the initial configuration    ik   

   simulations
we have compared the inference methods in terms of the quality of the solution and execution time  the tests are carried out both on artificial and real data 
given the true notation   true
k   we measure the quality of a solution in terms of the
log likelihood difference
l   log

p y  k j  k  p   k  
true
p y  k j  true
k  p   k  

and in terms of edit distance

e   k    

k
x

    k

ktrue   

  
the edit distance e   k   gives simply the number of notes that are quantized wrongly 
k

    artificial data  clave pattern
 c                 
the synthetic example is a repeating  son clave  pattern
           with uctuating tempo  we repeat the pattern   times and obtain a score   k with
k      
such syncopated rhythms are usually hard to transcribe and make it dicult to track
the tempo even for experienced human listeners  moreover  since onsets are absent at
prominent beat locations  standard beat tracking algorithms usually loose track 
given score   k   we have generated     observation sequences y  k by sampling from
the tempo model in eq     we have parameterized the observation noise variance  as
q   k qa   qb   in this formulation  the variance depends on the length of the interval
between consecutive onsets  longer notes in the score allow for more tempo and timing
uctuation  for the tests on the clave example we have not used a prior model that reects
true source statistics  instead  we have used the generic prior model defined in section    
with      
all the example cases are sampled from the same score  clave pattern   however  due
to the use of the generic prior  that does not capture the exact source statistics well  and a
relatively broad noise model  the map trajectory    k given y  k is not always identical to
 i
the original clave pattern  for the i th example  we have defined the  ground truth    true
k as
the highest likelihood solution found using any sampling technique during any independent
run  although this definition of the ground truth introduces some bias  we have found
this exercise more realistic as well as more discriminative among various methods when
compared to  e g    using a dataset with essentially shorter sequences where the exact map
 

 



 









 

   the noise covariance parameters were r           qa         i and qb         i   i is a      identity
matrix 

  

fimonte carlo methods for tempo tracking and rhythm quantization
trajectory can be computed by exhaustive enumeration  the wish to stress that the main
aim of the simulations on synthetic dataset is to compare effectiveness of different inference
techniques  we postpone the actual test whether the model is a good one to our simulations
on real data 
we have tested the mcmc methods  namely gibbs sampling  gibbs   simulated annealing  sa  and iterative improvement  ii  with one and two time slice optimal proposal
and for    and    sweeps  for each onset yk   the optimal proposal p k j  is computed
always on a fixed set    f                   g  figure   shows a typical run of mcmc 
similarly  we have implemented the smc for n   f                 g particles  the
selection schema was random drawing from the optimal proposal p k j  computed using
one or two time slices  only in the special case of greedy filtering  gf   i e   when n      we
have selected the switch with maximum probability  an example run is shown in figure   
we observe that on average smc results are superior to mcmc  figure     we observe
that  increasing the number of sweeps for mcmc does not improve the solution significantly 
on the other hand  increasing the number of particles seems to improve the quality of the
smc solution monotonically  moreover  the results suggest that sampling from two time
slices jointly  with the exception of sa   does not have a big effect  gf outperforms a
particle filter with   particles that draws randomly from the proposal  that suggests that
for pf with a small number of particles n   it may be desirable to use a hybrid selection
schema that selects the particle with maximum weight automatically and randomly selects
the remaining n   
we compare inference methods in terms of execution time and the quality of solutions  as
measured by edit distance   as figure   suggests  using a two slice proposal is not justified 
moreover it seems that for comparable computational effort  smc tends to outperform all
mcmc methods 

    real data  beatles
we evaluate the performance of the model on polyphonic piano performances     pianists
were invited to play two beatles songs  michelle and yesterday  both pieces have a relatively
simple rhythmic structure with ample opportunity to add expressiveness by uctuating the
tempo  the original score is shown in figure   a   the subjects had different musical education and background  four professional jazz players  four professional classical performers
and four amateur classical pianists  each arrangement had to be played in three tempo
conditions  three repetitions per tempo condition  the tempo conditions were normal  slow
and fast tempo  all in a musically realistic range and all according to the judgment of the
performer  further details are reported in  cemgil et al         
      preprocessing

the original performances contained several errors  such as missing notes or additional notes
that were not on the original score  such errors are eliminated by using a matching technique  heijink  desain    honing        based on dynamical programming  however  visual
inspection of the resulting dataset suggested still several matching errors that we interpret
as outliers  to remove these outliers  we have extended the quantization model with a two
state switching observation model  i e   the discrete space consists of  k   ik    in this simple

  

ficemgil   kappen

 

   

   

   



   

 

   

   

   

   

 

 

 

 

 

 


  

  

  

  

figure    particle filtering on clave example with   particles  each circle denotes the mean
 k n     k n    where  k n    log  k   the diameter of each particle is proportional
to the normalized importance weight at each generation      denote the true
      pairs  here we have modulated the tempo deterministically according to
 k       sin  ck       observation noise variance is r           

  

fimonte carlo methods for tempo tracking and rhythm quantization

 

log likelihood

  

  
gibbs
sa
ii
gf
desired

  

  

figure   

 

  

  
  
gibbs sweep

  

  

typical runs of gibbs sampling  simulated annealing  sa  and iterative improvement
 ii  on clave example  all algorithms are initialized to the greedy filter solution  the
annealing schedule for sa was linear from         to         and than proceeding deterministically by            when sa or ii converge to a configuration  we reinitialize
by a particle filter with one particle that draws randomly proportional to the optimal
proposal  sharp drops in the likelihood correspond to reinitializations  we see that  at
the first sweep  the greedy filter solution can only be slightly improved by ii  consequently the sampler reinitializes  the likelihood of sa drops considerably  mainly due to
the high temperature  and consequently stabilizes at a suboptimal solution  the gibbs
sampler seems to explore the support of the posterior but is no able to visit the map
state in this run 

  

ficemgil   kappen

log likelihood difference

 

 

  

  

  
  slice
  slice
  

sa

gibbs

ii

gf

pf

 a  likelihood difference
  

  slice
  slice

edit distance

  
  
  
  
 
 
sa

gibbs

ii

gf

pf

 b  edit distance  mcmc results with    sweeps are omitted 

figure   

comparison of inference methods on the clave data  the squares and ovals denote the
median and the vertical bars correspond to the interval between     and     quantiles 
we have tested the mcmc methods  gibbs  sa and ii  independently for    and   
 shown from left to right   the smc methods are the greedy filter  gf  and particle filter
 pf   we have tested filters with n   f              g particles independently  shown
from left to right   

  

fimonte carlo methods for tempo tracking and rhythm quantization

sa 

sa 

median edit distance

  

  

pf  

pf  

pf   

  
gf 

ii  pf   

gf 

gi 

gi 
ii 

 

 

pf   

pf    

pf   
pf    

flops  log scale 

figure   

comparison of execution time in terms of oating point operations  for all methods  the
first number    or    denotes the number slices used by the optimal proposal distribution 
for the particle filter  pf   the second number denotes the number of particles  the
dashed lines are merely used to connect related methods 

outlier detection mechanism  each switch ik is a binary indicator variable specifying whether
the onset yk is an outlier or not  we assume that all indicators are independent a priori
and have a uniform prior  the observation model is given by p yk jik   k     n     rik      
since the score   k is known  the only unknown discrete quantities are the indicators i  k  
we have used greedy filtering followed by iterative improvement to find the map state
of indicators i  k and eliminated outliers in our further studies  for many performances 
there were around     outliers  less than    of all the notes  the resulting dataset can
be downloaded from the url http   www snn kun nl cemgil 
      parameter estimation

we have trained tempo tracking models with different dimensionality d  where d denotes
the dimension of the hidden variable z   in all of the models  we use a transition matrix that
has the form in eq    
since the true score is known  i e   the quantization location ck of each onset yk is given 
we can clamp all the discrete variables in the model  consequently  we can estimate the
observation noise variance r  the transition noise variance q and the transition matrix
coecients a from data 
we have optimized the parameters by expectation maximization  em  for the linear
dynamical systems  shumway   stoffer        ghahramani   hinton        using all perfor   we took rik            and rik        

  

ficemgil   kappen
mances of  yesterday  as training data  similarly  the score prior parameters are estimated
by frequency counts from the score of  yesterday      all tests are carried out on  michelle  
      results

in figure   we show the result of typesetting a performance with and without tempo
tracking  due to uctuations in tempo  the quality of the automatically generated score is
very poor  the quality can be significantly improved by using our model 
figure    shows some tempo tracking examples on michelle dataset for pianists from
different background and training  we observe that in most cases the results are satisfactory 
in figure     we give a summary of test results on michelle data in terms of the loglikelihood and edit distance as a function of model order and number of particles used for
inference  figure    a  shows that the median likelihood on test data is increasing with
model order  this suggests that a higher order filter is able to capture structure in pianists  expressive timing  moreover  as for the sythetic data  we see a somewhat monotonic
increase in the likelihood of solutions found when using more particles 
the edit distance between the original score and the estimates are given in figure    b  
since both pieces are arranged for piano  due to polyphony  there are many onsets that are
associated with the same quantization location  consequently  many ktrue in the original
score are effectively zero  in such cases  typically  the corresponding inter onset interval
yk yk   is also very small and the correct quantization  namely k      can be identified
even if the tempo estimate is completely wrong  as a consequence  the edit distance remains
small  to make the task slightly more challenging  we exclude the onsets with ktrue    
from edit distance calculation 
we observe that the extra prediction ability obtained using a higher order model does
not directly translate to a better transcription  the errors are around    for all models 
on the other hand  the variance of edit distance for higher order models is smaller  this
suggests that higher order models tend to be more robust against divergence from the
original tempo track 

   discussion
we have presented a switching state space model for joint rhythm quantization and tempo
tracking  the model describes the rhythmic structure of musical pieces by a prior distribution over quantization locations  in this representation  it is easy to construct a generic
prior that prefers simpler notations and to learn parameters from a data set  the prior on
quantization locations c  k translates to a non markovian distribution over a score   k  
timing deviations introduced by performers  tempo uctuation  accentuations and motor errors  are modeled as independent gaussian noise sources  performer specific timing
preferences are captured by the parameters of these distributions 
given the model  we have formulated rhythm quantization as a map state estimation
problem and tempo tracking as a filtering problem  we have introduced markov chain
   the maximum likelihood parameters for a model of dimension d     are found to be  a          r  
       and q            q           and q             the prior p c  is p            p               
p             p                remaining p c  are set to       

  

fimonte carlo methods for tempo tracking and rhythm quantization

michelle
lennon mccartney

bb   




  b b     n     n   ww         n   


w
  b b b   
w



w
b 


 

piano

   
  

   
   

 

bb   
  b b 
 
  bb
bb 


  
 n  


n 


bb
  b b  n   


  bb

bb 

  

 

 

  







n



n

 n  n      w n 
    j
  


n
 n n

  
 n  


n 





 

 n  n   
  

n

n

n

      

 
 

      
   

        



   


 

      
 


  
 
           

              




   
            

 
                        
 


  


           


















 
      
 
   
  


 
  



   

   
 
   


      
           

      
                     






    

 






   

  

 

  

  
 

bb
  b b    n 
  
  bb 
bb
  

n n 


bb 
  b b      

j
  bb
bb
n 

  

bb
  b b n w
w
  bb 
bb

 

j

             


 b       

   

 



j
  
   

  


   

n



 



 

 n



j
 ww
w

 

 

   

n




j
 


   







  

  

  

  
    
  
 

  

  



n ww
w

 n n

w



 a  original score






































 b  typesetting without
processing by the model 
due to uctuations in
tempo  the quality of the
score is poor 

figure   



  
         
  




     
  
       

   

 
  
    
        
  
 
 
   
   
q      

 

  

  

 

    
   
 
   







 

 
 



 











 



        



  
 

    









   
 
 
               
   

   


 
 
  

  
  
    
 

  
       
  






  


 

  
  




   

  



  

 c  typesetting after tempo
tracking and quantization
with a particle filter 

results of typesetting the scores 

  



  
  

 
  
  




         
       
 
      
 

           



ficemgil   kappen

 

 
estimated
original

estimated
original

   

   
 

log 

 

log 

k

   

k

   

   

   

   

   

 

 

  

  

  



  

  

  

 
  

  

 

  

  

  

k



  

  

  

  

  

k

 a  professional jazz pianist

 b  amateur

 

 
estimated
original

estimated
original

   

   

   
   

 

log 

 

log 

k

   

k

   

   

 

   
   

   

   
   

 
  

 

  

  

  



  

  

  

  

  

k

 

  

  

  



  

  

  

  

k

 c  professional classical pianist  the
filter temporarily loses track 

figure    

 

 d  tracking at twice the rate of the
original tempo 

examples of filtered estimates
of z  k    k   k  t from the beatles data set  circles
original
denote the mean of p zk j  k   y  k   and  x  denote mean p zk j   k   y  k   obtained by
smc  it is interesting to note different timing characteristics  for example the classical
pianist uses a lot more tempo uctuation than the professional jazz pianist  jazz pianist
slows down dramatically at the end of the piece  the amateur  rushes   i e   constantly
accelerates at the beginning  the tracking and quantization results for  a  and  b 
are satisfactory  in  a   the filter loses track at the last two notes  where the pianist
dramatically slows down  in  c   the filter loses track but catches up again  in  d   the
filter jumps to a metrical level that is twice as fast as the original performance  that
would translate to a duplication in note durations only 

  

fimonte carlo methods for tempo tracking and rhythm quantization

   

   

likelihood

   

   

   

   

   

   

 

 
model dimension

 

 a  likelihood  the dashed horizontal line shows the median
likelihood of the original score of michelle under each model 
  

  

  

percent edit distance

  

  

  

  

  

  

 

 

 

 
model dimension

 

 b  edit distance

figure    

smc results on the test data      performances of michelle   for each model we show
the results obtained with n             and    particles  the     show the median of
the best particle and  x  denote the median after applying iterative improvement  the
vertical bars correspond to the interval between     and     quantiles 
  

ficemgil   kappen
monte carlo  mcmc  and sequential monte carlo  smc  to approximate the respective
distributions 
the quantization model we propose is similar to that of  raphael      a   for transcription  raphael proposes to compute arg max p c  k   z  k jy  k   and uses a message propagation scheme that is essentially analogous to rao blackwellized particle filtering  to prevent
the number of kernels from explosion  he uses a deterministic selection method  called
 thinning   the advantage of raphael s approach is that the joint map trajectory can
be computed exactly  provided that the continuous hidden state z is one dimensional and
the model is in a parameter regime that keeps the number of propagated gaussian kernels
limited  e g   if r is small  thinning can not eliminate many kernels  one disadvantage is
that the number of kernels varies depending upon the features of the filtering distribution 
it is dicult to implement such a scheme in real time  perhaps more importantly  simple extensions such as increasing the dimensionality of z or introducing nonlinearities to
the transition model would render the approach quickly invalid  in contrast  monte carlo
methods provide a generic inference technique that allow great exibility in models one can
employ 
we have tested our method on a challenging artificial problem  clave example   smc
has outperformed mcmc in terms of the quality of solutions  as measured in terms of the
likelihood as well as the edit distance  we propose the use of smc for both problems  for
finding the map quantization  we propose to apply iterative improvement  ii  to the smc
solution on the reduced configuration space 
the correct choice of the score prior is important in the overall performance of the
system  most music pieces tend to have a certain rhythmical vocabulary  that is certain
rhythmical motives reoccur several times in a given piece  the rhythmic structure depends
mostly upon the musical genre and composer  it seems to be rather dicult to devise
a general prior model that would work well in a large spectrum of styles  nevertheless 
for a given genre  we expect a simple prior to capture enough structure sucient for good
transcription  for example  for the beatles dataset  we have estimated the prior by counting
from the original score of  yesterday   the statistics are fairly close to that of  michelle  
the good results on the test set can be partially accounted for the fact that both pieces
have a similar rhythmical structure 
conditioned on the score  the tempo tracking model is a linear dynamical system  we
have optimized several tempo models using em where we have varied the dimension of
tempo variables z   the test results suggest that increasing the dimensionality of z improves
the likelihood  however  increase in the likelihood of the whole dataset does not translate
directly to overall better quantization results  as measured by edit distance   we observe
that models trained on the whole training data fail consistently for some subjects  especially
professional classical pianists  perhaps interestingly  if we train  custom  models specifically
optimized for the same subjects  we can improve results significantly also on test cases 
this observation suggests a kind of multimodality in the parameter space where modes
correspond to different performer regimes  it seems that a kalman filter is able to capture
the structure in expressive timing deviations  however  when averaged over all subjects 
these details tend to be wiped out  as suggested by the quantization results that do not
vary significantly among models of different dimensions 

  

fimonte carlo methods for tempo tracking and rhythm quantization
a related problem with the edit distance measure is that under an  average  model  the
likelihood of the desired score  e g   original score of  michelle   may have a lower likelihood
than a solution found by an inference method  in such cases increasing the likelihood may
even decrease the edit distance  in some test cases we even observe solutions with a higher
likelihood than the original notation where all notes are wrong  in most of these cases  the
tempo trajectory of the solution correspond to the half or twice of the original tempo so
consequently all note durations are halved or doubled  e g   all whole notes are notated as
half notes  all half notes as quarters e t c    considering the fact that the model is  self
initializing  its tempo  that is we assume a broad uncertainty a priori  the results are still
satisfactory from a practical application perspective 
one potential shortcoming of our model is that it takes only timing information of onsets
into account  in reality  we believe that pitch and melodic grouping as well as articulation
 duration between note onsets and offsets  and dynamics  louder or softer  provide useful
additional information for tempo tracking as well as quantization  moreover  current model
assumes that all onsets are equally relevant for estimation  that is probably in general not
true  for example  a kick drum should provide more information about the tempo than a
ute  on the other hand  our simulations suggest that even from such a limited model one
can obtain quite satisfactory results  at least for simple piano music 
it is somewhat surprising  that smc  basically a method that samples from the filtering
distribution outperforms an mcmc method such as sa that is specifically designed for
finding the map solution given all observations  an intuitive explanation for relatively
poorer mcmc results is that mcmc proceeds first by proposing a global solution and then
tries to improve it by local adjustments  a human transcriber  on the other hand  would
listen to shorter segments of music and gradually write down the score  in that respect 
the sequential update schema of smc seems to be more natural for the rhythm transcription problem  similar results  where smc outperforms mcmc are already reported in the
literature  e g   in the so called  growth monte carlo  for generating self avoiding random
walks  liu  chen    logvinenko         it seems that for a large class of dynamical problems  including rhythm transcription  sequential updating is preferable over batch methods 
we note that theoretical convergence results for sa require the use of a logarithmic
cooling schedule  it seems that our cooling schedule was too fast to meet this requirement 
so one has to be still careful in interpreting the poor performance as a negative sa result 
we maintain that by using a richer neighborhood structure in the configuration space  e g  
by using a block proposal distribution  and a slower cooling schedule  sa results can be
improved significantly  moreover  mcmc methods can be also be modified to operate
sequentially  for example see  marthi  pasula  russell    peres        
another family of inference methods for switching state space models rely on deterministic approximate methods  this family includes variational approximations  ghahramani  
hinton        and expectation propagation  heskes         it remains an interesting open
question whether deterministic approximation methods provide an advantage in terms of
computation time and accuracy  in particular for the quantization problem and for other
switching state space models  a potential application of the deterministic approximation
techniques in a mcmc schema can be in designing proposal distributions that extend over
several time slices  such a schema would circumvent the burden for computing the optimal
proposal distribution exhaustively hence allowing more global moves for the sampler 

  

ficemgil   kappen
our current results suggest the superiority of smc for our problem  perhaps the most
important advantage of smc is that it is essentially an  anytime  algorithm  if we have
a faster computer we can increase the number of particles to make use of the additional
computational power  when computing time becomes short one can decrease the number
of samples  these features make smc very attractive for real time applications where one
can easily tune the quality computation time tradeoff 
motivated by the practical advantages of smc and our positive simulation results  we
have implemented a prototype of smc method in real time  our current computer system
 a     mhz p  laptop pc running ms windows  allows us to use up to   particles with
almost no delay even during busy passages  we expect to significantly improve the eciency
by translating the matlabc constructs to native c code  hence  the method can be used
as a tempo tracker in an automatic interactive performance system and as a quantizer in
an automatic score typesetting program 

acknowledgments
this research is supported by the technology foundation stw  applied science division
of nwo and the technology programme of the dutch ministry of economic affairs  we
would like to thank the associate editor daphne koller and the anonymous reviewers for
their comments that helped us significantly to improve the article  we would also like to
thank to ric ashley  peter desain  henkjan honing and paul trilsbeek for their suggestions
and contributions in data collection  moreover we gratefully acknowledge the pianists from
northwestern university and nijmegen university for their excellent performances 

appendix a  a generic prior model for quantization locations c
in traditional western music notation  note durations are generated by recursive subdivisions
starting from a whole note  hence it is also convenient to generate quantization locations
in a similar fashion by regular subdivisions  we decompose a quantization location into an
integer part and a fraction  c   bcc    c mod     for defining a prior  we will only use the
fraction 
the set of all fractions can be generated by recursively subdividing the unit interval
        we let s    si   denote a subdivision schema  where  si   is a  finite  sequence of
arbitrary integers  usually small primes such as     or     the choice of a particular s
depends mainly on the assumed time signature  we generate the set of fractions c as
follows  at first iteration  we divide the unit interval into s  intervals of equal length and
append the endpoints c  of resulting intervals into the set c   at each following iteration i 
we subdivide all intervals generated by the previous iteration into si equal parts and append
all resulting endpoints to c   note that thisqprocedure generates a regular grid where two
neighboring grid points have the distance    i si   we denote the iteration number at which
the endpoint c  is first inserted to c as the depth of c   with respect to s    this number will
be denoted as d c  js    it is easy to see that this definition of d coincides with the number
of significant bits to represent c mod   when s                  
as an illustirative example consider the subdivision s           at the first iteration  the
unit interval is divided into s      equal intervals  and the resulting endpoints         and

  

fimonte carlo methods for tempo tracking and rhythm quantization
    are inserted into c with depths d      d        d           at the second iteration 
the new endpoints          and     are inserted to c and are assigned the depth   
given an s   we can define a distribution on quantization locations

p ck js     exp  d ck mod  js   
if we wish to consider several time signatures  i e   different subdivision schemata  we can
interpret s as a hidden indicator variable and define
p a prior p s    in this case  the prior
becomes a multinomial mixture given by p ck     s p ck js  p s    for further details and
empirical results justifying such a choice see  cemgil et al         

appendix b  derivation of two pass kalman filtering equations
consider a gaussian potential with mean  and covariance  defined on some domain
indexed by x 
 
 
    
 x    z  n        z j j   exp   x  t     x   
 
r
where dx x    z      if z     the potential is normalized  the exponent in eq     is
a quadratic form so the potential can be written as
  t
x kx 
    
 x    exp g   ht x
 
where
 
k   t  
k   
h     
g   log z   log j j
h k h
 
   
to denote a potential in canonical form we will use the notation

 x    z  n        h  k  g 
and we will refer to g  h and k as canonical parameters  now we consider a gaussian
potential on  x    x   t   the canonical representation is

 x    x     



h 
h 

 
 

k   k  
k   k  

 
 g

in models where several variables are interacting  one can find desired quantities by applying
three basic operations defined on gaussian potentials  those are multiplication  conditioning  and marginalization  the multiplication of two gaussian potentials on the same index
set x follows directly from eq     and is given by
   x    a  x   b  x 
 h    k     g       ha   ka   ga     hb   kb   gb      ha   hb   ka   kb   ga   gb  
if the domain of a and b only overlaps on a subset  then potentials are extended to the
appropriate domain by appending zeros to the corresponding dimensions 

  

ficemgil   kappen
the marginalization operation is given by

 x     

z

k   k    h    k  

 x    x       h 

x 

k   k    k     g   

where g    g    log jk      j      h  t  k       h  and g is the initial constant term of  x    x    
the conditioning operation is given by
 x    x    x        h  k   x     k     g   

  x t k   x    
   

where g    g   ht  x  

b   the kalman filter recursions
suppose we are given the following linear model subject to noise
zk   azk     k
yk   czk   k
where a and c are constant matrices  k  n     q  and k  n     r 
the model encodes the joint distribution
k
y

p yk jzk  p zk jzk    
  
p z  jz      p z   

p z  k   y  k    

k

    
    

 
  t  
p z       p     p     log j p j
 p  
  
   t   

tr  
 
 
c
r
c
c
p y  jz     
 
  log j rj
 
r  c
r  
 
 
  t  
p y    y   jz           c t r   y     c t r   c  log j rj
y  r y    
 
   

   t  

tq  
 
 
a
q
a
a
p z  jz     
  log j qj
   
q  a
q  
 
   
b     forward message passing

suppose we wish to compute the likelihood

p y  k    

z

zk

p yk jzk        

z

z 

p z  jz   p y  jz   

z
z 

p z  jz   p y  jz   p z   

  we can compute this integral by starting from z  and proceeding to zk   we define forward
 messages  ff as
r
r
   we let z  dz

  

fimonte carlo methods for tempo tracking and rhythm quantization

 ff j    p z   
 k   k
  ffkjk   p yk   y k jzk  ffkjk  
r
  ffk  jk   zk p zk   jzk  ffkjk
the forward recursion is given by
 ff j     p     p       log j p j
 k       k

  t p    
 

  ffkjk    hkjk   kkjk   gkjk  
hkjk   c t r   y k   hkjk  
kkjk   c t r   c   kkjk  
gkjk   gkjk      log j rj    y  t r   y k
  ffk  jk    hk  jk   kk  jk   gk  jk  
mk    at q   a   kkjk    
hk  jk   q   amk hkjk
kk  jk   q   q   amk at q  
gk  jk   gkjk    log j qj      log j mk j      htkjk mk hkjk
b     backward message passing

we can compute the likelihood also by starting from yk  

p y  k    

z

z 

p z   p y  jz   

z

z 

p z  jz   p y  jz         

z
zk

in this case the backward propagation can be summarized as

 fik jk       
 k   k     
  fikjk   p yk   y k jzk  fikjk  
r
  fik  jk   zk p zk jzk    fikjk
the recursion is given by

  hk jk     kk jk     gk jk                
 k   k     
  fikjk    hkjk   kkjk   gkjk  
hkjk   c t r   y k   hkjk  
kkjk   c t r   c   kkjk  

  

p zk jzk    p yk jzk  

ficemgil   kappen
gkjk      log j rj    y kt r   y k   gkjk  
  fik  jk    hk  jk   kk  jk   gk  jk  
mk    q     kkjk    
hk  jk   at q   mk hkjk
kk  jk   at q    q mk  q   a
gk  jk   gkjk    log j qj      log j mk j      h tkjk mk hkjk
b   kalman smoothing
suppose we wish to find the distribution of a particular zk given all the observations y  k  
we just have to combine forward and backward messages as
p zk jy  k  

  p yk   k   zk   y  k  

  p y  k   zk  p yk   k jzk  
  ffkjk  fikjk  
   hkjk   hkjk     kkjk   kkjk    gkjk   gkjk   

appendix c  rao blackwellized smc for the switching state space
model
we let i           n be an index over particles and s           s an index over states of    we
denote the  unnormalized  filtering distribution at time k   by
 ki       p y  k    zk   j   ik     
since y  k   are observed   ki    is a gaussian potential on zk   with parameters zk i    
n
  i     i     note that the normalization constant zk i    is the data likelihood p y  k  j   ik       
r k   i  k  
dzk k     similarly  we denote the filtered distribution at the next slice conditioned on
k   s by

 ksji   
 

z

dzk   p yk jzk  p zk jzk     k   s  ki   
    
  p y  k   zk j   ik      k   s 
we denote the normalization constant of  ksji  by zk sji   hence the joint proposal on s and
 i  is given by
qk sji   

z

dzk  ksji   p k   s     ik     
  p k   s     ik      y  k  

the outline of the algorithm is given below 
 initialize  for i           n     i  p y   x  

  

fimonte carlo methods for tempo tracking and rhythm quantization

 for k           k
  for i           n   s           s
compute  ksji  from  ki    using eq    
qk sji  zk sji   p k   s     ik     
  for i           n
select a tuple  sjj    qk
   ik      jk      k   s 
 ki   ksjj  
p  sjj 
wk i 
s qk
note that the procedure has a  built in  resampling schema for eliminating particles
with small importance weight  sampling jointly on  sji  is equivalent to sampling a single
s for each i and then resampling i according to the weights wk i    one can also check that 
since we are using the optimal proposal distribution of eq     the weight at each step is
given by wk i    p    ik      y  k   

references

aarts  e  h  l     van laarhoven  p  j  m          statistical cooling  a general approach to
combinatorial optimization problems  philips journal of research                  
agon  c   assayag  g   fineberg  j     rueda  c          kant  a critique of pure quantification 
in proceedings of the international computer music conference  pp        aarhus  denmark 
international computer music association 
andrieu  c   de freitas  n   doucet  a     jordan  m  i          an introduction to mcmc for
machine learning  machine learning  to appear 
bar shalom  y     fortmann  t  e          tracking and data association  academic press 
bar shalom  y     li  x  r          estimation and tracking  principles  techniques and software 
artech house  boston 
cambouropoulos  e          from midi to traditional musical notation  in proceedings of the aaai
workshop on artificial intelligence and music  towards formal models for composition  performance and analysis  austin  texas 
carter  c  k     kohn  r          markov chain monte carlo in conditionally gaussian state space
models  biometrika                  
casella  g     robert  c  p          rao blackwellisation of sampling schemas  biometrika     
      
cemgil  a  t   desain  p     kappen  h  j          rhythm quantization for transcription  computer
music journal              
cemgil  a  t     kappen  h  j          rhythm quantization and tempo tracking by sequential
monte carlo  in dietterich  t  g   becker  s     ghahramani  z   eds    advances in neural
information processing systems     mit press 
cemgil  a  t   kappen  h  j   desain  p     honing  h          on tempo tracking  tempogram
representation and kalman filtering  journal of new music research                
chen  r     liu  j  s          mixture kalman filters  j  r  statist  soc      
  

ficemgil   kappen
dannenberg  r          an on line algorithm for real time accompaniment  in proceedings of icmc 
pp           san francisco 
desain  p     honing  h          quantization of musical time  a connectionist approach  in todd 
p  m     loy  d  g   eds    music and connectionism   pp           mit press   cambridge 
mass 
desain  p     honing  h          a brief introduction to beat induction  in proceedings of icmc 
san francisco 
dixon  s     cambouropoulos  e          beat tracking with musical knowledge  in horn  w   ed   
proceedings of ecai         th european conference on artificial intelligence   amsterdam 
doucet  a     andrieu  c          iterative algorithms for state estimation of jump markov linear
systems  ieee trans  on signal processing                    
doucet  a   de freitas  n     gordon  n  j   eds            sequential monte carlo methods in
practice  springer verlag  new york 
doucet  a   de freitas  n   murphy  k     russell  s       a   rao blackwellised particle filtering
for dynamic bayesian networks  in uncertainty in artificial intelligence 
doucet  a   godsill  s     andrieu  c       b   on sequential monte carlo sampling methods for
bayesian filtering  statistics and computing                  
fox  d   burgard  w     thrun  s          markov localization for mobile robots in dynamic
environments  journal of artificial intelligence research  jair      
ghahramani  z     hinton  g          variational learning for switching state space models  neural
computation                  
ghahramani  z     hinton  g  e          parameter estimation for linear dynamical systems   crgtr        tech  rep   university of totronto  dept  of computer science 
godsill  s   doucet  a     west  m          maximum a posteriori sequence estimation using monte
carlo particle filters  annals of the institute of statistical mathematics                
gordon  n  j   salmond  d  j     smith  a  f  m          novel approach to nonlinear nongaussian bayesian state estimation  in iee proceedings part f  radar and signal processing 
vol          pp          
goto  m     muraoka  y          music understanding at the beat level  real time beat tracking
for audio signals  in rosenthal  d  f     okuno  h  g   eds    computational auditory scene
analysis 
grubb  l          a probabilistic method for tracking a vocalist  ph d  thesis  school of computer
science  carnegie mellon university  pittsburgh  pa 
hamanaka  m   goto  m   asoh  h     otsu  n          a learning based quantization  estimation of
onset times in a musical score  in proceedings of the  th world multi conference on systemics 
cybernetics and informatics  sci        vol  x  pp          
heijink  h   desain  p     honing  h          make me a match  an evaluation of different approaches
to score performance matching  computer music journal               
heskes  t  zoeter  o          expectation propagation for approximate inference in dynamic
bayesian networks  in proceedings uai 
isard  m     blake  a          contour tracking by stochastic propagation of conditional density 
in eccv      pp          
large  e  w     jones  m  r          the dynamics of attending  how we track time varying events 
psychological review               
liu  j  s   chen  r     logvinenko  t          a theoretical framework for sequential importance
sampling with resaampling  in doucet  a   de freitas  n     gordon  n  j   eds    sequential
monte carlo methods in practice  pp           springer verlag 
  

fimonte carlo methods for tempo tracking and rhythm quantization
longuet higgins  h  c          mental processes  studies in cognitive science  mit press  cambridge     p 
marthi  b   pasula  h   russell  s     peres  y          decayed mcmc filtering  in proceedings of
uai 
metropolis  n   rosenbluth  a   rosenbluth  m   teller  a     teller  e          equations of state
calculations by fast computing machines  journal of chemical physics                
metropolis  n     ulam  s          the monte carlo method  journal of the american statistical
assoc                    
murphy  k  p          dynamic bayesian networks  representation  inference and learning  ph d 
thesis  university of california  berkeley 
pressing  j     lawrence  p          transcribe  a comprehensive autotranscription program   in
proceedings of the international computer music conference  pp           tokyo  computer
music association 
rabiner  l  r          a tutorial in hidden markov models and selected applications in speech
recognation  proc  of the ieee                  
raphael  c       a   a mixed graphical model for rhythmic parsing  in proc  of   th conf  on
uncertainty in artif  int  morgan kaufmann 
raphael  c       b   a probabilistic expert system for automatic musical accompaniment  journal
of computational and graphical statistics                  
roberts  g  o     rosenthal  j  s          markov chain monte carlo  some practical implications
of theoretical results  canadian journal of statistics           
scheirer  e  d          tempo and beat analysis of acoustic musical signals  journal of acoustical
society of america                 
shumway  r  h     stoffer  d  s          an approach to time series smoothing and forecasting
using the em algorithm  j  time series analysis                 
tanizaki  h          nonlinear and non gaussian state space modeling with monte carlo techniques 
a survey and comparative study  in rao  c     shanbhag  d   eds    handbook of statistics 
vol     stochastic processes  modeling and simulation  north holland 
thom  b          unsupervised learning and interactive jazz blues improvisation  in proceedings of
the aaai      aaai press 
toiviainen  p          an interactive midi accompanist  computer music journal              
vercoe  b     puckette  m          the synthetic rehearsal  training the synthetic performer  in
proceedings of icmc  pp           san francisco  international computer music association 
vercoe  b  l   gardner  w  g     scheirer  e  d          structured audio  creation  transmission 
and rendering of parametric sound representations  proc  ieee                

  

fi