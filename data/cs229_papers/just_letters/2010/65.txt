unsupervised multi factor risk models for us equities
cs    final project
kyle kelley
december         

abstract
this project compares equity risk models developed using the conventional supervised approach as
well as a pca based unsupervised approach  a fair out of sample comparison shows that pca
based models  which are readily developed without economic expertise  can meet and sometimes
exceed the performance of industry standard   and   factor supervised models 

motivation
many successful financial traders will argue that risk management is the most important long run
aspect of trading  as it s primary goal is to avoid catastrophic losses  note that there is no
universally agreed upon measure of a portfolio s risk  but some commonly used examples are
variance  value at risk  var   and worst case loss  this project only addresses variance based
models  to be useful  and successful   these risk models must somehow accurately predict future
variances  which  as we will see  is very difficult 
if a portfolio contains n stocks  then the covariance matrix among the stock returns mathematically
describes the variance of portfolio returns through the formula
  p x t  x   where
 nn is the covariance matrix among the stocks
n
x  is the vector of stock holding weights in the portfolio
hence  we need to have reliable predictions of the covariance matrix to accurately assess portfolio
risk  a reasonable approach is to assume the historical covariance equals the future covariance 
 n n
implying that we would need to accurately estimate
different parameters  which is
 
extremely difficult  both from standpoints of computation and accuracy  to do in practice 
arbitrage pricing theory  apt    postulates that the returns of each stock are driven by a linear
combination of a small set of k underlying factors 
r s  r f    where
n k
is a matrix of factor exposures for each stock

k
r f  is a vector of factor returns
n
 is a vector of idiosyncratic returns  uncorrelated to the other factors 
assuming apt holds  then we can compute the covariance as
   f t    where
kk
is a covariance matrix among the factor returns
 f 
n n
is the covariance matrix among the idiosyncratic returns

if we assume that the idiosyncratic returns are uncorrelated  the idiosyncratic covariance becomes
k  k
n parameters  which is
diagonal  which means we now only need to estimate nk 
 
  for more info see active portfolio management by grinold   kahn

fimuch more feasible when k n  
the problem with the apt approach is that it doesn t specify what the factors are  and they must
somehow be determined either empirically or through theory  in practice  teams of highly trained
economic analysts work on determining the factors they think drive equity returns  and then
determine exposure forecasts that each stock has to these factors  some examples of such factor
models are the   factor market model  the   factor fama french model  and the    factor model
sold by msci barra  all of these industry standard supervised approaches are very timeconsuming to build  and or expensive to buy   which leads us to wonder how effective an
unsupervised approach can be in a side by side comparison 
furthermore  the general difficultly of estimating covariance with a factor based apt approach 
coupled with the difficulty in dealing with an n x n matrix in portfolio optimization  often leads
portfolio managers to ignore covariance altogether and instead focus on variances  e g   using a
diagonal covariance matrix   this approach is briefly addressed in the results 
figure   shows the magnitudes of the principal components for the daily returns of the s p    for
      providing some motivation for a pca based approach  note that the first principal
component explains nearly   times the variance as the second principal component  suggesting why
historically   factor  market  risk models have been used effectively 

figure    magnitudes of principal
components for daily s p    returns       

one obvious problem with pca is that the factors produced don t necessarily have any physical
meaning  and hence we have less confidence they will continue to have any relevance in the future 
this experiment indirectly measures this 

methodology

general
the goal of this project is to use the historical returns of n stocks measured at time intervals of
length d to predict the covariances of these stocks in future time periods  we define the return of a
ptclose
stock at time t to be r t log close    where p close
is the closing price at time t 
t
p td

fiwe indicate the time a model is constructed as t model   we then form r train  nm with the
returns of n stocks in mtrain prior consecutive time periods  i e   at times
t model mtrain d   t model  mtrain   d        t model d   to predict the covariance matrix of returns over
mtest consecutive future time periods test  nxn  i e   using times
t model  t model d         t model mtrain d   
train

weights
as an additional tuning knob  we use a decaying exponential to weight our historical observations 
giving more weight to more recent observations  the weight for a return at time t is
w t   



t modelt
d m hl

where mhl is the tunable half life parameter 

idiosyncratic variance
as mentioned we will assume that idiosyncratic variances are uncorrelated  hence  we can account
for it simply by ensuring that the diagonals of our final covariance matrix equal the predicted
variance of each stock    s    diag  test    where   s  n is the vector of idiosyncratic
stock variances      n is the vector of overall stock variances 
there are a number of sophisticated autoregressive techniques to forecast variance  but these are
beyond the scope of this project  instead  we use historical exponentially weighted variance as a
predictor of future variance  note that any improvements to this algorithm will improve the results
of all methods equally 
error metric
to evaluate models  we compare the observed covariance matrix over mtest time periods  actual
  to the trained covariance matrix for the same time periods  test   our error metric is the
frobenius norm of the difference  e test   actual  testf  
tuning
the set of tunable parameters are optimized by iterating the following cross validation procedure on
each parameter until all the parameters have reasonably converged  in practice  this never took
more than   iterations 
cross validation
we use a rolling cross validation in favor of a typical k fold cross validation to avoid any future
bias in our models  which is crucial to avoid with financial data   given a full dataset of returns
over mtotal time periods  we can create mmodels  mtotal mtest mtrain different models with this
data  and estimate the generalization error as the mean of the test errors 
m
 
e gene test  
 ei  
mmodels i   test
by performing this procedure over a sweep of parameter values  we select the optimal parameter as
the one that results in the lowest measured e test  
models

unsupervised  pca 
using pca  we estimate the covariance matrix as test  u diag tu diag   s    where
u  nxk are the k first principal components of the centered scaled returns data r train   and

fik are the k corresponding eigenvalues  note that this method introduces k as another
tunable parameter  if the principal components estimated from historical data remain accurate in the
future  then this method will yield good results  the exponential weighting is used only for
estimating stock specific variances  as already mentioned  

supervised
the supervised approach uses the same returns matrix r train as well as a returns matrix for k
k m
factors over the same time intervals  r f 
  we then use a weighted linear regression  same
 nxk
exponential weights as before  to estimate 
so that r train f   additionally  we
compute the weighted covariance among the factors to estimate  f   the stock covariance matrix
can then be estimated as test    f t diag   s   
train

results
the described methodology was used on data for stocks in the s p     all parameters were tuned
using data from            and then the tuned models were further tested on data from january   
     to november           table   describes the different models being compared 
table    description of models tested
model description
ivar assumes ideal variance forecasts and   covariance between stocks 
spy

  factor supervised model  market 

ff

  factor fama french supervised model  market  size  value 

pca

unsupervised pca model

this methodology was used to build models on   different time horizons  one using daily data to
predict covariance over    intervals    month   and one using    minute bar data to predict
covariance over    intervals    days   the final tuning results and mean errors are reported in
tables   and    the time series of test errors between pca and ff for the    day test are shown in
figure   
table    results for d   day  mtest       month   mtrain          year 
model mhl k
e test           e test     
ivar na na       

      

spy

  

 

      

      

ff

  

 

      

      

pca

 

 

      

      

the most important tuning parameter to determine in all cases was mhl  an example sweep is
shown in figure    note the minimum occurs at mhl   
the results from tuning k  in pca models  and tuning mtest  in all models  were less exciting but
still interesting because they provide good guidelines when working with risk models  in all cases
pca models with k   were optimal  also  once mhl had been tuned  models with larger mtrain had
lower test error  suggesting the best method in practice is to use the largest possible window of
historical data when building risk models 

fitable    results for d    minutes  mtest       days   mtrain           months 
model mhl k

e test          

e test     

ivar

na na       

      

spy

  

      

      

na  

na

na

  

      

      

ff

 

pca

 
 

figure    time series comparison of pca and ff test errors

figure    tuning m hl for pca
  this test wasn t performed due to a lack of intraday data for the ff factors

ficonclusions
there are a number of interesting takeaways from these experiments  primarily  it was
demonstrated that  when tuned properly  unsupervised pca based risk modeling can meet and
sometimes outperform a   factor spy model and a   factor fama french model  tested over both a
  month horizon and a   day horizon   it would be interesting to compare these results to the   
factor barra model in same framework 
another interesting result is that pca always had the smallest error with only   factor  in literature
 and in some commercial models   there are often       factors retained from pca  but these outof sample tests demonstrated this is suboptimal on average  at least for the horizons tested here  
moreover  comparing the tests against the performance of ivar demonstrates that covariance
modeling is not a futile effort  in practice it is possible to improve substantially upon a perfect
variance only model 
on a final note  the prudent reader should recognize that historical based risk models clearly have
their limitations  as they don t generally predict situations that have never occurred  this is most
apparent in the plot of test errors above during the period of fall       see figure     when all
models performed far worse than their historical average  this project merely showed that pca
rivaled the alternatives  spy ff   not that it always did well on an absolute basis 

  one such example is northfield short term equity risk model  which keeps    pca factors
http   www northinfo com documents   pdf

fi