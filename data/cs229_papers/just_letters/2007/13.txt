image processing for bubble detection in microfluidics
chen fang
mechanical engineering department
stanford university

introduction
starting from recently years  microfluidics devices have been widely used to build the biomedical devices and
micro fuel cells  in the research on microfludics  high speed camera is widely used to record the motion of liquid
bubbles in the microchannel  based on which the dynamics of bubbles can be interpreted  however  the mechanical
vibration of the system causes the channel to deviate from its original position during the image acquisition process 
figure   a  shows a typical image of a silicon microchannel with sidewall water injection  in which the injected water
bubble and the skewness of the channel are evident  hence  it is necessary to perform the skewness and translation
correction on the raw images acquired by the high speed camera before the correct information of the bubble trajectory
can be obtained from the images 

also  to extract the motion information from a huge number of images  we need to

isolate the front bubble object from the background image  which will facilitate the automatic calculation of bubble
velocity 
the spatial deviation of the image can be decomposed into angular and translational components  in the current
project  we will first develop an algorithm to efficiently calculate the angular deviation of the image based on solving a
minimization problem using least square svm  also  the translation correction of image can be accomplished in a
straightforward way  after the realignment of the image is finished  the moving bubble can be separated from the
background image by using gaussian mixture model and em algorithm to classify each pixel in the image as either the
foreground or background  the test result shows that the present skewness correction algorithm works very well for the
tilt angle less than    degree  also  the background separation algorithm can successfully distinguish the moving object
from the background image with still droplets in it for various illumination conditions  the major advantage of the
current approach is that no iteration is required and computation is very cheap 

skewness correction
to correct for the angular deviation  we first convert the original gray scale image  fig   a    a   into binary
image fig   b    b    suppose the image tilt angle should be corrected by    then the white pixel at   x  y   is moved
to   x    y      where we have 

 x       x 
            where
 y     y 

   cos   sin  
    sin  cos  
  


   

since the biggest feature in the binary images is a pair of straight black lines representing the channel border  to
implement the skewness correction  we only need to calculate the    such that the projection of the black pixels onto
the y axis after the correction assumes the minimal value  i e  
n



min    yi   y      
i   

n

or

min      xi   yi  t     x  y  t   

   

i   

here  we construct a training data set   x i   yi   corresponding to all the black pixels in the image  such that x i  r  
indicates the x  y coordinates of the pixel  and yi  r can be set as a constant  if we use f   x      x   b         to
regress   x i   yi     then the regression error is  

fi   f  x   y    x   b y

   

it is interesting to recognize that the skewness correction objective     can be expressed as 
n

min      xi   yi  t     x  y  t    
i   
n

  min    i  b  yi    b  y    

   

i   
n

  min    i    
i   

in deriving      we recognized that yi  r is set as a constant in our application 
by comparing     and      we find that to determine    it is equivalent to regress the training set   x i   yi   using the
linear equation f   x      x   b          
here  we use the least square svm to implement the regression  in particular  we consider the minimization problem 

 
  n
min  t     ei 
 
  i   
s t  yi   x i  b  ei    

   

by constructing the lagrangian function  taking derivative with respect to

   b  e and lagrangian multiplier a  we

have 

 

 n

 b   
     
   i n    y 
 tn

   

 

with y     y   k   y n  t    n      k    t  

       k    n  t   i n is an n  n identity matrix  and the kernel matrix

  r n  n with ij   xit x j   since the intercept b does not influence the

       can be simplified as 

a      ia
then non zero vector

   

a correspond to the first eigenvector of   r n  n  
n

finally  the correction angular displacement     ai x it
i   

after finishing the skewness correction  the next step is moving the image in x and y direction to finally finish the
image alignment  in the present case  such alignment can be achieved based on the position of the water injection point 
we will not talk about this part in detail 

moving bubble detection
to estimate the bubble trajectory in an automatic manner  we need moving bubble detection algorithm to separate the
moving bubble from the channel and other still objects in the background for each frame in the video sequence  the
easiest way to detect moving object in an image includes obtaining the background image first  and then subtract the
background image from the original image  leaving the foreground moving objects  however  this technique is not
applicable to the present study  since the background image varies with the fluctuation of the illumination condition and
the existence of some other still droplets during the image capture process  making it very difficult to find a general
background image applicable to all frames in the video 

here  we consider a single pixel and the distribution of its

values over time  at a specific moment  a particular pixel may be either in the background state or in the foreground

fistate  thus  the intensity value ix   y of a pixel  x  y  can be treated as the weighted sum of two gaussian

distributions 

i x   y   background   x   y g background   x   y       background   x   y   g foreground   x   y

   

where  
g background   x   y

n    background   x   y    background   x   y  

g foreground   x   y

n    foreground   x   y    foreground   x   y  

the model for pixel  x y  is parameterized by the parameter

 x  y    l   x   y   l   x   y   l   x   y   l    foreground   background   

   

let i be the pixel intensity  l be a random variable indicating the label of the pixel in the image  our model defines the
probability distribution 

l   x   y

p   l   l   i   x  y   t     i       

n
 

       l   x   y  

 
 

 
exp   i  l   x   y  t l  x   y  i  l   x   y   
 

    

knowing the parameter  of the above probability distribution of each pixel  we can classify each pixel as either
background or foreground based on the highest posteriori probability p  l   l   i   x  y  t     
here  our objective is to find parameters    arg max tt   p   l   lt   i   x  y   t          by taking derivative  it can be found


that 
n l x  y

l  x  y  

t
m l x  y

l x  y  



l  x  y

n l x  y
 

z l  x  y

  lt  x   y  l   x   y

n l  x  y

w here
t

n l  x  y  

    l

x   y  t

  l 

t   
t

m l  x  y  

     l

x   y  t

  l  i   x   y   t   

t   
t

     l
z l  x  y  

x   y  t

  l  i   x   y   t   i   x   y   t   t  

t   

t

since we do not have the labels

lx   y  t for the training data  the above equations can not be calculated directly  instead 

we calculate a sequence of parameter settings  in which each setting is found by using the previous one to classify the
data  in particular  suppose at the current step we have some distribution parameterized by  l   x   y   we can use the expect
values of different labels according to

l   x  y

as an estimate of their true value  taking n l   x   y as an example  we have 

t

n l   x   y   e  n l   x   y   l   x   y      p   lt   l   i   x  y  t    l   x   y  

    

t   

to classify each new frame  this approach requires calculating the summation over all the previous frames  which is
quite expensive  as an alternative way  whenever we classify a new frame  we add its contribution to the current

fistatistics  which means that we are increasing our training set at each step  without reprocessing the previous frames in
the training set  hence  we have following algorithm 
initialize

l   x  y

for each pixel in the first image in the video 

for each new frame  
for each pixel in the new frame  
   update the parameter

l   x  y

for mixture model 

n l   x   y           n l   x   y    p   lt   l   i   x  y  t   l   x   y  
m l   x   y        a  m l   x   y    p   lt   l   i   x  y  t    l   x   y   i   x  y  t  
z l   x   y        a  z l   x   y    p  lt   l   i   x  y  t    l   x   y   i   x  y  t   i   x  y  t  t

    

l   x   y   f   n l   x   y   m l   x   y   zl   x   y  
   classify the pixel as background or foreground  based on the current mixture model
 
 
since the illumination condition may change over the time  each frames contribution to the background image need to
be weighted according how far it is away from the current frame  therefore  we introduce the relaxation factor
     





in

lies between   and    the influence of the previous image on the current image decays exponentially with the

distance  in the present study  we choose

      

result
figure  through figure   shows the image processing result for four frames using the present algorithm for skew
correction and moving bubble extraction  it is shown that the skewness correction method works very well for the
images in various angles  in particular  the algorithm is not susceptible to the noise  scattered black pixels  in the binary
image converted from the source image  also  the moving bubble is successfully separated from the background
channel  in particular  the algorithm correctly classifies the still bubble in the channel as background and excludes it
from the resulted moving bubble image  by recognizing that such still object may exist at any place in the channel and
may not be correctly removed by directly subtracting a predetermined background image from the source image  the
advantage of our method is evident 

summary
in the present study  we correct a sequence of skew images by solving a minimization problem based on ls svm  the
moving bubble object is extracted by classifying each pixel in the image using gaussian mixture model  the result is
quite satisfactory for the present application  the major advantage of the current methods is that no iteration is involved
in both steps  in particular  the correction angle can be directly obtained by calculating the eigenvector of the resulted
matrix  and the classification model for the pixels in the current frame can be updated by adding the contribution of the
present image to the parameters of the previous image  therefore  the computation is very cheap and an implementation
in real time is possible 

fiy
x
water injection point

still bubble
moving bubble

fig  

image processing result for frame     a  original image   b  binary image   c  corrected image   d  extracted moving bubble 

note our algorithm can successfully remove the still bubble from the extracted image 

fig  

image processing result for frame  

fig  

image processing result for frame  

fi