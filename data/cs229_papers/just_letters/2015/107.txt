market response to liquidity shocks in the limit order book
kartikey asthana 
roberto a  colon quinones 
joshua romero
stanford university  cs    machine learning  autumn     

abstract

such a model can improve existing back testing platforms for
trading strategies by including a feedback from the market 
the goal of this project is to develop an accurate model for
predicting the short term response of the market to liquidity
shocks in the order book  in particular  we are interested
in forecasting values of the best bid and best ask prices for
fifty time steps following an order that triggers a liquidity
shock  the input to our algorithm consists of information on
fifty pre shock transactions  the shock causing transaction 
as well as macroscopic indicators regarding each security 
we then use variants of linear regression  lr  and support
vector regression  svr  to predict increments in mid price
and bid ask spread for the fifty time steps after the shock 

this report provides empirical evidence that the bid ask
spread and mid price exhibit strong mean reversion following a liquidity shock in the limit order book  the mean
behavior of buy sell initiated shocks is to increase decrease
the macroscopic mid price of the security  linear as well
as non linear models are trained to incorporate pre shock
information for predicting post shock behavior  however 
the features tend to add very little predictive power beyond the statistical mean behavior  we show that this is
largely on account of high volatility associated with high
priced securities  defining a measure of error which is normalized by volatility indicates that features do have some
intrinsic predictive capability  in this new measure  linear
related work
regression  weighted to account for heteroskedasticity  out   
performs svr yielding an efficient prediction algorithm for
numerous stochastic models have been proposed for the
high frequency data 
state of a limit order book  these include static models    
where the traders choice to place limit or market orders is
made exogenously  as well as dynamic models     that make
  introduction
such a choice internally by factoring waiting costs  it has
been shown     that liquidity shocks temporarily increase
exchange traded financial instruments often incorporate a
the bid ask spread which reverts to a competitive level as
transparent buyer seller matching system known as a cennew orders arrive  we empirically verify this observation in
tral limit order book  for each security  this book maintains
section      dynamics of market resiliency have also been
a real time record of bid ask prices and volumes that market
studied in     where the authors show that the two prinparticipants are willing to trade at  the difference between
cipal factors governing the rate of mean reversion are the
the highest bid and lowest ask price is referred to as the
proportion of patient traders and rate of order arrival 
bid ask spread and is typically narrow for actively traded
it is important to note that a liquidity shock in the limit
securities  this spread is a quantitative measure of the seorder
book is a high frequency phenomenon wherein the
curitys liquidity since a narrow spread implies a smaller
change
in spread is on the order of a few ticks  it must be
premium to be paid for buying selling and vice versa 
contrasted with macroscopic shocks during financial crises
a trade is executed when a buyer seller is willing to cross
wherein the bid ask spread widens catastrophically impedthe bid ask spread  if the buyer seller places a large enough
ing traders from closing positions  extensive investigations
order that consumes all available volume at the best price 
have been conducted into the dynamics of macroscopic liqthen the bid ask spread changes  leading to a liquidity shock 
uidity across equity and bond markets      premia associated
such a shock is followed by a period during which particwith shocks in equilibrium markets      impact of macroipants replenish the order book with new bid ask orders 
scopic shocks on hft participants      shocks due to federal
such limit orders that update the best bid ask price are
monetary policies     etc 
referred to as quote events 
the rate of recovery or mean reversion of the spread and
linear
k nearest svr random k means
mid price is indicative of the markets resiliency and is of
regress  neighbors
forest
great importance to traders  exchanges and regulators  an
     
     
     
     
     
efficient and accurate model for market resiliency can directly benefit traders  allowing them to reduce market im  table    relative performance  rmse  of algorithms utipact costs by splitting large orders across time  moreover  lized by a top ranking kaggle com competition participant 
 phd

candidate  kasthana stanford edu
candidate  racolon stanford edu
 phd candidate  jdromero stanford edu

this problem was part of a competition sponsored by the
capital markets cooperative research centre  hosted on 

 phd

 

filine at kaggle com      the competition ended in january that the expected mid and spread are given by
     and a discussion ensued wherein participants shared
e mt      mt   m  em  tt      m  
performance of their algorithms on an undisclosed test set 
table   shows the root mean squared error obtained from
e st      st   s  es  tt      s  
six different algorithms  the proximity of results indicates
   
that there is negligible predictive ability in the features  in
this report  we show how this observation can be verified  where t       is the time of incidence of the shock  the
explained and then circumvented 
exponential damping in time is a strong indicator of meanreversion and can be verified using the empirical estimators

 

m

data and benchmark

e mt  mt     

m

trade and quote  taq  data for         examples of liquidity shocks across several securities and trading times were
obtained directly from the competition website  each example includes information on    transactions leading to the
shock and an equal number after the shock  all prices are
measured in units of pence  for pre shock transactions  the
data provides  i  nature  trade quote    ii  time   iii  best
bid price  and  iv  best ask price for each transaction  regarding the shock itself  we are provided  i  volume weighted
average price   ii  volume  and  iii  nature  buy sell initiated  of the trade causing the liquidity shock  additionally  we are also provided  i  the number of previous day
on market trades  and  ii  sum of previous day on market
trade values  for post shock transactions  only data on bid
and ask prices is available 
of the total data         examples were randomly chosen
to form the training set         were held out for optimizing
parameters in svr and the remaining        were designated as the test set 

   

  x
 mt  i   mt   i    
m i  

e st  st     

  x  i 
 st  st   i    
m i  

   

as a function of time  where m denotes the number of examples  the post shock values of these quantities for the
training set are plotted in fig     a distinction is made
between buy initiated and sell initiated shocks as they influence the mid price in opposite directions  we see that
both the mid price and bid ask spread exhibit strong mean
reversion  in the case of a buy initiated shock  the mean
level is higher than than the value prior to the shock  i e 
the shock increases the long term or macro level price of
the security  the corresponding decrease happens for a sellinitiated stock  this phenomenon captures the basic process
by which securities change in value over time  the mean
level for the spread is slightly higher than the pre shock
level  this highlights the impact of the shock in reducing
liquidity of the security 

mean reversion of mid and spread

   
   

e mt mt     e st st   

prior to exploring learning algorithms  we begin with a statistical characterization of the provided high frequency data
to verify the observations in      denoting bt   at as the
best bid and ask prices for a given time t  the mid price and
bid ask spread are respectively defined as

   
   
midprice  buyinit
midprice  sellinit
spread

   
 

   

at   b t
 
mt  
 

st   at  bt  

   

   
   

for liquid securities  both the mid price and spread are often assumed to be mean reverting over short time horizons 
i e  they have a tendency to return to some non observable
mean levels  the time series for both quantities can then be
represented by ornstein uhlenbeck  ou  processes      
dmt   m  m  mt  dt   m dbtm  
dst   s  s  st  dt   s dbts  

   
   

 

 

 

 

  

  

  

t t 

figure    mean reversion of mid price and bid ask spread

   

   

benchmark

we use the statistical estimators in eqn      as our benchwhere btm   bts are standard brownian motions  m   s
mark algorithm 
are the respective volatilities  m   s are the mean levels 
and the critical quantities m   s are the rates of mean
mt   mt    e mt  mt     st   st    e st  st    
reversion  the two processes are correlated cov btm   bts    
bt   mt  st     at   mt   st    
   
t  owing to linearity in the diffusion term  one can show
 

fiwhere bt   at are the predicted values  this corresponds to     coefficient of determination
a linear mean model consisting of only the intercept term
and no features  as dictated by the competition organizers  the effect of incorporating linear feature terms can be quanaccuracy is measured in terms of the root mean square error tified by measuring the fraction of the responses variance
that is explained by the features  this is expressed by the
across the entire set 
coefficient of determination      
 
 
   
t    
   x
 i 
 i 
 i 
 i 
ssreg
ssres
 b  bt       at  at   
 
rmse i   
 
 
   
r      
    t t    t
 
sstot
sstot
 
 
m
     
  x
 i 
rmse  
 
    figure   plots this statistic against the    post shock rermse
m i  
sponse variables for each of the three types of responses 
we see that for t  t       the linear model captures less
figure   records the histogram of log rmse i     i   than     of the variance in the response  in other words 
           m  we see that the data has a relatively fat right high frequency market fluctuations  increments in mid or
tail with a few isolated errors as large as    pence  the spread  are essentially indifferent to the type of security or
extreme values are outliers generated by trading events at pre shock transaction history  the linear model merely capthe beginning of a days trading      however  the smooth tures the mean behavior expressed by the benchmark  this
part of the right tail is due to the fact that higher priced explains why top participants in the competition failed to
securities have higher volatilities  see section     this was improve on the performance from linear regression despite
also observed in     where the authors suggested that past trying non linear supervised and unsupervised learning alvolatility is a strong indicator of liquidity  performance of gorithms  note that the response right after the shock has
r       this is a consequence of repetition in the data supthe benchmark is recorded in table   
plied by the problem organizers 
   

 
   

   

   
   
rsquared

count

   

   

midprice  buyinit
midprice  sellinit
spread

   
   
   
   

  

   
 
 

 

 

 

 

 

 

   

 

log rmse 

 
 

 i 

figure    histogram of log rmse   for the benchmark 

  

  

t t 

  

  

  

figure    r  for the    post shock variables

 

linear regression   diagnostics
   

the simplest extension of the benchmark algorithm is to incorporate first order terms of available features in the mean
model  this can be achieved by regressing linearly onto
all     available features  pre shock transactions  at shock
transaction and security specific scalars   three sets of models are trained to predict the fifty discrete post shock values
of  i  mid price for a buy initiated shock   ii  mid price for
a sell initiated shock  and  iii  spread  extensive analysis is
performed to determine the bias variance trade off of this
simple approach  and to measure the predictive ability of
the feature set 

non normality of residuals

linear regression is formulated under the assumption that
the response is distributed normally about the mean model 
we can test this assumption by plotting the empirical quantiles of the regression residuals against the quantiles of a
normal distribution with zero mean and variance equal to
the empirical variance of the residuals  figure   records the
qq plot of the spread residual at t  t       we see that
the data is exceptionally fat tailed with the largest values
greater then    pence   this is in line with the observations
in section     
 

fi   

lr residual
loocv resdiual

quantiles of residual    st      

  

test error
train error

   

root mean square error  rmse 

 

 

 

 

   
   
   
   
 
   
   

  
 

 

   

 

standard normal quantiles

figure    qq plot for leave one out cross validation

     

 

   

   

   

   
 
   
number of samples

   

   

   

 
 

x   

figure    rmse learning curve for linear regression

 

leave one out cv

we can further verify the fat tailed nature of the response
by performing leave one out cross validation for the linear
model and observing the change in prediction for the heldout example 

k means clustering

as mentioned in sections     and        we claim that the
non normality of the regression residuals is largely due to
different variances for different training examples  this
claim is motivated from the observation that price processes
are often modeled as geometric brownian motions wherein
i   yi  yii   i                 m 
    the volatility is proportional to the price  i e  we expect
higher priced securities to have higher volatilities  in parwhere yi is the observed response for the ith example  and ticular  from eqn      
yii is the prediction for the ith example using all except the
m
i
  x h
ith example  in the case of linear regression  a simplification
 i 
 i 
rmse bench  
e var bt     var at    
    
can be achieved      using the sherman morrison formula
m i  
that allows for an analytical expression of the form 
which shows that each example contributes error proporyi
i  
  i                 m 
    tional to its variance  this can be empirically verified by
   hii
training separate models on clusters sorted by bid price 
towards this end  we use k means to identify   centroids in
where yi is the prediction for the ith example using all m the training data  train   sets of models  and record the corexamples and hii is the leverage of the ith example  the responding rmse values for clusters in the test set  table
qq plot of leave one out residuals is also recorded in figure   shows that rmse grows with growing cluster price  con   once again  the fat tails are evident  in section    we firming our claim  hence  the rmse for the full test set is
show  empirically  that these fat tails are largely on account largely dictated by the proportion of high priced securities 
of heteroskedasticity  since different securities have different
inherent volatilities 
clusters
centroid
    
     
     
rmse
    p
    p
    p
    learning curve
rmsfe
    
    
    
we have already seen that the entire set of     linear features
table    clustering with   means based on bid price
has very little prediction power beyond the benchmark for
most of the response variables  figure   plots the learning
in order to circumvent this limitation  we define an altercurve for rmse  eqn       where the test error is calculated
on the        examples in the held out set mentioned in native metric  the root mean square fractional error 
section    the plot shows that the linear model suffers from
rmsfe
    
high bias  with a rapid plateau of test error and increasing

   
 
 
training error  this indicates that either the current model
t x
   
m
 i 
 i   
 i 
 i   
x
 
 
bt  bt
at  at
  
is not capturing nonlinear dependence on the features  or   
 
m
   


that the overall rmse is largely controlled by the outliers
t t    
i  
mentioned in section        in the upcoming sections  we
   max max bt  min bt   max at  min at   
    
provide some evidence of the latter 
t
t
t
t
 

fiwhich measures the fraction of volatility of the response that
is explained by the learning algorithm  table   shows that
rmsfe remains nearly constant across the clusters as desired 

    
 

 

   

    
   

 

 

   
 

 

 
   

 

   
 

   

    
 

   

 
    

  

 

rmsfe

    
 

log  gamma 

   

 
rmse

log  gamma 

    

 
  
   

weighted lr  heteroskedasticity

 

 

 

 

 
 
log  cost 

 

 

 

 

 

 

 

 
 
log  cost 

 

 

 

figure     svr   rmse rmsfe on a grid of  c   
the empirical observations from the previous section show
that the normality assumption in vanilla linear regression
is clearly violated  an improvement can be readily incorachieved by calculating errors over the    response variables
porated by estimating the volatility of each example from
for a grid of parameter values  for computational ease  
pre shock prices 
is fixed at      as the training set is massive and for each
t
point    models must be trained  we perform this grid search
 
  x
 i 
 i   
 i 
using a small training set of       examples cross validated
 mt  m  i      
m    m     
t     t  
against a held out set of       samples  the contour plot
t
 
for both rmse and rmsfe is recorded in fig     we see
  x  i 
 i   
 i 
s    s     
 st  s  i      
     that the smallest generalization error is obtained for very
t     t  
small values of  in the rbf kernel  i e  the optimal model
these differing volatilities can be accommodated in the re  is essentially linear in the features 
limited by computational expense  we use optimal values
gression by weighting the examples inversely by their varifrom
fig    and train on the held out set containing       
ances  in particular 
samples 
instead of the full training set 
x
 i 
 i 
 i 
st  
j zj   s   i              m  t   t 
j
 i 
s

 



 i   
 n    s
 

where zj   j                  denote the features 

denoting

algorithm
benchmark
linear regression
weighted lr
svr

 i   

 
s i j      s   i j and using boldface for denote vectors  the normal equations for this case are given by
t  
z t  
s z   z s st  

    

such a weighted linear regression results in significant improvement of the rmsfe  see table    while the rmse
remains roughly the same  as expected 

 

in this section we show that the lack of fit for linear regression is not due to a non linear interrelation between the
response and features  this further builds upon the discussion from section      towards this end  we use libsvm
     to train a non linear regression model based on  svr 
  t
c
w w   c    t         
 
l
t
s t  w  zi     b  yi     i  

w b       

 wt  zi    b   yi     i  

train
rmse rmsfe
    
    
    
    
    
    



test
rmse rmsfe
    
    
    
    
    
    
    
    

table    comparative performance of the algorithms 

support vector regression

min

performance and conclusion

    

i              m 
    

where z is the vector of features  y is the response and c  
are regularization parameters  we choose the radial basis
function as our kernel for the inner product 

   z      z       exp kz   z  k    
    
as directed by the authors in       we begin by determining reasonable choices for the parameters c and   this is
 

table   records the training and testing rmse  eqn      
and rmsfe  eqn        for the four algorithms described
in the previous sections  the results for rmse are similar
to those obtained by top kaggle competition participants in
table    note that the actual values differ since the test sets
are different  the competition test set was not made public  
all algorithms produce rmse values very close to that of
the benchmark showing that learning based on pre shock
data was not beneficial for rmse  however  for the fractional error  rmsfe  learning algorithms provide significant
improvement over the benchmark  among the three supervised learning models  weighted lr performs best  yielding
an efficient prediction algorithm for high frequency data 
the table strongly supports the claims made in sections
       and    the rmse of the test set is largely dictated by high priced securities associated with high volatility  thus  adding linear non linear features adds very little
predictive capability in comparison to the benchmark  however  rmsfe  which normalizes error by volatility  indeed
decreases as the algorithm is refined  showing that the features do have some intrinsic predictive capability in this new
measure 

fireferences
    lawrence r  glosten  is the electronic open limit order book inevitable   the journal of finance               
       
    christine a  parlour  price dynamics in limit order markets  review of financial studies                     
    bruno biais  pierre hillion  and chester spatt  an empirical analysis of the limit order book and the order flow in
the paris bourse  journal of finance                  
    thierry foucault  ohad kadan  and eugene kandel  limit order book as a market for liquidity  review of financial
studies                       
    tarun chordia  asani sarkar  avanidhar subrahmanyam  an empirical analysis of stock and bond market liquidity  the review of financial studies vol      no           
    ming huang  liquidity shocks and equilibrium liquidity premia  journal of economic theory                   
    bruno biais  paul woolley  high frequency trading  toulouse school of economics  london school of economics 
       
    john h  cochrane  monika piazzesi  the fed and interest rates 
a high frequency identification 
http   www nber org papers w      national bureau of economic research         
    url  https   www kaggle com c algorithmictradingchallenge  
     g  e  uhlenbeck  l  s  ornstein  on the theory of brownian motion  phys  rev                    
     peter dalgaard introductory statistics with r  springer science   business media         
     chih chung chang  chih jen lin  libsvm  a library for support vector machines  acm transactions on intelligent
systems and technology  tist                  
     chih wei hsu  chih chung chang  chih jen lin  a practical guide to support vector classification         

 

fi