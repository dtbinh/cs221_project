

automatedstitchingandspinedetectionofspinyprojectionneurons
albarran e andsun x 
cs    machinelearningdecember      

introduction
acomplexproblemin neurobiology  andmicroscopyingeneral isimageprocessingofneuronal
processes  in particular  neuroscientists often find themselves in the position of  having gigabytes of
highresolution images  e g  confocal   photon microscopeimages of neuronalprocesses  but arethen
metwiththeburdensometask of manuallyanalyzingtheirdata a commonexample ofthisis havingto
stitch together images of several compartments belonging to the same cell  and manuallycountingthe
number of dendritic spines  a biologically relevant protrusion  for  each one ofthehundreds ofimaged
cells   althoughsomesoftwareexiststohelpwithextractinginformationsuchasdendriticlengthorspine
densities theprocessisverymuch stilllimitedtomanualtracing countingandanalyzing hereweapply
state of the art computervisionandmachine learning techniques to approach this issuesoasto process
andanalyzeimagesmoreautomaticallyandefficiently 
specifically our currentprojecttakes inasinputacollection of dtifstacks rawimagefilesof
dendritic processes taken with  photon microscopy   processes them through filtering and feature
detection  passes the processed  data through  a random forest classifier  
ilastik framework  that yields
probability maps  which are then used to predict the number of spine  objects  within the data set 
therefore  the entire process is a means of automatically processing and extracting the number of
dendriticspinesfromacollectionofraw photonimagingfiles 

relatedwork
in order to  precisely extract spatialmorphology information froma setoftiles they needto be
stitchedtogetherwithincrediblyhigh precision  therefore manylabsstillrelyonmanuallyaligningtheir
tiles to reconstruct thewholecellmorphology for example inprof jun dings lab  e albarran   tiles
are manually stitched together based on the  x  y  position data pertaining to  the header files of each
imagestack dendriticspinesarethenmanuallycountedbyeye theentireprocessisverylong 
automaticcounting of dendritic spinesisaclassificationproblem andtherehavebeennumerous
attempts before ours  herzog et al         attempted  d reconstruction  of dendritic trees  using a
parametricmodel ofcylinders butthismethodwas notrobusttothevariousmorphologiesthatspinescan
take  i e  great variety in spine  neck width  length   etc    similarly  alkofahi et al         used a 
generalized  cylinder  model to estimate local directions  gradients   and then dendritic backbones were
directly traced using preestimated seed points  however  this method yielded anincomplete extraction
due tothe incompleteinitialestimationoftheseedpoints  using amore geometricapproach koh etal 
      
constructeda median axisto locatedendritesandthendetectspinesassurface protrusionsrelative
to those backbones  however  since the segmentation is achieved bya simple global thresholdmethod 
and very limited geometric information  is considered for spine detection  this method detects a  lot of
pseudo  spines  using a more statistical approach  zhang et al          utilized a curvilinear structure
detector and linear discriminant analysis classifier  but their implementation was not very efficient



fialbarran sun

 required thousands of  training sample images to yield decent results  and is again susceptible to
variabilityinspinemorphology 
in summary  previousattempts at addressingthisproblemhave ranged fromutilizinggeometric
fittingtomachinelearningapproaches butnonehavesucceededinterms of
bothaccuracyandefficiency 
the two algorithms we  utilize here  sift and 
ilastik  i e  random forest classification  havebeenused 
extensivelybeforeinmanycontexts e g citypanoramastitchingandcountinganimalcells respectively  
butherewecombinetheminthenewcontextoftwophotondendriticspineimages 

dataset
our data set consists of  photon microscopy  d stack images of dendritic branches of  spiny
projection neurons  spns  in the mouse dorsolateral striatum  these stacks each contain    frames of
   x    pixel tiles of dendritic segments      micron     the tiles  x  y   coordinates themselves
overlapwitheachotherto forma completetracingofindividualbranchesofan spnneuron whereeach
neuronconsists of acollectionof    setsofoverlappingtiles imagedatawasacquiredbye albarran
andyuweiwu postdoctoralfellow  
thefirst stepof preprocessingofthedataconsistsofdenoisingthe imagestacks foreachframe
in the stack we apply dmedianfiltering lim      toremove thesaltandpeppernoisecommonin
 photon microscopy  but maintain boundary information  for the  dendrites and spines  the next step
involves transforming each  d stack into one single    x      d tile  this is done by taking the max
projection  the max intensityvalueateachpixellocation acrossall  framesinthestack theresultisa
single  d tile image  referred to from here on out as atile  in total thedataset consistedof      of
these tiled projections spanningacross atotalof   cells imagedfrom  mice  larger fullcellimages
were thencreatedbystitching together the    tilescorresponding tothecell seemethodssection    
tiles were used for training the classifier  and testing was done on the    fullyreconstructed images 
additionally the  fullcellimageswerepreviouslymanuallystitchedandtheirspinesmanuallycounted
touseasacomparisonforthespinenumberspredictedbyourclassifier 

methods
thefirst stepwasto reconstruct the wholeneuronimages fromthe tiles inorderto dothis we
implemented  the scaleinvariant feature transformation in order to extract features to use for tile
matching  sift combines afeaturedetectoranddescriptor  thealgorithmconsists ofthefollowing for
eachtile      constructionofgaussian scalespace    takingthedifferenceofgaussiansand locatingthe
extrema      subsampling potential feature points       filtering out  edge and low contrast      and
assigning keypointorientations buildingthekeypointdescriptors thelaststepyieldsasetofdescriptor
objects i e features  whicharethenusedtodeterminematchingpointsbetweentiles 
for matching  we utilized a ransacbased algorithm to determine homology of features
 fischler and bolles         similar feature descriptors  based on ransac leastsquares estimate of
homography betweenthetwotilesarepairedup andtherelativedistancesbetweentheselectedfeature
pairs are computed  of these pairs wethenselect the subsetofdistancevectors that meetthethreshold
criteria  we use avg  slopestd      andavg  lengthstd      px  andusing those distance vectors  we
translate one tile  onto the other  the entire matchingalgorithmconsists ofthe following algorithm     
place the center tile  pertainingtothesoma       stitch the next tile    thestitched tileisnow thenew

fialbarran sun

center tile      loop to step   until  there are no more tiles left  this algorithm results in a complete 
featurebasedreconstructionoftheneuronalimage 
after the wholecell images were stitched     total   we then aimed  at detecting and counting
dendritic spines from the stitched images  w
e first used the random forest classifier algorithm
implemented  in by the 
ilastik framework  sommer et al         for object identification   this process 
involvedthreesteps pixelclassification objectsegmentation anddensitycounting 
for pixel classification  fig  a b   we firstdidmanualannotations  labeling  of dendriticspines 
dendriteprocesses and background  on   ofour unstitched tiles automatic classificationcouldbedone
in batch mode with test images  where the classification ruleislearnedfrom the trainingimages  each
pixel intheimage hasa feature vectorbased onwhat featuresare selectedforclassification theweight
of eachfeaturein thefeaturevector islearned fromthelabelingofthetraining images 
ilastik includesa
convenient annotating gui that can  be used to label arbitrary numbersof classesin the images  these
labels  along with aset of generic nonlinear image features  are thenused totraina the randomforest
classifierforbothobjectclassificationandcounting 
more specifically  when training the pixel  classifier  we usedthefollowingfeatures for feature
selection  for 
color features
 gaussian smoothing togetridof as muchbackgroundnoiseaspossible but
preservethe dendriticspine  
edge features  gradientmagnitude of gaussian euclideannormofthefirst
derivative in each direction  high value assigned to  edges and small value  assigned to non edges 
laplacian of gaussian  approximated  by difference of gaussian   second derivative in each direction 
high valueassigned toedgesandsmallvalueassignedtononedges onevalueperpixel  sothenumber
offeaturesequalsthelengthofthefeaturevectorofeachpixel 

thepixelclassification stepgeneratedprobability maps 
 fig  c asinputsforthefollowingsteps 
namely  object segmentation and classification 
 fig  d 
  this step transformed a probability map
 generatedby pixelclassification intoasegmentationbygaussian smoothingandthresholdingbyasize
filter  with object segmented wethenselected thefeatures for object classification  assignedthefeature
vector to each object and then classified the object becausewedontneed toclassify dendriticspines 
here we classifiedobjects as eitherdendriticspines ornonspine circles ratherthandifferentsubtypes of
dendriticspines theclassificationwasdonebyrandomforestalgorithm 
thelast stepis densitycounting whichisdone with the segmentation imagesasinputs firstwe 
labeled the segmentized dendritic spines as the object for counting  then we used random regression
forest basedonsklearn withnumberoftreesanddepthofeachindividualtreeadjustable tocomputethe
density number ofobjects hereitisdendriticspine  
therfalgorithmweusedisasfollows breiman       
rfs growmanyclassification trees to
classifya newobject fromaninputvector  puttheinputvectordowneachofthetreesintheforest each
treegivesa classification  andwesay thetree votes forthatclass theforestchoosestheclassification
havingthemostvotes overallthetreesintheforest  eachtreeisgrownasfollows 
   ifthenumber ofcasesinthetraining setis n sample ncasesatrandombut
withreplacement
 
fromtheoriginaldata thissamplewillbethetrainingsetforgrowingthetree 
   if there areminputvariables a numberm  misspecifiedsuch that ateachnode m variables
are selected at random out of the m and the bestsplit onthesem is usedto splitthenode the 
valueofmisheldconstantduringtheforestgrowing 
   eachtreeisgrowntothelargestextentpossible 

fialbarran sun


abcd 

 

resultsanddiscussion
classification resulted in apredicted labelingof
dendritic spines  fig     these labelings were extracted 
viatransformingthe classifiedimagesintobinaryimages
and then using thematlabfunction 
bwboundaries which
returns pixel blob object handles  the number of
objects  returned then corresponds to the number of
spines detected  comparing the number of predicted
spines to the manuallycounted spine images yields a
performance measure of our classification  wefirst order the
   test images  by number of manually  actual  spines   and
plot the number of predicted spines yielded by our classifier
 fig    itcanbeappreciated that the general trend iscaptured
byourclassifier moreactualspines morepredicted spines  
however  due  to the small sample size  we are  unable to
perform more sophisticated validation such as  loocv 
collectingmore cell imageswillallow us toperformstronger
validation 
through roc analysis  fig    we were able to get a
sense of the sensitivityspecificity tradeoff of our
classification  as well asfinetune it  althoughrandom forest
is based on a largest vote classification process  the roc
curve was calculatedby placing athreshold        on the
posterior probabilities  classifications  yielded from the
random forest and determining the true positive and false
positive classifications  from the roc curve it is clear that
the classifier yielded mostly weak         or
moderatestrength          classifications  we attribute the
lowof high tp fpto thesample size of ourtraining usingtheroccurve wesetour optimalthreshold
tobe    whichstillresultsinatprateof    andafprateof     

fialbarran sun

for spine identification and counting   we trained ourclassifierwitha datasetof   images and
tested with  images comparingactualspinenumbersandthepredictednumbers weconcludedthatthe
prediction resultisreliable  thoughnotprecise enough  attheveryleast  the numberofpredictedspines
isin positiveproportion totherealnumber ofspines ifweincreasethesizeoftrainingsetinthefuture 
weexpectthatthisautomaticcountingalgorithmcanworkmuchbetter 

conclusion futurework
our stitching process worked very well to reconstruct the tiled twophoton imagesof neurons 
and this automatic stitching algorithm is much faster than current nearlymanual method  it currently
takes    mins hr to manually stitch the images and count spines  our  automated performance takes
  minsfrom start tofinish 
in thefuture weplanto optimizetheimage preprocessingparameters e g 
the parameters for gaussiansmoothing image erosion anddilation  etc  to better denoisetheimages
and thus achieve better performance  we expect that both this combination ofsiftandclassification 
after being adjusted to specific datasetsforspecific purposes can be applied tolargerscaletwophoton
imagedataprocessinginourownlabs aswellasotherlabsdoingsimilaranalysis 
as a future direction   we plan to do functional analysis of the dataset  
based on  the stitched
images  and identified objects  we will use accompanying ca   imaging data to analyze the
locations distributions of the upstream inputs  from sensory or motor cortical neurons  and thalamic
inputs  that synapse onto the identified dendritic spines  the  morphology of the spinesthemselves and
eventhefunctionaldynamic properties byapplyingpca fa toget lowdimensionalstatetrajectoriesof
the highdimensional neural activity of spines   we are planning to characterize and compare the
structural and functionalfeatures of motor  sensory andthalamic inputsfromcortical cellsand thalamic
nucleiontostriatalspinyprojectionneurons 


references 

 vlfeat 
http   www vlfeat org index html
 a  herzog  g  krell b  michaelis j  wang w  zuschratter a k  braun        restoration of
threedimensionalquasibinaryimagesfromconfocal microscopyanditsapplicationtodendritic 
trees  proc  spie                 threedimensional  microscopy  image acquisition and
processingivbellingham wa 
 k a  alkofahi  s  lasek d h  szarowski c j pace  g  nagy j n  turner b  roysam        
rapidautomatedthreedimensionaltracingofneurons fromconfocal imagestacks  ieee trans 
inf technol biomed           
 i y y  koh  w b  lindquist  k zito e a nimchinsky  k  svoboda        an image analysis
algorithmfordendriticspines neuralcomput              
 zhang et al  
dendritic spine  detection using curvilinear structure detector and lda classifier
       

neuroimage
 
    
         

fialbarran sun





c sommer c strhle u kthe f a hamprecht       ilastik interactivelearningand
segmentationtoolkitin eighthieeeinternationalsymposiumonbiomedicalimaging isbi  
j s lim twodimensionalsignalandimageprocessing       prenticehallptr 
l breiman randomforests machinelearning                 



acknowledgment 
we thank
yuweiyu  lab of junding for help indata acquisition  
saurahbvyas labofscottdelp 
for suggestions on mosaic stitching  
irene kaplow  ta  for advicewithimage processing and project
direction andprof 
andrewng
 

fi