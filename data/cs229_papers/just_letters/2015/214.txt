localization through wireless access point channel state information
alexander dewing  robert sun  xiaonan tong
adewing stanford edu   robsun stanford edu   xiaonan stanford edu

thursday     dec    
   abstract
we propose and implement a way of estimating
distance from wi fi access points as a method of indoor
localization  in contrast to many other solutions  the
proposed method is software only and works with current
widespread technology  and can be implemented on
current smartphones without silicon modifications  our
method utilizes machine learning to produce a relatively
low root mean squared error of      meters  training on
data collected between  m and   m away from the
wireless ap 

   introduction
gps is widely accepted as a standard of effective and
accurate positioning  however  gps requires signal
acquisition from multiple satellites  a complication
anywhere inside structures or underground  as our need
for navigation systems grow  accurate indoor localization
becomes increasingly valuable and necessary 
we propose an infrastructure free method of
triangulating local position in  d space through predicting
direct path distances to multiple wi fi access points  we
differentiate our system from other localization
methodologies by its straightforwardness and
generalizability  while still attaining a fairly accurate
result  our system uses metrics that are exposed by wi fi
chipsets as part of normal operation and do not require any
hardware changes  nor changes in router software  our
technique readily works with    ghz       n routers 

   background information
     intricacies of wi fi localization
wi fi transmits using orthogonal frequency
division multiplexing  ofdm   meaning that it
broadcasts on several narrowly separated subcarriers at the
same time to increase data rate  each subcarrier is
synchronized at the beginning of a frame  thus the phase
angle between the subcarriers encodes time of flight data
for this packet  furthermore  each subcarrier is measured
with an additional phase angle on each antenna due to the
spatial layout of the antenna array  at the receiver  the

client can recombine the various signal characteristics
from multiple antennas and gain information about the
channel  the end result is a complex number describing
the signal received per antenna per subcarrier 
collectively  this data is known as channel state
information  csi   we will analyze further our data
format in section     
radio signals in the gigahertz range are prone to
reflecting off of walls and other surfaces  this introduces
complications to our estimation of the direct path by
creating a multi path system  due to the effect of multipath interference  as well as normal signal attenuation  the
received signal will be a convolution of the original signal
with the wireless channels properties  see figure   

figure   multipath and signal propagation  shown with one
transmitter tx and two antennas rx     sometimes a signal
could even destructively interfere on rx   but can be
reconstructed through rx   

the       n wi fi specification transmits in the
   ghz ism band  using    overlapping channels in the
us and up to    elsewhere in the world  each channel
defines    subcarrier frequencies  each separated by
     khz  through complex signal processing on the csi 
it is possible to obtain a vector of possible aoas  angles
of attack  and isolate the direct path  the euclidean line to
the router   
the signal processing can be summarized as this  the
phase angle between subcarriers encodes time of flight
 tof   and the phase angle between antennas encodes
aoa  by obtaining aoa and tof of the direct path  one
 

image from multipath and diversity  cisco
spotfi  decimeter level localization using
wi fi   kotare et al       
 

fican reverse calculate the exact distance to the receiver
using only one router  see figure   

     data collecting
as specified by the linux csi tool  each channel
data isentry
transmitted
over multiple
matrix
is a complex
number  subcarriers
with signedeach
  bitwith different
frequency 
we
can
write
an
equation
similar
resolution each for the real and imaginary parts  each to eq 
  for each
of the encodes
subcarriers 
and the
a does
complex
number
the gain
andsteering
phase ofmatrix
the signal
  across
not
change
because
the
steering
vectors
do
not
change
path between a single transmit receive antenna pair  
closely spaced subcarriers         let us construct measurementwe
matrix
x by
signal
each
moved
theusing
laptopreceived
unit around
thevectors
wi fi for
router
in of
the
n
subcarriers
using
eq 
 
below 
concentric circles with radii of  m to   m in   meter

incident signal 

d sin  

      

antenna array  
  

  

m

d 

figure   
   aoa
   islinear
influenced
due to theof
distance
  for
 aoa
figure
uniform
array consisting
m antennas 
that
travels
antennas 
of
 the
thesignal
targets
signalbetween
travels an
additional distance of d sin  
to the second antenna in the array compared to the first antenna 
this results in an additional phase of  d sin  f  c at the
secondhowever 
antenna  for our purposes  we wanted to see if

machine learning techniques can predict direct path
lets
say from
there the
areinput
l propagation
paths welets
assume
distance
dataset of csi 
assume
that that
m
antennas
are arranged
in adistance 
uniformalinear
array easily
similar
given
an accurate
direct path
user could
to
systems his her
like arraytrack
        
with equal
spacing of
triangulate
position using
a database
of known ap
th
dlocations 
betweenpossibly
consecutive
for the kthereby 
propagation
usingantennas 
slam techniques 
we
path 
let

denote
the
angle
at
which
the
signal
arriving
k
simplify the problem to estimating the distance ofisthe
with
to router
the normal
clientrespect
from the
based of
onthe
the antenna
channelarray
state of the ap 
let
the complex attenuation experienced at the
k denote
information
data 
first antenna in the array by the signal traveling along k th
propagation
path  the attenuation at the second antenna in
   data collection
the array is the same except for an additional phase shift accumulated due to additional distance traveled by the signal 
    depends
hardware
and
on d setup
and k  
each
therefore 
hasrouter
two parameters
wepropagation
are using anpath 
unsecured
wi fi
running associated
in this
the attenuation
and theisaoa 
dd wrt 
the model 
laptop collecting
information
an hpas described
sec  modified
  of arraytrack
and
illustrated
in     
fig    
pavilionindv  
with an   
intel
wireless
link
relative
to the
firstlaptop
antenna
the the
array 
the csi
phasetool
shifttointrowi fi card 
this
willinrun
linux
duced
mth antenna
is  d m
   sin 
extractatchannel
measurements 
as the iwl    
is ak  f  c
where
c
is
the
speed
of
light
and
f
is
the
frequency
multiple input multiple output  mimo  chipset with  of the
transmitted
signal     for
simplicity
antennas  figure
we obtain
csi of
forrepresentation 
  antennas and let
   us
denote
the complex
exponential of these introduced phase
subcarriers
each 
shifts as a function of the aoa of the propagation path 

 k     e

j d sin k  f  c

   

 

so the aoa can be thought of as introducing a vector of
phase shifts at the antenna array  or the sensor array   the resulting vector of received signals due to k th path can be written as  a k   k   where k is the complex attenuation along
the path experienced at the first antenna in the array and
 a k       

 k        

 k   m

    

 

   

using the notation introduced in eq     this vector  a k   is
also known as the steering vector  we have as many steering
vectors as propagation paths and the overall steering matrix
a is defined as a     a               a l      and has dimenfigure   iwl    
sions m  l  
the received signal vector  x at the antenna array is obtained by superposition of signals due to all the paths  i e  
 x   a   

   

where               l    is the vector of complex attenuations along l paths and a is the steering matrix  in ofdm 

intervals  x
simultaneously 
file to    
    x         xn  we
  downloaded
a             na large
  af 
ensure a steady stream of packets  and generated multipath
where vectors
x             xthe
the received
n denote
interference
by  occluding
source and
adding signal vectors at each
 correspond
to  x in eq   
reflections 
toofdothe
so subcarriers
we placed reflective
planes
  n are the vecobtained for
different
          
 aluminum
foil
makes subcarriers  
for extremely radio reflective
tors of complex
attenuations
of the propagation
surfaces 
and moved
them continuously 
this is paths
not anat each
  in eq but
of the subcarriers
 correspond
  obtained
entirely
rigorous data
collectiontosolution 
it does for different subcarriers  
f is the matrix
of complex attenuaguarantee
high levelsand
of multi path
reflections 
tions gains 
the
and phase  million
shift introduced
foroverall
each ofattenuation
the approximately
gathered by the
channel environment
measured
each
subcarrier
ofineach
packets 
we separate complex
dataatinto
gain
and phase
a
antennabyiscombining
reported by
the wifi card
a csi value
matrix 
information
fromas
  antennas
on  its a
complex
for example 
eq    represents a nominal
each
of thenumber  
   accessible
subcarriers
csi matrix reported 
by   intel
card
for   antennas
          
 wifi
    
      
and   
subcarriers 



 
      
 
   
     
         
    csi
    
csi
      csi
    
and store
it as
an array
csi    csi          csi            
csi
matrix
   s t 
csi
       csi    
       csi
     
     
       
      

where csi

is the csi value for mth antenna and nth sub 

m n
  carrier 
modeling
thus  the csi value at each subcarrier is nothing but

for initial
review
thethe
firstpaths 
milestone 
the received
signal
dueand
to all
hence we
fordecided
the aoa
described
above data
the received
signal vector
in eq   
tomodel
train our
preliminary
using gaussian
kernel xridge
corresponds
to one
of the columns
in the
csi matrix
regression
with
leave one out
cross
validation 
weand the
measurement
matrix
corresponds
thedlib
csi matrix
wrote
our tool in
c  xprogram
usingtothe
libraryitself 
the music
 version
        algorithm is working with this information
and relationship  the wifi card measurements provide us the
matrix
and the
goal isridge
to estimate
the matrix
from which
wexchose
kernel
regression
for itsa speed
it is easy to
deduce
the aoas 
theregression
key idea behind
advantage
against
support
vector
when the muh
sic algorithm
that thealso 
eigenvectors
correspondtrained
on large isdatasets 
we choseofa xx
linear type
ing to the eigenvalue
zero  if linear
they exist 
are orthogonal
regression
since we believed
combinations
of theto the
steering
vectors
in a    we
omit the
mathematical
derivation
data
 scaled
differences
between
phases
and magnitudes 
for brevity
but refer result
to the related
broad literature
discussing
these
created
a meaningful
to the direct path
time
theit seemed
music that
algorithm
at a basic
level
proceeds
ofideas
flight    
since
delta phase
created
aoa
and
firstinfo 
by computing
theuse
eigenvectors
xxhincorresponding
tof
we opted to
a gaussianof
kernel
hope of
to the eigenvalue
zero 
and then computing
the steering vecfinding
taylor series
approximations
of the trigonometric
tors orthogonal
vectors  once
thephase
steering
functions
requiredtointhese
transforming
the raw
and vectors
are found  data
the aoas
candesired
be deduced
easily 
magnitude
into our
output 
the key problem however is the assumption that there are
eigenvectors
xxh that
correspond
zero and
as each of
adjacent
packet
is subjecttotoeigenvalue
very similar
that they
are orthogonal
to the steering
vectors 
prior work
spatial
constraints 
we concatenated
packet
csi data 
has shown
that its performance 
true only if theinitially 
steeringwe
matrix
is skinny
hoping
to improve
useda  
and full rank matrix and the matrix f is fat and full rank main other words the number of rows of steering
 trix     
linuxa      
toolthan the number of columns in
matrix
should csi
be larger
http   dhalperi github io linux      n csitool 
the matrix  physically this maps to saying that the number
of sensors  in this case antennas  has to be larger than the
number of propagation paths  for example  if we have radios with only three antennas and environment where there
 

xh is conjugate transpose of x 

ficonsecutively received packets per training test pair since
we thought that would give enough information for the
multipath to be filtered out along with comparisons on a
per channel basis for the direct path tof estimation 
example 
                 
      

   results and discussion
     expanded dataset
having proven that the distance estimation works
acceptably for    m  we sought to expand the data set to
distances up to   m  in this range we collected about  
million packets  enough to generate at least     samples
per distance class 

our initial dataset comprised of packets at    m  the
krr loocv resulted in a mean squared error of
approximately     meters  indicating that a large portion
of the samples will be within     meters of their actual
distance from the router 

however  using the same methodology as the
initial run  rms increased to     m  causing us to doubt
the generalizability of the earlier experiment 

given a proven methodology  we continued to
experiment with more data  various feature spaces  and
packet concatenations so as to best train the regression 

to reduce training time in the next test  after
verifying the limited effects  we reduced the training set
size by randomly selecting      samples per distance
class  we also added real and imaginary components into
the feature vector alongside the magnitude and phase
angle interpretation  this gave us a total of      features
per sample   antennas   subcarriers   packets  features  

for our final results  all numbers are generated by
kernel ridge regression  using k folds cross validation
where k    we computed the gaussian  radial basis
function  kernel by randomly subsampling      feature
vectors  and calculating inverse of their mean squared
distance 
 
 
        k   

     real and imaginary components

unfortunately  adding real and imaginary
components increased the distance estimation error to
   m 

table    the method of generation  as well as the root mean squared error of the krr k folds cross validation  subsequent uses of x
refer to recursively operating on the feature vector 

 

sample generation method

desc of trial

 

                
 m   m


          
               
 m   m  limit      samples per distance class 
                
 m   m       limit per distance class 
         k    n  
 m   m       limit per distance class 
                 n  
 m   m       limit per distance class 
            o    n  
 m   m       limit per distance class 
n
             
 
 m   m       limit per distance class 
n
n
            o        
       o  o
  
 m   m       limit per distance class 
n
n
                      
             
  
 m   m       limit per distance class 

expanded dataset

 
 
 
 
 
 
 
 

rms
error  m 
    

using real and imaginary
component as well as sampling
experimenting with gamma
value
pairwise multiply   packets

   

pairwise multiply   packets 

   

pairwise multiply   packets 

    

packet convolves with self 

   

intra packet pairwise multiply  
packets 
intra packet pairwise multiply
   packets 

    

see figure   
    

    

fi     gamma experimentation
we observed the effect of gamma value  for the
rbf kernel  on the cross validation error  mechanically
altering it to larger values and testing the same feature
vector as defined in section      we observed decreasing
accuracy as we increased gamma  see figure   for more
details 

distance  after achieving a substantially better result for
the   packet vector  we attempted   and   packet
groupings with a vastly higher number of features  but the
test error increased  we attribute this effect to overfitting 
with infinite training time  we would have tried to
further train with triplet wise multiplications
 multiplications of   numbers chosen from the feature
vector   on feature vectors of   to    packets  however 
performing triplet wise multiplication on a two packet
feature vector would generate   million features would not
be feasible due to memory and processing constraints 
however  it is highly possible to attain high accuracy with
those features as the convolution style of data modeling
makes perfect sense in this application 

     internal pairwise multiplications

figure    gamma vs   folds root mean squared error 

ultimately  we left the gamma value unchanged
from the mathematical definition in section    as that
yielded the smallest rms error  approximately       in
figure    

based on a theory that each packet might be
linearly separable we sought to limit our feature vector by
convolving each individual packet  instead of the entire
multi packet vector  this allowed us to train on larger
concatenated packet counts with acceptable runtime 
using   packet    packets  and    packets  we could
not improve rms error  results were substantially worse
than the current optimum of     m  we obtained rms
errors of           and    m respectively 

     pairwise multiplications
from further analysis of the mathematics of
calculating time of flight from received signals  we
determined that some sort of convolution might be
necessary  intuitively  aoa and tof are calculated using
matrix multiplication from csi 
since aoa is calculated through combinations of
phase and magnitude between antennas and tof through
combinations per channel  it seemed to be a reasonable
choice for us to find all pair combinations of features and
multiply the pair together  the algorithm should figure out
which of these pairs contributed the most to the distance
estimation 
therefore  we focused on a smaller number of
packets for runtime consideration  and generated our
feature space using the outer product of the csi vector 
using two concatenated packets    k features were
generated  with up to    k features for   packets 
essentially  we are learning on a single fully connected
neural net layer 
this technique yielded substantially improved
results  with a relatively small     m of rms error  the  packet vector gave the best generalization of actual

   future considerations
using   packet convolutions and a kernel ridge
regression  we have achieved almost meter level accuracy
on a tough localization challenge  with no signal
processing involved  we demonstrate errors that compare
favorably against much more complex and advanced
localization research  there is promise in applying
machine learning to localization and machine learning
could be coupled with more theoretical algorithms for
improved results 
due to our final algorithms resemblance to
neural net structures  future research should evaluate the
use of deeper neural nets to approximate distance  one
possible way to increase speed would be restricting the
pair wise multiplication to just phases or just magnitudes 
since the phase and magnitude product makes little sense 
however  given current results and our initial
constraints to commodity hardware  indoor localization
appears increasingly ready for large scale deployment 

fi