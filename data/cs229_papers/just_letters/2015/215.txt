medical image retrieval based on  d lesion content
blaine rister
december         

abstract

the problem 

content based image retrieval is an emerg 

   background and prior work

ing technology which could provide decision
support to radiologists  this paper describes

content based image retrieval is a well established re 

a system for content based image retrieval

search area  albeit less so in the medical context  the

based on  d features extracted from liver

reader can refer to akgul et al 

lesions in abdominal computed tomography
images 

for a survey of the

eld and discussion of challenges faced in developing

a supervised learning algorithm is

cbir systems for medical use  akgul et al         

developed to transform image features into

this project is a follow up on the work of napel et

search rankings  in our experiments  the su 

al   who studied content based image retrieval using

pervised learning provides some benet over

the same image dataset  but with dierent features

unsupervised methods 

and learning algorithms  napel et al         

napel

et al  used a combination of image features based on
shape and texture  along with a boosting like learning

   introduction

algorithm  to predict pairwise similarity between le 

content based image retrieval is the task of searching

sions  homaniger et al mined radiology text reports

a database for similar images to a given query image 

to extract training supervision from a larger dataset 

rather than relying on metadata  as do many commer 

despite previous attempts at medical content based

cial search engines  content based retrieval systems use

image retrieval  there is still room for improvement on

image processing and computer vision to describe the

the state of the art 

content of an image  for example  two images having

this project diers from previous work in two as 

similar color distributions might be marked as similar 

pects  firstly  it uses recently developed  d image fea 

content based retrieval algorithms can augment

tures  constituting an improvement over  d features

metadata based retrieval  or replace it in application

and some previous attempts at  d features  secondly 

domains for which metadata is unavailable or unreli 

it uses a modied regression algorithm that specically

able 

takes the ranking problem into account 

this report describes a content based image retrieval
system for  d medical images 

rather than search 

   dataset and features

ing by holistic image features  which are irrelevant in
the medical context  the system extracts features di 

before describing the details of our training data 

rectly from lesions  ranking each lesion on a case by 

we will brush up on the basics of computed tomog 

case basis  lesion similarity is predicted by a super 

raphy  ct  scans 

vised learning algorithm using  d image features as

dimensional x ray images  reconstructed from multi 

input 

ple one dimensional measurements taken by a moving
measurement device 

such a system could benet practicing radiologists 

ct scans are essentially three 

ct scans are among the most

popular types of medical images  with over    million

some diseases are very rare  such that a radiologist

performed in the united states alone in the year     

might only see a handful of cases in his or her career 

 de gonzalez a et al          they are commonly used

in these situations  a radiologist could search through

to diagnose and monitor cancer  among other diseases 

a database for similar cases to gain more insight into

as seen in gure    liver lesions are clearly visible in
ct scans as dark areas surrounded by the lighter liver

final project report for cs     at stanford university 
     

tissue 
 

fifigure    example liver lesion  indicated by the red arrow 
in a ct scan 

a gradient vector  shown in black  intersecting a
histogram tile  shown in yellow 
figure   

our dataset consists of    annotated liver lesions from

is an array of weighted histograms describing the dis 

ct scans  the annotations provide a few points on the

tribution of image gradient orientations  that is  for

boundary of each lesion  and were created by board 

each pixel in some window

certied radiologists 

the gradient of the image data

these annotations allow us to

w   x  we approximate
ix   and add this vec 

extract features only from the lesions  disregarding

tor to a weighted histogram based on its orientation 

other image content 

as shown in gure    in practice  this is a robust repre 

each ct scan contains a massive amount of data 
commonly having an

             mm 

 x  y  z 

resolution of around

x 

this is signicantly reduced by ex 

tracting the lesions  which may have a radius of around
   voxels 

sentation of the shape of an object about a coordinate

still  given our limited dataset  it is not

prudent to train on image data directly 

rather  we

extract a set of image features describing the shape
and texture of each lesion  allowing us to summarize
the relevant content in a low dimensional space  the
following sections describe the two types of features
used for training 

     haralick texture features

the second type of features are haralick texture features  these were originally developed by haralick et
al  for classication of satellite images  haralick et al  
      

haralick used his simple texture features  to 

gether with piecewise linear regression  to accurately
classify land into several usage categories  such as city
and farmland 

     sift d features

haralick s texture features are computed from a ma 

the rst type of features are  d image descriptors 

matrix  glcm   its elements

previously designed for a dierent work 

the probability that a pixel of intensity

trix
here i will

p 

which is known as the gray level co occurence

pij

give an estimate of

i neighbors one

give a rough overview of their properties and moti 

of intensity

vation  without delving into too much detail  as im 

tion is discrete  which assumes that the image intensity

age feature engineering is outside the scope of cs     

values are quantized  this is not terribly inaccurate 

the features are a higher dimensional analogue of the

as images are captured and stored in a quantized form 

scale invariant feature transform from the computer

knowing this  it is straightforward to estimate these

vision literature  lowe        

probabilities as

j 

the input to the feature extraction program is a set
of abdominal computed tomography  ct  scans  and

pij  

a set of annotations of the liver lesions in those scans 

note that this joint probability distribu 

  pixels

i

neighboring pixels

j

total   pixels

 

the annotations are ordered sets of points tracing

note that this matrix is computed only within the le 

the boundary of each lesion  we assign a coordinate

sion boundaries  as we are trying to describe only the

x    x  y  z 

to each lesion by taking the

texture of the lesion itself  here we have used an infor 

center and radius of the minimum bounding sphere of

mal notation  as the concept of one pixel neighboring

the annotation points  assuming the annotations scale

another is quite easy to intuit  but less so to formalize

consistently with the images  the scale parameter en 

algebraically 

and scale



sures scale invariance of the features 
it remains to extract the feature vectors 

for our purposes  not enough to use the matrix
there are

many variants on this idea  but the approach used here

p

as

training input  images are commonly quantized into

    dierent intensity values  in which case p

is of size

ficontrast

correlation

energy

homogeneity

   

   

   

   

texture features for the lesion from gure   

table   

considers only the relationship between the query image and an individual training data point 
this yields

m

m

in total 

distinct regression problems  each with

training examples

 x j    aij   

the sorting step is justied upon considering the

         

this large matrix could hardly be called a

goal of the learning algorithm 

our objective is to

summary of the image data  thus  haralick computed

maximize the normalized discounted cumulative gain

a feature vector of statistics summarizing the content

 ndcg  from cross validation 

of

p 

ndcg is a widely 

used measure of search performance  first  dene the
contrast

 

x

discounted cumulative gain  dcg  of the

pij  i  j  

ij
correlation

 

x

pij

ij
energy

 

x

 i  i   j  j  
i j

 

x
ij

 

i  
where

pij 

result

ij
homogeneity

dcgj

p
x

yi   arj  i  j is
th
in the j
query 

i   i   j   j

 

are the mean and standard devia 

pi   pj  

 yi   
log   i     
ith

having dened the dcg  the ndcg is simply

pij
     i  j 

tion of the marginal distributions

query as

the relevance score of the

ndcgj
where

j th

respectively 

note that haralick originally dened    dierent texture features  but we list only those used in this work 
we refer the reader to the original article for the interpretation of these features  haralick et al         
as an example  table   shows the four texture features

dcgj

 

dcgj



where dcgj is given by the optimal ranking function
for the

j

th

query 

from here  it is clear that  given

a set of predicted relevance scores  sorting the scores
yields the optimal ndcg 

     regression for optimal ranking

for the lesion from gure   
in the previous section  we described a machine learning approach to ranking using

   learning algorithm

m

distinct regression

problems  in this section  we will formalize the regres 

having described the dataset and features  we will now

sion problem in an attempt to achieve optimal ranking 

formally express the goals of the cbir system  and de 

we will see that  for most datasets  optimal ranking is

rive a machine learning algorithm approximating those

not possible within our framework  and instead strike

goals  section     describes the ranking problem and

a compromise between data delity and ranking sub 

quantication of ranking accuracy  while section    

optimality 

describes a regression algorithm for predicting the relevance scores 

       pairwise distance features
before delving into the specics of the ranking prob 

     ranking overview

lem  we note a useful transformation of the image fea 

having extracted image features  it remains to use machine learning to assign search rankings to a query
point  given a query feature vector  we must generate
a permutation of the vector

            m  ranking the m

training features in terms of relevance to the query 
where

 

is the most relevant and

m

the least 

to this end  we derive the following supervised learning algorithm 

x  predict the
x i    then  comrj  x  by sorting the

given a query feature

tures specic to this application 

given a query im 

age  we wish to predict its similarity to a training image  thus  it is not the image features themselves that
are of interest  but the dierences between them  we
therefore dene a new feature vector as follows 

tures from the query and training images  respectively 

relevance to each training feature

then  the pairwise distance feature vector

pute the search ranking function

puted as

relevance scores 

x

is com 

in the literature  this is known as

the point wise approach to the ranking problem  as it

let

qs   ts  r    be the sift d features from the query
lesion q and the training lesion t  respectively  similarly  let qt         tt    qt         ty be the four texture fea 

x   kqs  ts k     qt   tt    


      qt   tt     

fin

note that this is a nonlinear feature mapping from

where

the

vector of dummy variables  and

    dimensional

dimensional space 

image

feature

space

to

a

  

this mitigates overtting on our

small dataset  furthermore  we have observed no performance loss from this mapping 

 x i    

   rn  r

such that

rankings are ob 

x i  is ranked
 j 
prior to x
if and only if  x      x
   let
       
       
x   y denote the most relevant item  x   y the
second most  etc  in this notation  x is the pairwise
feature vector from section        and y is its corresuch that

 j 

 i 

sponding relevance score with respect to the training image  any solution satisfying the following constraints will produce an optimal ranking 

 x     

let us dissect this algorithm 

 

giving no more than a
termka

the rst term of the

the dummy variables

z

are

sor

 

a

 zk 

  suboptimal

ranking 

the

gives the distance between the regres 

and this

  suboptimal

set 

the parameter



negotiates between the often competing objectives of
data delity and optimal ranking 
this seemingly complicated model can be simplied 
in practice  we replace

 

with

 

as most solvers

do not dierentiate between the two 
if

     

in this case 

the only feasible solution is often

z     

substituting this into the objective  we have

 x     

   
 x n   

is a

constrained to lie within the set of ane regressors

gives an optimal ranking 

tained by ordering

z

are constant pa 

rameters 

dicted relevance scores 

we wish to nd a mapping

 x  

  

objective is just the mean squared error of the pre 

       optimal ranking

 i 

is the number of training examples 

minimize

 x n     

n
 
  x  t  i 
a x   b  y  i    kak 
n i  

   

which is just regularized linear regression  in fact  we

converting to standard form  we have

shall see in section   that our algorithm with reason 

 x i       x i        

ably small



performs essentially the same as regular 

  

this is a convex set if

ized linear regression  note  however  that with

function of the

 x i      x j    is a convex
parameters of  
in the case that

the optimal value of

 x    at x   b 

we have

algorithm is not identical to regularized linear regres 

at x i    at x i 

z

is not necessarily

z     

so the

sion 

   

at  x i    x i       

   results

which is clearly convex 

we computed the performance for a variety of subsamples of the training set  using leave one out cross 

       sub optimal compromise

validation 

the cross validation scheme is as fol 

we have shown in section       that the set of ane

lows  for each round  we withhold one lesion from the

regressors resulting in an optimal ranking of the train 

dataset  then  we train all

ing set is convex  thus  we can quickly nd a regressor

the relevance of a query image to each of the

which optimally ranks the training set  if one exists 

remaining training lesions 

however  this is not so useful in practice  as for most

benet of the withheld lesion  finally  we predict and

datasets with more training examples than feature di 

rank the similarities of the withheld lesion to each of

mensions  there is no regressor satisfying these equa 

the

tions  i e  the set of optimal regressors is empty  to

sults from a single query  from which we compute a

n  

n    regressors predicting
n  
this is done without the

training lesions  this gives the ranking re 

n

avoid this diculty  we must strike a compromise by

single ndcg  repeat this process

allowing some slack in the constraints 

withholding a dierent lesion  the nal performance

in this case 

we would like to dierentiate between sub optimal solutions according to their delity to the training relevance scores  thus  we arrive at the following convex
optimization problem 
minimize
subject to

 
n

pn

i  

times  each time

estimate is the average ndcg over all

n

folds 

the parameters for our algorithm from problem   were

             

we solved the optimization problem

with cvx  a popular modeling tool for convex pro 

at x i    b  y  i 

 

  ka  zk 

z t  x     x        
   
t

z  x

 n  

 x n        

   

grams  grant   boyd        

for comparison  we

computed three additional scores 

the rst is the

worst possible ndcg for this data  averaged over all
folds  computed from the worst possible ranking  the
second is the score from the regularized linear regres 

fi 

in the future  we plan to extend the algorithmic ideas
from section     

ndcg

   

glm
proposed
unsupervised
worst case

   
   
   
  

  

  
  
number of images

we might try adding features  or

mapping features to a higher dimensional space  in an
attempt to produce a less trivial optimal ranking set 
almost paradoxically  optimal ranking is guaranteed
only when the number of parameters equals or exceeds
the number of training elements  a cardinal sin of ma 

  

chine learning 

the problem might be alleviated by

use of a more complicated regressor  but it is challengfigure    mean ndcg for the various algorithms  possible
scores range between the purple line and   

ing to nd one for which the problem remains convex 
another possible avenue of exploration is optimizing
over all regressors simultaneously  in this work we have
penalized the suboptimality of the ranking of a single

sion problem    which is trained by the glmnet li 

regressor  but since the outputs of dierent regressors

brary  with cross validation for the regularization pa 

are directly compared in a search query  should not

rameter

  glm  

this shows the close relationship be 

we enforce optimal ranking across regressors as well 

tween regularized linear regression and our algorithm 

we might also enforce symmetry between regressors 

the third is an unsupervised algorithm  showing the

i e 

benet of supervised learning  the unsupervised rank 

of avenues for exploration  but it is not clear which

ing algorithm simply takes

kxk 

y   exp kxk    

where

estimates the similarity of the query and training

lesion  and

ex

in gure   
in most applications  gure   would be called a learning curve  hopefully showing the benet of an increased training set  however  for each round we rank

n

are both nontrivial  i e 

there is no shortage

more substantial than mere

regularization  and computationally tractable 

is a positive  monotonically decreasing

function  results for all of these algorithms are shown

all

ati xj   bi   atj xi   bj  

training items 

the ranking problem becomes

references
glmnet 

available

at

http   web stanford edu  hastie glmnet matlab  
accessed november   th       
akgul 

ceyhun

burak 

rubin 

daniel

l  

napel 

more dicult as we have more items to rank  and more

sandy  beaulieu  christopher f   greenspan  hayit 

opportunities to rank a highly relevant item far down

and acar  burak 

the list 

in radiology  current status and future directions 

thus  we can see that the ndcg increases

initially  but past the midpoint of the graph the benet
of more training data is outweighed by the increased
diculty of the task 

content based image retrieval

journal of digital imaging                     

de gonzalez a  berrington  m  mahesh  k  kim  and
et al  projected cancer risks from computed tomo 

the results show that supervised learning outperforms

graphic scans performed in the united states in      

unsupervised  although all three results are encourag 

archives of internal medicine                   

ing 

      doi          archinternmed          

our algorithm performs almost identically with

regularized linear regression  a result theoretically explained in section        although they are not technically the same for

     

this investigation could be

used as a theoretical justication for the use of regularization in the ranking problem  despite encouraging
results  we believe better performance is necessary for
clinical usefulness  possible improvements will be discussed in section   

grant  michael and boyd  stephen  cvx  matlab software for disciplined convex programming  version
    

http   cvxr com cvx 

haralick 

r m  

its hak 

     

shanmugam 

k  

and

dinstein 

textural features for image classication 

systems  man and cybernetics  ieee transactions
on  smc              nov       issn           

doi          tsmc              

   conclusions and future work

lowe 

david

g 

distinctive

image

we have extracted image features from a dataset of

from

ct liver lesions  derived a supervised learning algo 

journal

rithm for ranking  and reported the results in a cross 

november

validation framework  results were encouraging  but

        b visi                     

leave room for improvement 

scale invariant
of

keypoints 

computer

     

vision 

issn

features

international

            

          

doi 
url

http   dx doi org         b visi                     

finapel  sandy a   beaulieu  chistopher f   rodriguez 
cesar  cui  jingyu  xu  jiajing  gupta  ankit  korenblum  daniel  greenspan  hayit  ma  yongjun 
and rubin  daniel l  automated retrieval of ct images of liver lesions on the basis of image similarity 
method and preliminary results  radiology         
july      

fi