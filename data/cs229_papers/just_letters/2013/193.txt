a lgorithmic t rading using m achine l earning t ech niques   f inal r eport
chenxu shao   zheming zheng
department of management science and engineering
december         
a bstract
in this report  we present an automatic stock trading process  which relies on a hierarchy of a feature selecting method  multiple machine learning
algorithms as well as an online learning mechanism  backward search was used in feature selection  while the local linear regression  llr   l   
regularized  support vector machine   svm   and the multiple additive regression tree  mart   were chosen as the underlying algorithms  our
trading model is simplified from real life trading  one strength of our approach is that the model  regardless of its many simplified assumptions  is
more sophisticated than many of the reported model which uses simple buy and hold strategies  in addition  applying the online learning mechanism greatly improves the prediction accuracy  the learning results are impressively robust  rendering our process promising candidates for real life
algorithmic trading 

 

introduction

nowadays investors and trading firms have been more aware
of risks than any time in the past due to the non stationary and
chaotic stock markets under the impact of the      financial crisis 
therefore  many firms now rely heavily on algorithmic trading in
the stock markets  especially for high frequency trading  because
of the large amount of information and the importance of instantaneous decisions 
it has always been a challenging task to predict stock prices or
even their trends  our project aims at predicting the short term
pricing trend of selected stocks and simulate the trading results
with a simple strategy  to provide a key reference for improving algorithmic trading and better trading strategies 

   

trading model

in order to model the real life trading  we constructed a simplified trading model which is almost identical to the real life trading 
with several simplifications     only close price is considered  when
selling buying the stock  one would have to pay the bid ask price 
but they are relatively close to the close price  and trading actions
happen each day before closing which is not realistic in real life    
the only transaction cost is the      close transaction fee   and income tax is not accounted  despite these simplifications  the trading model is relatively realistic in that the actual transaction cost is
considered compared to the models used in the literature        

   

total ror  

pvlast day  pvfirst day
pvfirst day

   

the daily return is just the daily growth rate of the money  and
can be calculated from the following formula 
total ror        daily ror   of trading days   

 
   

   

methodology
stock selection

the dataset was downloaded from bloombergterminal with
more than    indicators features  the stock is almost randomly
selected from s p     index components  but we do include two
basic criteria  stock price and volume  higher stock price indicates
that the stock may be a principal component of the index whereas
high volume shows that the stock is traded actively 
in this project  we selected and tested on    stocks from the
s p     index components  they are listed as follows 
table    list of selected s p     index components  tickers only 

concepts and terminologies

we assume the trader has two kinds of assets  cash and stock
shares  the present value  pv  of the traders portfolio  is defined
as the future amount of money that has been discounted to reflect
its current value  as if it existed today  in this specific project  we
assume the risk free interest rate is zero    so the present value is
calculated as 
pv   total cash   total share  stock price

the rate of return  ror   is defined as the ratio of money gained
or lost  whether realized or unrealized  on an investment relative to
the amount of money invested  so  the total return of the portfolio
 i e   the growth rate of the money  is calculated as 

   

aapl

amzn

azo

bac

blk

c

cmg

csco

dal

emc

exc

ge

goog

intc

isrg

ma

ms

msft

nvda

pcln

pfe

schw

t

wfc

wpo

 email  chenxu stanford edu
 email  zheming stanford edu
  assuming the annual interest rate is       then the daily interest rate is roughly           which is negligible

filearning curve of svm

learning curve of lwlr

nov   
nov   

jul   

sep   

jul   

sep   

may   
may   

jan   

mar   
mar   

nov   

    
    
   

   

   

training size

learning curve of logistic regression

learning curve of mart

   

 e  

   

classification error

 e  
   

trading dates

   

   

training size

figure    top  pv v s  time  bottom  stock price v s  time

 e  

 e  

    
    

classification error

    

test error
training error
expected error

    

jan   

nov   

sep   

jul   

may   

mar   

jan   

nov   

sep   

jul   

may   

jan   

mar   

    

   
   

   

usd

   

training size

    

stock price  aapl

   

test error
training error
expected error

   

   

   

   

training size

figure    learning curves of the four models  the underlying stock
here is aapl 

feature construction

the features mainly contain indicators acquired from the
bloomberg terminal  in addition  there are several indicators
constructed with the data  such as sharpe ratio  treynor ratio  etc 
a complete list of features are listed below 

table    list of features used in the model
   day volatility

quick ratio

p e ratio

net change

ebitda





risk premium

earning share

 for 

log ror

benchmark ror

high price ror

low price ror

volume ror

williams r 

pvt

moving average   price

sharpe ratio

treynor ratio

due to the limitation of space  we will not introduce all the indicators features  but note the latter eleven features are calculated
using the acquired data 
the label is constructed with the closing price of the stock  if
the closing price of the next day is greater than that of the present
day  the label is set to    otherwise it is set to be     for  svm  or  
 for regressions  

   

test error
training error
expected error

    

   

 e  

jul   

sep   

may   

jan   

mar   

nov   

jul   

sep   

may   

jan   

mar   

   

trading dates

   

    

classification error

    

 e  

test error
training error
expected error

 e  

    

usd

    

present value  labled  knowing future 

 e  

classification error

 e  

the trading strategy is rather a simple one  knowing or believing that the stock price will grow tomorrow  one would long  buy 
exactly one share of the stock  and one would sell all the holding
shares and short  sell  an extra share only based on the knowledge
or belief that the stock price will decrease tomorrow 
using this strategy in the simplified model  we managed to
achieve a total return of         for     days  for aapl  a pple i nc   
corresponding to a daily return of          provided that the future
stock prices are known 
the predetermined present value as a function of time  as well
as a typical stock price time series  are shown in fig    

tree  mart   mart was chosen because it uses data very efficiently
and good results can be obtained with relatively small data sets  to
determine which model s  to use and if these models have more
bias or variances so that we can tune the model s   a learning analysis was performed  the learning curves of the four models are illustrated as follows 

    

trading strategy

 e  

   

model selection

in the beginning  we considered four kinds of models  support vector machine   svm   locally weighted linear regression  lwlr   logistic regression  and multiple additive regression

cs     f inal r eport

from the learning curves  it can be easily seen that  svm is less
biased and clearly has a large variance  while lwlr  logistic regression and mart are biased  since it is hard to construct more features but easy to reduce the size of features and change the size of
training data  and considering the overall accuracy reflected from
the learning curves   svm and mart were selected as the underlying models  in addition  inspired by the idea of llwr  a local linear regression  llr  was also implemented  based on the belief that
locally the stock price grows linear with time 

   

feature selection

the learning analysis rendered  svm having a relatively high
variance  to tackle this issue  the feature selection was performed 
as the amount of features      is considerably small  instead of using heavy machinery such as mutual information  a simple backward search was performed 
for each of the stock  we leave one of the    features out and
calculate the classification error  then we have    classification errors corresponding to the absence of each of the    features  next 
we determine the     quantile of these errors and remove features
without which the errors drop significantly  within the top     
usually        features are removed using this method 

 

fi   

online learning vs offline learning

to implement the learning algorithms  we first compared the
online learning mechanism versus the offline learning mechanism 
in practice  the data of the stock from april         to december    
     were used as training data for offline learning and for the first
prediction of online learning  their accuracies and recalls as functions of initial training sizes are plotted as follows 

the precision  recall and the accuracy for the llr model are
listed in table    it can be seen that although the accuracy of llr
is not high  which ranges from           but it is quite robust 
with a variance of            in addition  the precision and recall
remain the same level as the accuracy  moreover  although its accuracy is not impressively high  the model maintains positive total
returns  all these features render this model very stable and practical 

   

accuracy of online and offline learning

  

  

table    learning results of llr model on    stocks

  

percentage

  

online learning
offline learning

accuracy

precision

recall

total return

total return  label 

aapl

      

      

      

       

       

amzn

      

      

      

       

       

azo

      

      

      

      

       

bac

      

      

      

     

      

blk

      

      

      

      

       

c

      

      

      

      

      

cmg

      

      

      

       

       

csco

      

      

      

     

      

dal

      

      

      

     

      

figure    accuracy  top  and recall  bottom  curves of the two

emc

      

      

      

      

      

learning mechanisms

exc

      

      

      

      

      

ge

      

      

      

     

      

goog

      

      

      

       

       

intc

      

      

      

     

      

isrg

      

      

      

       

       

ma

      

      

      

       

       

ms

      

      

      

      

      

msft

      

      

      

     

      

nvda

      

      

      

     

      

pcln

      

      

      

       

        

pfe

      

      

      

     

      

schw

      

      

      

     

      

t

      

      

      

     

      

wfc

      

      

      

      

      

wpo

      

      

      

       

       

  

ticker
 

  

   

   

   

pretraining size

   

recall of online and offline learning

  
  

  

  

percentage

  

  

online learning
offline learning

 

  

   

   

   

pretraining size

it can be seen from the above figure that the online learning
mechanism has both higher accuracy and recall than the offline
learning  which is reasonable  as the stock price is stochastic almost surely  the models need to be readjusted actively so that it
catches the new trend feature 
it is also worth noting that for the online learning  when doing
the prediction  we use the stock data at the opening time which is
the beginning of a day and the prediction was performed for the
closing time of a day  at many occasions  there may be correlations
between the opening price and the closing price  which can be one
of the reasons why online learning is much more accurate than offline learning   but generally this strategy is still of practical use as
one can always trade between the opening time and closing time 
based on this result  online learning was then performed with
the subsequent data from january         to november          on
each step  the prediction was made for the current trading date and
the trading actions were performed under the prediction  then the
models were adjusted and retrained for the prediction for the next
trading day 

 
   

results and discussion
local linear regression

the local linear regression was trained with a subset of features
with pvt and ebitda removed due to the large absolute values 
which may cause divergence  for each iteration  the model was
trained with the data from the past few days  three in this case  
and then the prediction is performed  referred as  local learning 
in the later text  

 

the present value curses of aapl using this model and predetermined label are plotted in fig     the present value grows
with time  but is quite slow compared to the predetermined present
value  in addition  it has many kinks  due to the many failures of
predicting the trend of the future price  the total return of the trading strategy with this model is        for aapl  corresponding to
a daily return of          which is much lower than the predetermined returns  in general  the total return with llr model is always
much lower than the predetermined returns as listed in table   
despite the many issues  the llr model managed to reach a
positive returns for all    stocks for     days  and due to its simplicity   easy to implement  and speed   fast to train and predict   it
can be a very powerful tool in high frequency trading 

cs     f inal r eport

fipresent value  local linear regression model

present value  svm model

    

nov   

jul   

sep   

may   

jan   

mar   

nov   

jul   

sep   

may   

jan   

mar   

nov   

jul   

sep   

may   

jan   

trading dates

mar   

nov   

jul   

sep   

may   

jan   

mar   

nov   

jul   

sep   

may   

jan   

mar   

nov   

jul   

sep   

may   

jan   

mar   

    

usd

    

svm model
labeled

    

usd

local lr model
labeled

trading dates

figure    left  pv of llr  compared to the labelled pv  right pv of svm  compared to the labelled pv  the underlying stock here is aapl 

     support vector machine
the l    regulated  svm  c             with laplace radial
basis function  rbf  kernel  was trained with a subset of features
using feature selection  e g   in the case of aapl  the four features 
benchmark ror  volatility  ebitda and  for  were removed from
the feature set   the precision  recall and the accuracy for the svm model are listed as follows 

table    learning results of svm model on    stocks

ticker

accuracy

precision

recall

total return

tot  ret   label 

aapl

      

      

      

       

       

amzn

      

      

      

       

       

azo

      

      

      

       

       

bac

      

      

      

      

      

blk

      

      

      

       

       

c

      

      

      

      

      

cmg

      

      

      

       

       

csco

      

      

      

      

      

dal

      

      

      

      

      

emc

      

      

      

      

      

exc

      

      

      

      

      

ge

      

      

      

      

      

goog

      

      

      

       

       

intc

      

      

      

      

      

isrg

      

      

      

       

       

ma

      

      

      

       

       

ms

      

      

      

      

      

msft

      

      

      

      

      

nvda

      

      

      

      

      

pcln

      

      

      

       

        

pfe

      

      

      

      

      

schw

      

      

      

      

      

t

      

      

      

      

      

wfc

      

      

      

      

      

wpo

      

      

      

       

       

clearly  the  svm model has a very high accuracy  and good
precision and recall as well  compared to llr model  the accuracy

cs     f inal r eport

is significantly higher  as can be observed from the present value
curve in fig    the present value grows with time in a linear fashion  which is quite reasonable assuming the price change of the
stock is nearly constant  thus with our trading strategy the amount
one earns everyday is also nearly constant provided the prediction
is correct  although not obvious  it can be seen that the performance of the model is not very good near a sudden change of price
trend  known as  change point   which is either a local optimum 
or jump  
the  svm model proved to be a very stable and powerful tool
to predict stock price trend and together with the trading strategy  it
managed to reach relatively high returns  it is worth noting that for
different stocks the parameter  and selected features are slightly
different  and tweaking the parameters and performing  svm algorithm takes longer time than simply doing the linear regression 
hence  although  svm is more accurate  it is not as efficient as
llr 

   

multiple additive regression tree

the precision  recall and the accuracy for the mart model are
listed in table    it is observed that the accuracies and recalls fluctuate a lot  whereas the precisions remain a very high level  although the averaged accuracy is       its variance is         
which is almost    times larger than that of llr and  svm  indicating that the performance of this model varies greatly 
moreover  the total return of this model can even be significantly negative when the accuracy is actually high          see
intc and isrg   this is because mart has a very poor recall  so
that most of the time the trader is losing money by short selling the
stock shares  which can cause significant loss when the trader is
holding many shares in hand 
the unstable performance and the negative returns of mart
reveal its disadvantages  first  its outputs of regression can lie outside of the range        which would be classified as incorrect prediction  second  its extrapolation properties tend to be poor  which
may cause the performance to be unstable  last  it is very sensitive
to outliers  which further brings down the prediction accuracy 
in addition to this  it takes many iterations for mart to converge  the total number of iterations required for convergence
varies from             performing hundreds of iterations costs a
relatively large amount of time which is another disadvantage of
this method  therefore  it is not only less stable compared to svm and llr  but less efficient than the two models 

 

fitable    learning results of mart model on    stocks

ticker

accuracy

precision

recall

total return

tot  ret   label 

aapl

      

      

      

       

       

amzn

      

      

      

       

       

azo

      

      

      

       

       

bac

      

       

     

      

      

blk

      

      

      

       

       

c

      

       

      

      

      

cmg

      

      

      

       

       

csco

      

       

      

     

      

dal

      

       

      

      

      

emc

      

       

      

      

      

exc

      

       

      

      

      

ge

      

       

      

      

      

goog

      

       

      

       

       

intc

      

       

      

     

      

isrg

      

       

      

       

       

ma

      

      

      

       

       

ms

      

       

      

      

      

msft

      

       

      

      

      

nvda

      

       

      

      

      

pcln

      

       

      

       

        

pfe

      

       

      

     

      

schw

      

       

      

      

      

t

      

       

      

      

      

wfc

      

       

      

      

      

wpo

      

       

      

       

       

the performances of the three methods are summarized as follows 

table    performance of different models
model

avg  accuracy

avg  learning time

have negative returns

llr

      

    s

no

 svm

      

     s

no

mart

      

    min

yes

 note this is only a rough estimation based on observations 

as a result   svm has the best overall performance  the time it
used to learn and predict makes it best for daily trading  llr turns
out to be very stable and efficient  which can be used to assist high
frequency trading  mart  which has a good average performance 
is highly unstable and relatively slow in learning and predicting 
and thus not suitable for algorithmic trading 

   

further analysis on online learning

notice that from the learning curve we can see that the accuracy       test error  of linear regression ranges from     to    
  whereas the actual averaged accuracy of llr is         which
is higher  this is due to the advantage of online learning and local learning  since the belief that the stock price is locally linear

 

 but not globally   local learning should improve the quality of the
prediction  moreover  the online learning technique enables the
model to evolve with time  so that it was adjusted and better for the
next prediction 
in addition  for  svm  its accuracy varies from           by
the learning curve  whereas the actually averaged accuracy of online learning turned out to be          which is a number in between  this is because although the online learning technique enables the model to adjust itself with time  its variance is certainly
larger than the offline learning as it always have no less training
data than the offline learning  which may reduce the accuracy 

 

conclusion and future work

in conclusion  we have developed a process flow of automatic
trading using machine learning techniques  feature construction 
feature selection  and model selection were studied in detail  the
online learning and offline learning mechanisms were also compared and discussed  the averaged prediction accuracy for the local linear regression model turned out to be        whereas that of
the  support vector machine turned out to be         thus showing our process a good candidate for algorithmic trading 
noting that  support vector machine usually fails to predict
correctly when the data point is close to a sudden change which
is almost random seen from the data itself  and that the information of a sudden change in stock price trend may be included in
the text information such as daily news  it is believed that a further
step would be to investigate the usage of text mining techniques
to assist the machine learning process proposed in this project 
furthermore  it is noted that improving the learning speed of support vector machine as well as the efficiency of the code overall
is needed  finally  the real time tests of the system as well as bringing more complexities  such as considering more realistic transaction costs  is necessary 

 

acknowledgement

we would like to thank professor andrew ng for teaching this
great course of machine learning  indeed  we enjoyed the class very
much  the materials and knowledge we learned from this class is
very practical and useful  and we have already put what we learned
into practice  we also thank alex yuqing dai  for assisting us in
downloading the stock data from the bloomberg terminal and
for the many discussions he had with us 

references
    https   usequities nyx com markets nyse equities trading fees
    dempster  m a h   leemans  v  expert syst  appl            
       
    fung  g   yu  j   lam  w  advances in knowledge discovery and
data mining  springer berlin heidelberg         
    debbini  d   estin  p   goutagny  m  modeling the stock market
using twitter sentiment analysis

cs     f inal r eport

fi