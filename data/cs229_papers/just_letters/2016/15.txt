modeling malicious network packets with generative probabilistic
graphical models
ashe magalhaes
ashemag cs stanford edu
abstract cyber enterprise systems often are difficult to
protect due to a large number of sub components that must
work in concert to remain resilient  in cyber enterprises where
incoming traffic may approach a few megabits per second  an
ids and host system controlled by a markov decision process
may serve as an efficient resiliency solution  however  the
structure of this model leverages very little information about
the adversary  for example  attack signatures of well known
attacks and the behavior of previous packets are not considered
when the system decides if a network packet is malicious or
normal 
in this paper  we attempt a first step to augmenting such a
resiliency system by learning about adversary behavior through
modeling malicious packet data with a probabilistic graphical
model  we examine the effects of weakening the markov
assumption on the behavior of an adversary  and investigate
how well this markov adversary model is borne out in real data
for four different cyber attack types  finally  we investigate how
well our model captures intrinsic characteristics of malicious
behavior by using log likelihood scores of various attack models
to train a discriminative classifier  we find that our classifier
is able to attain anywhere from     to     classification
accuracy  a strong indicator that our generative models have
successfully captured the distribution of features and behaviors
that comprise a malicious adversary vs  a benign one 

i  introduction
technological advances such as high speed backbones 
local area networks  and wireless technology have created
a dynamic network of systems which have become mission
critical for governments  companies  and institutions      in
recent years  a number of high profile attacks on cyber infrastructure have inspired a considerable amount of research
into enhancing traditional protection mechanisms      to
reduce dependency on security experts  projects have used
data mining and machine learning techniques to obtain the
automatically learn and respond to common attack signatures
     this paper focuses on the problem of protection for
a cyber enterprise  which consists of an elaborate web of
applications  software  storage  and networking hardware 
these systems have difficulty keeping up with incoming
network traffic which excludes a few megabits per second 
a  intrusion detection systems
an intrusion detection system  ids  is often deployed as
a primary component for enabling security and resiliency
within industrial control systems  its objective is to detect
ongoing intrusive activities in computer systems and networks  an ids searches for evidence of malicious behavior
by analyzing one or more event streams  events may be
represented by network packets  operating system calls  audit

gene lewis
glewis   cs stanford edu
records produced by the operating system auditing facilities 
or log messages produced by applications      when an
attack is detected  the ids produces an alert that describes
the type of attack  a false positive warning occurs when
normal network behavior is labeled as an attack  a false
negative warning occurs when malicious network behavior
is not detected  consequences of false positives include reduced system availability and a subsequent disregard of ids
warnings  consequences of false negatives include reduced
trust in the ids and damages caused by the attacker     
b  cyber enterprises as a markov decision process
the problem of maintaining a secure and reliable enterprise can be addressed with a markov decision process
 mdp  model of a host and ids system      resilient cyber
infrastructure can be defined as the ability of a system to
continue to function  though possibly in a degraded manner 
in the face of behaviors that affect the proper operation of
some of its components      modeling the system as a mdp
allows for the incorporation of rigorous definitions for state
awareness and operational resiliency in our modeling of realtime control systems 
the evaluation of such mdp systems requires examining the expected utility frontier for policies obtained from
varying the model parameters  however  varying all model
parameters over all possible values does not accurately reflect
the behavior of the mdp system in handling real world
malicious network packets 
in order to augment the analysis of the mdp controller 
we can leverage information about the adversary through
generative probabilistic graphical models  this achieves the
dual purposes of generating data to better categorize attack
types as well as incorporating the generative models into the
mdp system to boost resiliency 
c  related work
while controller based autonomous systems has been implemented widely for applications in defense      sensor
networks      and power management      to name a few 
this paper builds on a novel approach to modeling an ids
and host as an mdp controller      the connection between
anomaly detection and probabilistic graphical modeling has
been shown to provide robust operational solutions          
the contribution of this paper to the existing literature
is to provide further exploration of the insight generative
probabilistic graphical models yield into the behavior of
adversaries in the context of cybersecurity  our work diverges

fiacting maliciously  the observed states that of the adversary
are independent  a packet is then generated from the corresponding distribution  as described above  to estimate the
probability of an adversary acting maliciously  we calculate
the maximum likelihood estimate 

fig     example of mdp controller  controller has actions ai and ah  
action ai encodes the action space of the ids  i e  whether to pass or drop
a packet   action ah encodes the action space of the host  i e  whether to
wait for a packet or reset      

from those cited in its reliance on supervised learning as a
means of modeling types of attacks 
ii  models
a  packet model
we collect a total of    different features for each packet 
ranging from duration to protocol type to the number of files
accessed  we model each continuous variable as a gaussian
distribution and model each discrete variable as a multinomial distribution  furthermore  we model the bayesian
network of packet features with a naive bayes model  given
the observed state of the adversary  the distributions for
each of the packet features are independent of each other 
our packet generation procedure creates a new packet by
sampling each of the    packet features from their respective
distributions  conditional on if the adversary choose to act
normally or maliciously  to fit the parameters for each
distribution  we calculate the maximum likelihood estimates
for each parameter 

fig    

naive bayes adversary model

c  adversary markov model
as an improvement on our baseline approach  we break the
naive bayes assumption to capture more complex stochastic
dynamics of adversary actions over time  in this model 
each observed state of the adversary is dependent on past
t observed states  where t is the number of previous
time steps that influence the current state  for example 
t     gives the standard markov assumption that the
current state is only dependent on the previous state  the
transition probability for the adversary is given by a t tensor  where each dimension has size   and each entry
gives the probability of transitioning to the next state given
the current and previous t states  to estimate the entries of
the probability tensor we calculate the maximum likelihood
estimates 

fig    

markov adversary model

iii  experiments
a  dataset

fig    

naive bayes network packet model

b  adversary naive bayes model
as a baseline approach  we model the adversary as a
naive bayes model  given the probability of an adversary

the maximum likelihood estimation of our model parameters relies on the nsl kdd dataset       due to the
confidential nature of network attacks  there are few publicly
available data sets for network based anomaly detection systems      since       kdd cup has been the most widely
used dataset for the evaluation of anomaly detection methods
      researchers mahbod tavallaee  ebrahim bagheri  wei
lu  and ali a  ghorbani created a data set  nsl kdd  to
address the shortcomings of kdd  specifically  the advantages of nsl kdd over kdd include the following 

fiit does not include redundant records in the train set so
the classifiers will not be biased towards more frequent
records
 the performance of the learners are not biased by
the methods which have better detection rates on the
frequent records
 the number of records in the train and test sets are
reasonable  which allows for experiments on the complete set  consequently  evaluation results by different
research works will be comparable      
consequently  nsl kdd has been carefully constructed to
be representative of existing real networks 
we group our attacks into four types      
   denial of service attacks  dos 
a dos attack is a type of attack in which the
adversary makes a computing resource too busy to
serve legitimate networking requests  this denies
users access to a machine  examples of dos attacks
within the dataset include local area network denial
 land   neptune  ping of death  pod   smurf  and
teardrop attacks 


   probe attacks
a probe attack is a type of attack in which the
adversary scans a machine or a networking device in
order to determine vulnerabilities that may later be
exploited  this technique is commonly used in data
mining  examples of probe attacks within the dataset
include portsweep  nmap  ipsweep  and satan 

fig    

network packet types in nsl kdd dataset

for    t      we then calculate the log likelihood of the
data given our learned model and use this as an evaluation
metric for the appropriateness of fit  below we have plotted
the log likelihood scores for each type of attack normalized
against the maximum log likelihood achieved by that attack
model  this allows us to examine the effect of t on each
model relative to each other 

   remote to user attacks  r l 
a remote to user attack is a type of attack in which
the adversary sends packets to a machine over the
internet which s he does not have access to in order
to expose the machines vulnerabilities and exploit
privileges which a local user would have on the
computer  examples of r l attacks in the dataset
include imap  spy  phf  multihop  and guessing the
password 
   user to root attacks  u r 
a user to root attack is a type of attack in which the
adversary starts off on the system with a normal user
account and attempts to abuse vulnerabilities in the
system in order to gain super user privileges  examples
of u r attacks in the dataset include perl  buffer
overflow  and rootkit      
b  training
prior to training  each packet was converted to feature
space and processed so that all discrete valued features instead take on integers  we next implement each of our attack
types  dos  probe  r l  u r  as a markov model and learn
the model parameters via maximum likelihood estimation as
described above  in order to analyze the dynamics of the
past t adversarial states  we fit each of the above models

fig    
normalized log likelihood of attack types vs  number of
timesteps

c  testing
to examine the appropriateness of fit of the attack models
from a different perspective  we fit a discriminative classifier
using the log likelihood responses of our attack models and
then measure the classifiers ability to discriminate between
malicious and non malicious packets  the intuition behind
this procedure is that an attack model should score a malicious data packet of the corresponding attack type as more

fifig     log likelihood for malicious and normal packets for different
attack types vs  number of timesteps

fig    

raw log likelihood of attack types vs  number of timesteps

likely than a normal data packet or a malicious data packet
of a different attack type  e g  a packet with the signature of
a dos attack should be scored highly by the dos model and
low by the probe  u r  and r l models  
we first trained markov models for each of the four attack
types for varying degrees of markov steps from t     to
t       we then converted two sets of       and      
data points into vectors xi  r    where each feature in a
given xi is the log likelihood score of the data point from
one of the four different attack models  we then trained
an svm classifier with an radial basis function kernel     
on these four dimensional vectors and made predictions
on validation data of size     of the training data  our
validation accuracies are given in the figure below 
iv  analysis
we note that during training most models achieve a
maximum log likelihood score with t     or t      with
average likelihood score decreasing for larger t   this implies
that most packet signatures are primarily influenced by the
previous   or   packets  where modeling probabilities for

fig    

svm validation accuracy for predicting malicious data

longer timesteps leads to a model with too few independence
assumptions that overfits the data  this result is intuitive  as
we would expect certain time dependent attack types such
as denial of service to be better modeled and predicted by
a model that takes into account extended time dynamics  we
also note that the true log likelihood score of each attack
model is proportional to its representation in the data set 
and so our model for a given attack type is only as robust
as this proportion 
during testing  we noted that our svm classifier trained on
log likelihood scores performed surprisingly well  correctly
classifying anywhere from     to     of             validation examples  we note a particularly surprising result  in
which our classification accuracy decreases as the number of
markov steps our attack models were trained with increases 
this result at first seems to contrast with our training results 
in which our models attain a maximum log likelihood of the
data around t      however  as figure   shows  we find
that the difference in average log likelihood response of our
models to malicious packets is at a maximum at t    
and decreases as t moves to     stated differently  the loglikelihood responses of each model to malicious vs  normal
data begins to converge as the number of previous timesteps
considered increases  thus  our likelihood scores contain the
most discriminative power at t      which coincides with
our classification accuracy results 
v  conclusion
in this work  we have constructed a generative probabilistic markov model of four different attack types  fitting
the parameters of the corresponding distributions from the
data  we found that changing the time dependence of the
markov model had a strong influence of the appropriateness
of fit of the model  in general reaching a maximum when
considering the previous five timesteps  we also showed that
the average log likelihood response of our models between
positive and negative examples generally converges  suggesting the discriminative power of the models drops as we
consider more timesteps  finally  we also showed that fitting

fia discriminative classifier with the collective log likelihood
scores of our models generally achieves very good accuracy
and supports the claim that our models do indeed capture
much of the intrinsic structure differentiating an adversarial
model from a malicious one  along with the behavior of such
an adversary in choosing states  future includes investigating
how we can further leverage these models by incorporating
them into an mdp resiliency system or intrusion detection
system as discussed in the introduction 
acknowledgments
the authors thank professor mykel kochenderfer  vineet
mehta  and paul rowe for their consistent support and
inspiration  the authors also thank dr  arash habibi
lashkari from the iscx research center  unb  canada for
sharing the nsl kdd dataset 
r eferences
    valeur  fredrik  et al  a comprehensive approach to intrusion detection alert correlation dependable and secure computing  ieee
transactions on                    
    melin  alexander m   et al  a mathematical framework for the
analysis of cyber resilient control systems resilient control systems
 isrcs         th international symposium on  ieee       
    yu  zhenwei  jeffrey jp tsai  and thomas weigert  an adaptive
automatically tuning intrusion detection system acm transactions
on autonomous and adaptive systems  taas                
    gowadia  vaibhav  csilla farkas  and marco valtorta  paid  a
probabilistic agent based intrusion detection system computers  
security                     
    vineet mehta  paul rowe  mykel kochenderfer  cost optimal cyber
resilience analysis for an intrusion detection system  unpublished 
    choudhury  sutanay  et al  action recommendation for cyber resilience proceedings of the      workshop on automated decision
making for active cyber defense  acm       
    armstrong  derek  et al  a controller based autonomic defense system  darpa information survivability conference and exposition 
      proceedings  vol     ieee       
    panangadan  anand  syed muhammad ali  and ashit talukder 
markov decision processes for control of a sensor network based
health monitoring system  proceedings of the national conference on
artificial intelligence  vol      no     menlo park  ca  cambridge 
ma  london  aaai press  mit press             
    qiu  qinru  and massoud pedram  dynamic power management
based on continuous time markov decision processes  proceedings
of the   th annual acm ieee design automation conference  acm 
     
     ferragut  erik m   et al  automatic construction of anomaly detectors
from graphical models  computational intelligence in cyber security
 cics        ieee symposium on  ieee       
     mccusker  owen  et al  a combined discriminative and generative
behavior model for cyber physical system defense  resilient control
systems  isrcs         th international symposium on  ieee       
     nsl kdd dataset  http   www unb ca research iscx
     tavallaee  mahbod  et al  a detailed analysis of the kdd cup   
data set proceedings of the second ieee symposium on computational intelligence for security and defence applications            
     kdd dataset  http   kdd ics uci edu databases kddcup   kddcup   html
     paliwal  swati  and ravindra gupta  denial of service  probing  
remote to user  r l  attack detection using genetic algorithm 
international journal of computer applications              
     f  aleserhani et al  evaluating intrusion detection systems in high
speed networks  in  fifth international conference on information
assurance and security       
       dacier m  design of an intrusion tolerant intrusion detection system 
tech  rep  d    ibm zurich research laboratory       
     kochenderfer  mykel j   christopher amato  and hayley j  davison
reynolds decision making under uncertainty  theory and application 
mit press       

     park  jooyoung  and irwin w  sandberg  universal approximation
using radial basis function networks  neural computation            
        

fi