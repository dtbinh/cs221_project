material decomposition using neural network
for photon counting detector
picha shunhavanich
department of bioengineering  stanford university  stanford ca      
introduction
most current ct systems use energy integrating detectors  eids   which detect total energy over a period
of time  so  the energy information of each photon is lost in this process  in contrast  photon counting
detectors  pcds  detect individual photons and discriminate them into multiple energy bins  from this
energy information  pcds gain an improvement in ct image quality  provide better tissue
characterization  eliminate electronic noise  and improve the detective quantum efficiency  dqe   a
major problem with pcds is the slow count rate  resulting in count rate loss  photons arriving too close in
time are recorded as only one event  and pulse pileup  detected energy of that event is incorrectly higher
or lower       other non idealities of pcds include charge sharing and k escape      these effects cause
spectral distortion  which impairs material decomposition accuracy and thus degrades reconstructed
image quality  several works have been proposed to compensate for the distortion including analytical
model        and a table methods      however  their performance is detector specific and still could be
improved  in this work  we propose to use neural network to help estimate basis material thickness from
distorted spectra 

spectrum
an x ray beam has a range of energy  spectrum is the number of x ray photons as a function of energy 
the example spectra are shown in figure    in photon counting detector  the spectrum is divided into
energy bins  and the number of photon counts in each energy bin is detected  in other words  if  for
example  the energy bins are       kev  and    kev    kev   the total number of photons having energy
less than   kev and the total number of photons having energy between    and    kev are measured  in
this work  we assume   energy bins with energy      kev         kev         kev           kev   and
        kev   these energy thresholds are chosen such that the number of photons in each energy bin is
relatively equal for the detected spectrum with   cm of water and   cm of calcium 

figure    example comparison of spectra incident on detector  blue  and spectra detected after pulse
pileup effect  green   no object is placed in the x ray beam path  left   and  cm of water and   cm of
calcium are placed  right  

fineural network
the input data    is defined as follows 
    log  

 
   

 

where   is the number of detected counts in energy bin j  and     is the number of count detected in
energy bin j for air scan 
thus  the number of nodes in the input layer is    corresponding to one bias and the   element of  
x ray source

  
  

  

  

  

  
  

detector

    

figure    schematic diagram of the process for calculating the input of the neural network model 
the output data is the thickness of two basis materials  water and calcium   corresponding to the two node
of the output layer of the network  a neural network with either one or two hidden layers is chosen  for
the two hidden layer network  if we let      be the activation in layer l 
      
      

 

 


 

 



 

 

            

 



      

 

 

 

 

 

  
  
  
  
  
  

 

  
  
  
  
  
  

  
  
  
  
  
  

  
  

figure    schematic diagram of neural network
where    is a sigmoid function  applied element wise in this case   
controlling function mapping from layer l to l   

 

is a matrix of weight

the cost function employed is
 
   
 
where  

 

 

 

 

 

   
       

 
 

           


 

  

 

 

     

  for i         m are training examples 

the optimized    s are acquired from minimizing the above cost function with trust region algorithm 

fisimulations
forward projections of two phantoms are acquired assuming fan beam ct geometry over     views 
both phantoms are water with   inserts of calcium varying in density from   to       g cm   the
difference between the two phantom are in shape and size as shown in figure    the cylindrical shaped
one is used for training  while the other is used for testing  the equivalent thickness of water and calcium
along each projection is known 
the measured spectra are distorted using our implementation of an analytical model of pulse pileup
effect     the maximum true count rate is assumed to be  x    counts s mm   poisson noise is
additionally added 
phantom

water  thickness cm 

calcium  thickness cm 

testing  data

training  data

projection

figure    training data  top row     cm cylindrical water phantom with of  cm calcium inserts 
testing data     x   cm water phantom with    x   cm calcium inserts 

experimental methods
number of elements in hidden layer
different number of elements    to     in hidden layer was tested for network with one hidden layer  a
hold out cross validation was performed using the      examples randomly chosen from the projection
measurements of the training phantom  the number of elements that results in the minimum empirical
error on the hold out cross validation set would be chosen 
number of hidden layers
the network of one hidden layer with no regularization term in the cost function was compared with the
network of two hidden layer with regularized cost function  for the two hidden layer network  the
regularization parameter  and the number of elements in hidden layer are arbitrarily chosen to generate
initial results  the water  and calcium equivalent density images are reconstructed from the predicted
thicknesses in each projection using filtered backprojection algorithm  the water and calcium densities
bias are calculated from the following equation and are compared 
                         
where          is the average value in region of interest  roi  in the reconstructed density
images  the roi for water density is placed at the center of the phantom  while the one for calcium
inserts are placed at the corresponding inserts location 

experimental results
number of elements in hidden layer

fi   elements in hidden layer result in the lowest error on the cross validation set and lowest average
absolute calcium thickness error as displayed in figure    thus  this number of elements is chosen 

figure    empirical error on the hold out cross validation set  left  and average absolute thickness of
calcium  middle  and water  right  
number of hidden layers
as shown in figure    the percent thickness errors for both water and calcium are high at low true
thicknesses for both networks  for equivalent density images  the two hidden layer network has
observable error at the four corner of phantom in the calcium equivalent density image  the water
density bias is         and         for the one  and two  hidden layer network  respectively  the overall
calcium density bias is higher  more negative  in the network with two hidden layer than the one with
one hidden layer 

figure    the results of network with one hidden layer  number of elements of hidden layer        left 
and with two hidden layers  number of elements in each hidden layer               right 

ficonclusions
simulations show that neural network is a good alternative to material decomposition for photon counting
detector projection data with pulse pileup effect  the full capability of this approach can be further
investigated with more parameter value fine tuning and larger data set 

references
    taguchi  katsuyuki  et al   an analytical model of the effects of pulse pileup on the energy spectrum
recorded by energy resolved photon counting x ray detectors   medical physics                        
    taguchi  katsuyuki  and jan s  iwanczyk   vision        single photon counting x ray detectors in
medical imaging   medical physics                      
    cammin  jochen  et al   a cascaded model of spectral distortions due to spectral response effects and
pulse pileup effects in a photon counting x ray detector for ct   medical physics                     
    alvarez  robert e   estimator for photon counting energy selective x ray imaging with multibin pulse
height analysis   medical physics                        
    zimmerman  kevin c   and taly gilat schmidt   experimental comparison of empirical material
decomposition methods for spectral ct   physics in medicine and biology                   
    touch  m   et al   novel approaches to address spectral distortions in photon counting x ray ct using
artificial neural networks   spie medical imaging  international society for optics and photonics       

fi