new fast kalman filter method
hojat ghorbanidehno  hee sun lee

   introduction
data assimilation methods combine dynamical models of a system with typically noisy observations to obtain estimates of the state of the system with time  when
these dynamical and observation models are linear  the
kalman filter  kf  algorithm gives the best estimate in
a least square sense  kalman         however  for the
large number of unknowns of such large systems  kf
methods are impractical  because updating the huge covariance matrix is computationally expensive  low rank
approximation methods have been devised to overcome
this problem  such methods assume a low rank of the
covariance matrix  which they approximate by smaller 
full rank matrices  the approximation error is small for
smooth functions  but may be larger for more complex
physical problems  leading to filter divergence and inaccurate state estimates 
we present a new algorithm that utilizes the exact covariance matrix avoiding the approximation error  we
call it speckf for now   and does so in a computationally efficient way  even for systems with large numbers of unknowns  the computational speed up of the
speckf is achieved by updating small cross covariance
matrices instead of large covariance matrices  the benefit can be considerable  especially in large systems  because the computational complexity of speckf scales
linearly with the number of unknown  as opposed to the
kf that scales quadratically  we investigate the accuracy and performance of the speckf for a diffusion case
with random perturbations  our results show that the
speckf provides high accuracy at a smaller computational cost than the ensemble kalman filter  which is a
very popular kf variant  
the kalman filtering process has two steps   i  the
prediction of the state at time tk   using the forward
model and the current estimate at time tk   and  ii  the
update of the predicted state at time tk   based on newly


email addresses  hojjatgh stanford edu  hojat
ghorbanidehno   hslee   stanford edu  hee sun lee  
preprint submitted to elsevier

available measurements  consider a state estimate
vector sk  rm and a vector of noisy measurements
zk  rn at time tk   the kalman filtering process
is given in the following recurrence  f  forecast  a 
analysis  
prediction forecast 
f
sk  
  fk   sak

  a 

f
t
  fk   pak fk  
pk  
  qk  

  b 

update analysis 

 
f
t
t
kk     pk   hk  
hk   pk  
hk  
  rk  

  c 



f
f
sak     sk  
  kt   yk    hk   sk  

  d 

f
f
pak     pk  
 kk   hk   pk  

  e 

the speckf updates cross covariances instead of covariance matrices p f and pa    and makes this possible
for arbitrary forward models by means of a forward
model approximation  this approximation brings about
a small and controllable approximation error  the computational cost of estimation with our method is reduced
from o nm    to o n  m   n  number of measurements 
m  number of unknown   which can be a dramatic decrease  especially for large systems where n  m  as
a result  our method can handle a large number of unknowns in a computationally efficient way  both in terms
of storage and computational time 
   derivation of method
the implementation of the kf algorithm for large
scale systems becomes infeasible  because of the high
storage cost and computational cost of the matrix operations outlined in equations   b  to   e   involving several multiplications of m  m matrices when updating
the covariance matrix p  in our method  we modifying the recurrence matrix operations such that only the
m  n cross covariance matrices  such as ph t   pa h t
december         

fiand pf   pf t h t   are stored and updated at every
time step  this modification takes advantage of the
kalman filter recurrence to calculate products of big
matrices like ph t without explicitly having to construct
and multiply the individual matrices  this is achieved
by multiplying equations   b  and   e  by appropriate
jacobians to obtain 
f
pk  
h t   fpak f t h t   qh t

pak   h t

 

f
pk  
ht



f
kk   hpk  
ht

   
figure    purturbed solution after      steps
   

however  after the above modifications  equation    
still involves the product pf t h t   which is computationally intractable for large m  expanding this term and
using equations   b  and   e   we obtain 

f
   i  kk    pk  
f t ht
 i  kk   h  fpak f t f t h t

f
sk  
  fk   sak

t k    
sak  
f
pk  

  qf t h t  

   
h
pk  

it becomes apparent that while equations     and    
can be used to update the cross covariances using the
recurrence rather than direct matrix vector multiplication  the term fpf t f t h t negates this benefit as it involves terms that are equally expensive to compute  to
overcome this  we proceed by discretizing the forward
model f in time with a taylor series 
f  i    f t dt   o dt  
 

  a 
  qh

t

kk     t k    ht k     r 

pak   f t h t
 

fk   pkf

  b 
 

f
sk  

  c 

f
 
  kk    zk    hsk  
 
h
   i  kk   h  fk   pk
t
t
   fk   pkf   qfk  
hk  
    o  t     

  d 

   i  kk   h t k  

  f 

  e 

   validation
in order to validate the speckf implementation  we
compare it to the results obtained from the original kf
algorithm  the difference between the two indicates how
significant is the combined error of the forward model
approximation and the low rank approximation of q 
which are the two sources of error in the speckf algorithm  the benchmark problem we use is the linear
diffusion equation in a two dimensional unit domain 
                where the state  pressure  is contaminated
with random noise 

   

where  f t is the jacobian of f with respect to t  using
the above  we obtain the following 
t
t
pf t f t h t   pak h t    pak fk  
hk  
  p  f  i    t h t
   
where  f  i    o   fk  t dt      as a result  for a small
dt between data assimilations in the kalman filter  the
error introduced by neglecting the last term of equation
    is expected to be small  however  since this approximation is used only once within the algorithm  i e  the
full forward operator f is used in all other calculations
except in the expansion of equation       depending on
the non linearity of the problem  the error introduced by
this forward model approximation will likely not affect
the results of the filter significantly 
using the above and defining the new matrices t k    
f
h
f
pk  
h t   pk  
  pak   h t   and pk  
  pak   f t h t   the
speckf algorithm can be summarized by the following
recurrence 


  d     noise
   
t
in equation      d represents the diffusion coefficient
which is assumed to be spatially and temporally constant  discretizing equation     using explicit euler in
time and central difference in space  we obtain 

dt   k 
 k 
i    j    k 
i  j   i   j  
 
 dx 
 
dt   k 
 k 
i  j      k 
  dt w k 
i  j   i  j   
i  j
 
 dy 

i  k   
   k 
j
i  j  

 

   

fiwhere w is noise that represents various small and erratic sources and sinks over
 the domain with zero mean
and covariance matrix of   dtq  in this problem q is
selected from the gaussian family of covariance funcx x
tions where qi  j   exp   i l j       equation   is solved
for a        grid resulting in m         excluding the
boundaries   with a discretization dx   dy         with
dirichlet boundary conditions at all boundaries and initial      throughout the domain except at boundaries 
for time discretization  a dt       is chosen  to satisfy
the numerical stability requirement dt         there
are    point observations uniformly distributed in the
unit domain  with observation error covariance i      
figure   shows the distribution of  after      time
steps  indicating the distortion of an otherwise smooth
field due to the noise added 
in addition to the comparison to the kf results for
validation of the speckf  the diffusion problem is used
to conduct error analysis and evaluate the computational
efficiency of the speckf compared to both the kf and
the enkf 
figure   shows the estimates obtained with speckf
at time step       comparison to figure   indicates that
the speckf results provide high accuracy 

 a 

 b 

figure    a  relative difference between speckf and
kf estimates with time b  absolute difference between
speckf and kf estimations at time step     

the time step taken is small  for numerical stability purposes as outlined previously   and since the error of the
forward model approximation is second order in time 
the contribution of the low rank approximation of the
q matrix is also included in this error  it should be mentioned that in this problem the speckf provides estimation with the same accuracy as the kf method  while
the computational cost of speckf is much smaller than
the computational cost of kf method  specially for the
cases with large number of unknowns  figure    

figure    speckf estimation at time step      

figure    comparison of time taken by full kf and
speckf methods for different number of unknowns

comparison to the kf results  figure    shows that
the difference between the estimations obtained by
speckf and kf is negligible  with the absolute differkf k
k
ence s peckf
in the order of       where the true
kkf k
state varies from     to      this shows that speckf
is consistent with kf and the error of the forward model
approximation in this case is small  as noted previously 
in this case the time step being used is rather small  representing an optimistic case for data assimilation  nevertheless  the good agreement of speckf with kf under
these conditions validates the speckf implementation 
it should be noted that the kf estimate is the optimal
estimate for a linear problem with given set of noisy
measurements  as shown in figure   the overall error added is maintained at low levels  since at all times

finally  we compare the results of the speckf for the
diffusion problem with enkf an alternative fast kalman
filter algorithms in terms of accuracy of estimation 
the results of each method are compared to the original kf algorithm  first  we compare the speckf results to those obtained by the ensemble kalman filter 
using the same    noisy measurements  three different ensemble sizes were evaluated  all larger than the
number of measurements  in order to allow the enkf to
converge  as shown in figure    increasing the ensemble size reduced the relative error of the enkf  however
in all three cases the enkf difference from the kf was
more pronounced compared to the speckf  since the
ensemble sizes were greater than the number of mea 

fiwith this assumption  we can obtain s and get the desired approximation of p 

surements  the computational cost of the enkf in all
three cases was also greater than that of the speckf 

p  us u t
   application  co  monitoring
the second benchmark application evaluates the performance of the speckf for the non linear problem of
co  transport in a two dimensional homogeneous domain  the accuracy of the speckf is compared with
that of the enkf  the forward model used to simulate the injection of co  in the subsurface is tough  
a multi dimensionsional  multi phase  multi component
non isothermal numerical simulator for flow and transport in porous media  pruess        pruess et al         
initially the forward simulation is run for     days to
provide the true data for pressure and co  saturation 
which are the two state variables we are interested in
tracking with the kalman filter  from this data     saturations and   pressures  n       are collected every   
days at locations indicated in figure    these measurements are then contaminated with gaussian error  using these measurements  the kalman filter algorithms
are used to estimate the pressure and saturation for the
whole domain  resulting in                unknowns
 m          the assimilation of data begins on day
   of the true experiment  the state of the system at
this time would be unknown in practice  for this reason  we initialize the kalman filter from a wrong initial condition corresponding to an approximate knowledge of the location of the co  based on the location
of the injection wells  the objective of the kalman filter is to predict the states at subsequent times  based on
these erroneous initial conditions  and the noisy measurements collected  both filters are initiated with the
same erroneous initial conditions and the same set of
noisy measurements is assimilated every    days  results are compared to the true state at different times 
we did not compare our results with kf  because implementation of kf method for this problem was very
expensive 
figure   compares the true state with the estimates
obtained by the speckf and the enkf with same computational cost  the speckf after the first data assimilation step does not give an accurate estimate  however  as more measurements are assimilated the estimation improves drastically such that the speckf estimate
at    days greatly resembles the true state  the relative
error of the speckf and enkf is compared in figure   
which shows both methods approximate the true solution with small relative error  however  when the noise

figure    comparison between relative error of speckf
estimation and enkf estimation with   different ensemble sizes  respect to kf estimation
     approximation of covariance matrix
the speckf algorithm gives the posterior covariance
only at measurement points  however  we may need to
know the uncertainty of the estimates at locations that
are not known a priori  we can obtain an estimate of the
full matrix p by assuming that the posterior covariance
has a low rank representation 
p  us u t
u is a known  preselected m  n matrix  i e   we assume
that p can be approximated by a low rank matrix with
rank equal to the number of measurements 
then  the cross covariance hph t   which is available
in the speckf  can be written as 
hph t  hus u t h t    hu s  hu t
   hus       hus      t
then  we perform a cholesky decomposition of the
known cross covariance hph t   vv t   this gives 
v  hus    
since v  h and u is known we can obtain an expression
for s      
s        hu   v
this step assumes that hu is non singular  h is a fat
matrix with n rows  while u is a thin matrix with n
columns  for hu to be non singular  we need to assume that span u   null h      geometrically  this
means that none of the important components of p
are in the null space of the observation matrix h  that
is  if there are components of p    span u   that are not
observed  they cannot be reconstructed by this method 
 

fiin measurements is small compared to the noise in the
forward model  the accuracy of the enkf decreases as
shown in figure    in contrast  the accuracy of speckf
increases  indicating that speckf would be more robust than enkf for a wider range of measurement errors  while we recognize that the above performance
comparison may be specific to the application at hand 
non linearities  parameterization of the filters etc  our
results indicate that the speckf can be a more reliable
and faster estimation method than the enkf  especially
for non linear problems with large numbers of measurements 

figure    comparison of true saturation with speckf
and enkf estimations for the case with small error 
first row  speckf estimation and second row  enkf
estimation for saturation with same computational cost 

figure    co  saturation distribution after    days  red
dots  production wells and blue dots  injection wells 

figure    relative error of the enkf estimation and the
speckf estimation compared to the true solution 
linearly  as opposed to quadratically  with the number
of unknowns and makes the estimation of states in excess of thousands of unknowns feasible 
the speckf algorithm was validated for a linear diffusion problem  and it was shown that for a small time
step between data assimilations the speckf gives results nearly as accurate as the full kalman filter  however  this method does not gives us error covariance matrix  but we showed that the full covariance matrix can
be obtained by using a post processing step based on a
low rank approximation of the covariance matrix  since 
this approximation is a post processing step  it does not
affect the estimation with speckf 

figure    comparison of true saturation with speckf
and enkf estimations  first row  true saturation  second row  speckf estimation and third row  enkf estimation for saturation with same computational cost

   conclusion

references

this project presented the spectral kalman filter  a
new kalman filter variant that can be effectively used
for data assimilation in non linear dynamical systems
with a large number of unknowns  the computational
cost of the speckf is dramatically reduced compared to
that of the original extended kalman filter  as it scales

kalman  r         a new approach to linear filtering and prediction
problems  journal of basic engineering          
pruess  k         tough   a general purpose numerical simulator
for multiphase fluid and heat flow  nasa sti recon technical
report n    
pruess  k   oldenburg  c   moridis  g         tough  users guide 
version      lawrence berkeley national laboratory  berkeley  

 

fi