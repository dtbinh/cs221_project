comparison of machine learning techniques for magnetic resonance image analysis
wendy ni  xinwei shi  umit yoruk
department of electrical engineering   department of radiology  stanford university

   background
magnetic resonance imaging  mri  is a powerful non invasive medical imaging technique that encodes the mechanical 
physiological and chemical structure of soft tissues  however  manual segmentation of tissue regions of interest  rois 
can be a laborious process prone to operator error  in this project  we compared algorithms from   classes of supervised
machine learning  ml  techniques for mri segmentation in   applications 
    dynamic renal imaging
quantitative analysis of mr urography data is important for early detection and staging of chronic kidney disease  the
patients are injected with a contrast agent and the distribution of the contrast is observed using mri over a period of    
minutes  the pharmacokinetic model used in renal filtration rate estimation needs concentration vs  time curves of the
aorta and renal cortex  in order to extract these curves segmentation must be performed on the mr images 
    knee cartilage imaging
mri has been an emerging technique in quantitatively assessing morphological and physiological change of the cartilage
for evaluation of osteoarthritis  oa   to get quantitative assessment  the cartilage in mr images needs to be precisely
labeled 
    stroke imaging
mri is invaluable for assessing brain tissue viability following a stroke  the flair     and gre     sequences are
commonly used to identify the morphological extent of stroke lesions  for quantitative analysis  the often poorlydelineated lesions need to be segmented slice by slice 

   data   features
all datasets were manually segmented by experts as
ground truth  the raw images were cropped to remove
background area  each voxel was considered as one
sample to be classified  the intensity features were
represented by     quantiles to remove the intersubject variances and all features are normalized to
      range 

fig    ground truth for kidney at peak intensity for rc and lc 

in renal segmentation     sets of abdominal dynamic
contrast enhanced  dce      images  size
         cropped to              time points 
were used  label categories were  aorta  ao   right
cortex  rc   left cortex  lc   we used   features 
voxel coordinates  times to     and     peak fig    knee images of   contrasts and ground truth  red  femur
intensity  initial      and peak intensity  the rationale cartilage  green  patella cartilage  blue  tibia cartilage  
behind feature selection is that there is a difference in
the enhancement rate of different tissues  fig      since the contrast is
injected intravenously  we expect the signal from aorta to start rising
first and reach the highest intensity before other tissues  as the contrast
diffuses  the signals from the other tissues rise as well  however  the
signal from the cortex rises faster than the other tissues because the
contrast that moves into the kidneys cannot leave  filtration  and starts
accumulating 
in cartilage segmentation    sets of knee dess     images  size
         cropped to             contrasts with different
diffusion weighting and t  decay  were used  fig      label

fig    ground truth for stroke segmentation 

ficategories were  femur  fe   patella  pa  and tibia  ti   we used     features  voxel intensity  coordinates  and derived
features related to edges and curvatures     including     the gradient of the smoothed image      largest eigenvalue and
corresponding eigenvector of the hessian  represents the principal curvature and direction of the curvature      largest
eigenvalue and corresponding eigenvector of structure tensor  st   represents the strength of the image edges  and the
vertical direction of the edge   the rationale behind feature selection is that the cartilage can be modeled as a thin curved
disc  the features except coordinates are repeated among the   contrasts  for nave bayes  we found the correlation
among features would lead to problematic results  and therefore only    features from   contrast were used in nave
bayes 
in stroke lesion segmentation     sets of brain flair and gre images  sizes       var and       var reduced to
         were used  fig      we studied   labeling schemes  all stroke lesions  sl  and hyperintense lesions only
 hl   we used    features including      voxel intensity statistics such as normalized mean and deviation from global
mean      radial coordinate      symmetry measures  such as anterior superior and left right differences      hemispheric
intensity statistics  including ipsilateral hemispheric mean  deviation of voxel intensity from ipsilateral hemispheric mean 
and voxel intensity normalized by contralateral mean      edge statistics  including low pass filtered brain edge and tissue
regional edge      multi scalar neighborhood intensity statistics including mean and standard deviation  and      d spatial
gradients in anterior superior and left right directions 

   methods
    models
we compared   models from   classes of ml techniques  including nave bayes  nb   logistic softmax regression  lr 
and svms with the gaussian kernel  svm g  and the linear kernel  svm l   we implemented nb and lr using custom
matlab code  we utilized the libsvm     library for svm l and svm g  and optimized parameters using grid search 
the cartilage segmentation was treated as a multiclass problem  while the other two applications were two class problems 
therefore  softmax regression and multi class svms with the one against one strategy were used for cartilage
segmentation  and logistic regression and standard two class svms were used for other applications  in renal
segmentation  the features were mapped to a higher dimensional space by quantizing each feature into     levels and
representing each level with a binary feature in svm with the linear kernel  which significantly improved the performance
of svm l 
    validation
since in all of the applications the classes are unbalanced  we inspected training and test recall and precision  method
comparison used f  score as metric  which is computed by f       precision  recall  
precision recall

k fold cross validation was used in evaluation  and k was decided based on total number of datasets  number of samples
in one dataset  and computation time for different applications  the voxels in each dataset were undersampled for speedup
processing  in renal segmentation  k       training on    sets and testing on   set   and the training sets were randomly
undersampled by a factor of   in the case of svm l and svm g  in cartilage segmentation  k      training on   sets and
testing on   set   and the data was randomly undersampled by     in stroke lesion segmentation  k      training on   sets
and testing on   sets   and the data was undersampled by a factor of    for speed  the undersampling is deterministic  but
because only the brain voxels are selected  sampling at regular intervals still provides good coverage across the brain 

   results   discussion
    comparison between techniques
the test precisions and recalls are summarized in table    the training and test f  scores are summarized in table   
for all applications  we found svm g to be the best  with high and balanced precision and recall  svm l was
comparable in performance  and takes less time to train  therefore  for best segmentation results we recommend svm g 
if the computing resources are limited  as the training set size increase it may be more practical to use the svm l 
for all applications  nave bayes had high recall but low precision  while logistic regression was the opposite  for
cartilage segmentation  nave bayes performance was poor due to failure of the assumption of conditional independence
of features  detailed discussion in      

fitable    the test recalls and precisions of different ml techniques 
naive bayes

renal

cartilage
stroke
lesion

aorta
r  cortex
l  cortex
femur c 
patella c 
tibia c 
s  lesions
h  lesions

recall
    
    
    
    
    
    
    
    

prec 
    
    
    
    
    
    
    
    

logistic
regression
recall
    
    
    
    
    
    
    
    

prec 
    
   
    
    
    
    
    
    

svm linear
kernel
recall
   
    
    
    
   
    
    
    

prec 
   
    
    
    
    
    
    
    

svm gaussian
kernel
recall
    
    
    
    
    
    
    
    

prec 
    
    
    
    
    
   
   
    

table    the training and test f  scores of different ml techniques 
naive bayes

renal

cartilage

stroke
lesion

aorta
r  cortex
l  cortex
femur c 
patella c 
tibia c 
s  lesions
h  lesions

trainin
g
   
   
    
    
    
    
    
    

test
    
    
    
    
    
    
    
    

logistic
regression
training
test
   
    
    
    
   
    
    
    

    
    
    
    
    
    
    
    

svm linear
kernel
training
test
    
    
    
    
   
    
    
    

    
    
    
    
    
    
    
    

svm gauss
kernel
training
test
    
    
    
   
    
    
    
    

    
    
    
    
    
    
    
    

    error analysis
sample images with scm g segmentation results are shown in fig       for all applications  there are three common
fundamental limits      partial volume effect  mixing of signals from different tissues  affecting segmentation of fine
structures      ground truth prone to subjective factors      system related or subject related inter scan variations making
generalization challenging 
in renal segmentation  segmentation of cortex is more
challenging than the aorta  this is partly due to the more
complex structure of the kidneys  cortex consists of many
small structures and the large slice thickness of the images
cause partial volume effect  this in turn causes labeling
inaccuracy in the training set limiting the ml
performance  in some cases  parts of the spleen was
mislabeled as left cortex because it is in close proximity fig    renal segmentation using svm g  aorta  red   right cortex
and has similar signal enhancement to the renal cortex   green  and left cortex  blue  segmented correctly  the arrow
finding more discriminative features such as local image points to an artery  which was missed during manual labeling but
correctly classified by svm   see fig     for the ground truth  
statistics could improve the labeling accuracy of left
cortex 

fiin cartilage segmentation  automatic segmentation did relatively well
in patella cartilage  which has relatively homogeneous intensity and
simple shape  femur and tibia cartilages have very inhomogeneous
intensities and are more susceptible to partial volume effect  therefore
the segmentation is more challenging  the manual labeling of these
two parts is prone to subjective factors  comparing the arrows in fig    
the similar region was manually labeled as cartilage in the upper case 
but not in the lower one 

svm g

ground  truth

in stroke segmentation  the overall performance was good even for
highly inhomogeneous and diffuse lesions  stroke lesion segmentation
is very challenging due to aforementioned homogeneity in lesion
features  often diffuse appearance of lesions  both due to underlying
physiology and partial volume effect   and similarity to healthy tissues
in many features  there is also significant inter subject variation in
lesion characteristics and size  indicated by the gap between training
and test f  scores  therefore  it is very important to have large
fig    cartilage segmentation using svm g  femur
training sets covering a wide of range of lesions characteristics 
the segmentation results can be improved by using image
processing methods  such as graph cut  to promote smoothness
and continuity 

cart red   patella cart green   tibia cart blue   the two
rows are two different datasets 

stroke lesion
labeling scheme
  

hyperintense lesion
labeling scheme
  

flair image

    the influence of correlated features in nave bayes
nave bayes assumes that the features are conditionally
independent  when some features are highly correlated  they
are effectively given higher weights in the classifier 
in the cartilage segmentation problem  some features can be
highly correlated since they are repeated for different contrasts 
or reflect similar characteristics  when all     features were
used  nb had very poor precision        and misclassified
tissues with similar intensity as cartilage  as a result of heavy
weighting on intensity related features  after removing similar
features  the performance of nb was improved  but still worse
than other ml techniques  this can be explained by that the
correlation coefficient is still large between some features 
such as intensity and hessian eigenvalues  as shown in fig   
fig    stroke lesion segmentation using svm g  the top row
the results suggest that the independence assumption of nb is is a patient with a hematoma  dark lesion   which is delineated
hard to satisfy when complex features are used  therefore nb well in the hyperintense lesion labeling scheme  white arrows
indicate isolated voxels that are incorrectly identified when
is not a good fit for the cartilage segmentation problem 
  

  

hypointense voxels are not excluded from the model  yellow

    feature dimension reduction
arrows indicate a region of flair hyperintensity that is
in cartilage segmentation problem  there is redundancy in the classified by experts as normal tissue but is incorrectly
    dimensional features  and the training of svm takes a long identified as lesion  the bottom row is a patient without a
hematoma and with very good segmentation results 
time due to the high dimensionality of features  pca and
feature selection by filtering were incorporated to reduce
feature dimension  for pca  the threshold was set as     
of sum of eigenvalues  and the feature dimension was
reduced to     for feature selection by filtering  the f score
    was used as metric of discrimination of features  and the
top    features were selected  as shown in table    the
feature selection by f score filtering was better in terms of
training time reduction and classification performance  the
training time is reduced by half from    minutes  while the fig    cross correlation matrix of    features for femur cartilage 

fiprecision  recall and f  score of the results is not significantly
affected 

table    comparison of feature dimension reduction methods

   conclusion
in this project  we found that for automated segmentation of
renal structure  knee cartilage and stroke lesions  svm with the
gaussian kernel works the best  with high and balanced precision
and recall  svm with the linear kernel is comparable and may
be more practical to implement 

test f  score at dierent downsampling 
factor  stroke lesion labeling scheme 

    
f  score     

    training set size vs f  score
we analyzed the effect of training set size on the f  scores using
svm g  the results in renal segmentation application are shown
in fig    in other applications  similar trends were observed  as
the training set size increased  the training f  scores decreased
and the test f  scores increased  in the segmentation of aorta  the
training and test f  scores fully converged after including  
datasets  the training and test f  scores of the renal cortex had a
converging behavior but they didnt fully converge after
including    kidneys  this can be explained by that the kidneys
vary significantly in shape and size as well as the intensity
changes  e g  fully functional kidney takes up the contrast faster
than a diseased kidney   in addition  some of the patients only
had one kidney and this effectively reduced the training set size 
in fact  the training and test f  scores of the right cortex  present
in     missing in   patients  converged better than the left cortex
 present in    missing in   patients  

   

downsampled training set  full test set 

   

full training set  downsampled test set 

   
   
  
  

training time per model  s  

    training test data undersampling
to confirm that undersampling did not significantly affect the
performance of ml  we inspected the training and test f scores versus number of voxels per dataset  we found that the
saving in training time justified the small reduction in f scores at undersampling factor     as shown in fig   

   

   
   
downsampling factor 

   

    

training time at dierent downsampling 
factor  stroke lesion labeling scheme 

     
    
   
  
    
     

  

   

   

   

   

    

downsampling factor 

fig    representative test f  score and training time curves at
different downsampling factors  demonstrating that acceptable
error is introduced by downsampling the training data set and
as indicated by table   and fig    the generalization ability of test data set  at significant training time savings 

   future work

the ml techniques is still confined by limited training
datasets  we will expand training set to reduce the effect
of inter patient variation  we will add new features to
reduce bias of the models  including local image statistics 
dynamic information for renal segmentation  tissue texture
characteristics for cartilage segmentation and inter slice
information for stroke lesion segmentation  we will
incorporate svm g with graph cut to refine segmentation
results  finally  we will improve ground truths by using
multiple experts manually labeling 
fig    training set size analysis on renal segmentation using svm g 

reference
    brant zawadzki m  et al  stroke                 warach s  et al  neurology                 tofts ps  et al  j mag res
im                 eckstein f  et al  ann rh dis                 folkesson j  et al  miccai                     chang c 
lin c  acm tist                          chen yw  lin cj  feature extraction                  

fi