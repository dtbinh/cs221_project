bone segmentation on mri scans
todor markov  william mccloskey
advised by samir menon
stanford university

i 

introduction

diagnostic imaging is a principal method of analysis
in modern medicine  doctors and other medical professionals gain invaluable information about their patients
through medical scans such as x rays  computed tomography  ct  cans  and magnetic resonance imaging
 mri   with this visual information  medical practitioners diagnose and monitor the health of their patients  and
medical researchers gain insight into anatomical features
of the subjects of the images  it is therefore desirable to
improve the process as much as possible  and one way to
do this is to automatically segment medical images 
despite the bulk of research done on medical image
segmentation  however  the successes are only partial  a
multitude of algorithms have produced varying degrees of
success  though no algorithm has performed well enough
or universally enough to become the canonical choice for
diagnostic image segmentation  elnakib et al        
segmentation of medical images therefore remains a relatively open problem  and successful segmentation occurs
only on a situational basis 
this project focused on finding an effective algorithm
for bone segmentation in mri scans  we wanted particularly to improve the process of musculoskeletal modeling  where most bone segmentation is done completely by
hand  in detail  we input an mri scan with four dimensions   three dimensions for the location of a voxel  and
one dimension for the voxels greyscale value   and we
aimed to return an mri scan with bone voxels highlighted differently from the rest of the tissue in the scan 
the main feature that characterizes our problem is the
prominence of bone among the rest of the mri contents 
bone mass generally appears much whiter than the surrounding tissue and has a sharp boundary around most
but not all of its edges   see figure    
our approach was as follows  for preprocessing  we
ran anisotropic diffusion smoothing in order to mitigate
noise in the images  we then ran variations of bias field
correction in order to learn the bias field of the image
and then to correct intensity inhomogeneities  two models were used to segment the bones  k means clustering 
and region growing  though several different variations
of k means were implemented  the resulting segmentations were seldom better than mediocre  region growing 
on the other hand  performed exceedingly well  where
a musculoskeletal researcher would spend several hours
to segment a single bone  region growing performed the
segmentation to a reasonable degree of accuracy in under
fifteen minutes 

fig     a representative mri bone scan of a forearm  the
bone voxels are distinguishable from the other tissue by their
white color 

ii 

data

our data was a set of unlabeled mri scans provided by
the stanford artificial intelligence laboratory  for the
purposes of musculoskeletal modeling  it was sufficient
to find an algorithm that resulted in a fairly accurate though perhaps not perfect   segmentation  additionally 
a quick automatic segmentation that segments the obvious bone voxels can be followed up by a careful hand
segmentation  still saving a significant amount of time 
since relative accuracy can be judged by the naked eye 
and since it would take multiple hours per bone to handlabel our data  we opted not to use labeled data 
iii 
a 

preprocessing
anisotropic diffusion

anisotropic diffusion  also called perona malik diffusion  is a technique aimed at reducing image noise
without blurring edges or removing other significant
parts of the image content  we opted to use it because
it allows us to achieve a more homogenous intensity
distribution in bone voxels while keeping the quality of
the bone edges 
as the technique is not related to the topics we
covered in class  and machine learning in general   we
will only explain the general idea behind it  the way
ordinary diffusion works is by taking the intensity of
each voxel  then we apply a discretized version of
the heat equation to the image  we set the value of
each voxel to a weighted mean of its   neighborhood or
   neighborhood  for a number of iterations  however 
this way  the blurring of the image affects the edges as
well  to compensate for that  we change the conductivity factor in the heat equation from a constant to
an appropriate function g of the image which promotes

fi 
diffusion within regions and inhibits it between regions 
we tested both functions proposed in the perona malik
paper 

with parameters a    a            am   we substitute the data
points in it to get a set of equations 
g    f  x    y    z    a    a            am  

  i    
   
g i    exp  
k
 
g i   
  i    
    k  
where i is the original image  i is the gradient image 
and k is a constant which controls sensitivity to edges 
both of the functions seemed to enhance the segmentation quality by a small amount  by reducing the number
of false negatives   but neither was obviously better than
the other 
b 

bias field correction

a bias field is a distortion of an mri image  this field
varies smoothly over the image  making entire regions of
an mri darker than other regions  see figure     bias
fields are a problem for bone segmentation because nonbone voxels in light regions can easily become lighter than
bone voxels in darker regions  due to decreased visibility  bias fields also obstruct manual segmentation  all
of our data had a noticeable bias field  which needed to
be corrected  we tested two different approaches to bias
field correction  obtained respectively from juntu et al 
and mohamed et al   outlined below 

  
 
gn   f  xn   yn   zn   a    a            am  
we obtain the solution a    a    a            an   to this set
of equations by minimizing the sum of squares of the
differences
n

q a   

 x
 gi  f  xi   yi   zi   a    a            am    
  i  

this is done iteratively by selecting an initial estimate of
the parameters a  and then using a step similar to the
newton rhapson method 
ai     ai   h    diag h    q ai  
where h and  are the hessian and the gradient  and
diag h  is the diagonal elements of the hessian  and  is
a variable adjusted at each iteration which controls the
speed of reduction 
  

fuzzy c means

our second algorithm was a fuzzy c means bias field
correction  as is common in the literature  we modeled
the bias field additively 
y k   x k   k  
fig     an example bias field  it might be difficult to see 
but there are actually two bones in this picture  which will be
clear in the results section 
  

parametric surface fitting

in our first approach  we extract a background that
represents the lighting conditions from the original
image  and then divide the original image by the
background image in order to get the bias field corrected
image  the background image is obtained by first
applying a low pass filter to the original image  we
used gaussian blurring with a large bandwidth   then 
several datapoints are selected from the blurred image
 taking their coordinates and greyscale values   and a
 d topological manifold  we used a smooth polynomial
surface  is fitted to this data  finally  the fitted equation
is used to generate the final background image representing the bias field 
we did the surface fitting by using the damped least
squares method  also known as the levenberg marquardt
algorithm   given a polynomial f  x  y  z  a    a            am  

     

the observed intensity yk is a true intensity xk plus
a bias term k that varies smoothly over the threedimensional image 
in order to learn the bias field k   we minimized the
following cost function of mohamed et al   which uses
fuzzy c means 

jm  

c x
n
x

upik   yk  k  vi    

i   k  



c x
n
x
x

 
upik 
  yr  r  vi       
nr i  
k  

yr nk

here   vi  ci   are the prototypes of the clusters  and
the array  uik     u represents the partition matrix  n is
the image volume  total number of voxels   nk stands for
the set of neighbors that exist in a window around voxel
xk   and nr is the cardinality of nk   this is done by
taking the derivatives with respect to uik   vi   and k and
setting them to zero  the relevant equations we obtain

fi 
after we set the derivatives to   are below 
for the partition matrix 

ui k  
pc

j    

 
dik  
djk  

b 


  
nr i p 
 


nr j

where dik     yk  k  vi     and i
p
 
yr nk   yr  r  vi     
for the clusters 

 



p
p

 y


 
 
 y


 
u
k
k
r
r
k   ik
yr nk
nr
 
pn p
       k   uik

pn
vi  

for the bias field 

  

pc
upik vi
k   yk  pi  
c
p  
i   uik
the algorithm works by selecting initial cluster prototypes and initial bias field estimate  and then iteratively
updating the partition matrix  the cluster values and the
bias field using the rules above until the clusters converge  or for a set number of iterations   once the bias
field is learned  the true intensities can be solved for in
equation     to obtain a corrected image 
iv 
a 

k means clustering

our implementation of k means is as follows  we reshaped the mri from a three dimensional image into a
one dimensional image  then k means clustering was
performed on the one dimensional image to separate the
points into k clusters  where each cluster contained the
points in a certain range of grayscale values  since the
true intensities of the bone voxels are brighter than
the true intensities of the none bone voxels  and since
we correct for the true intensities with bias field correction  we expected the bone voxels to constitute the
brightest clusters  to segment the image  we iterated
through each the resulting clusters  setting the grayscale
values of the points in the cluster to the grayscale value of
the centroid representing the cluster  then we mapped
the points back to their original position in the threedimensional mri and displayed the result  in the final
image  the whitest color clusters represented bone  and
the darker colors represent other features of the scan 

models

region growing

the region growing algorithm uses local spatial data
to grow a homogeneous region  the algorithm takes in
human specified seed voxel  which is initialized to be the
region  then points are added to the region if they neighbor a voxel of the region and if their intensity falls within
a certain threshold  once this process terminates  the
result is a region of voxels of homogeneous intensity connected spatially to the seed point 
we used two different ways to determine the intensity
threshold required to add a voxel to the region  in the
first implementation  we allow the user to supply an upper and lower bound  in the second implementation  we
compute the mean and standard deviation of the intensity of all the voxels classified as bone  and use those
values to set the threshold  upper and lower bounds are
the mean plus a constant times the standard deviation  
once a voxel is added to the region  the mean and standard deviation are recomputed before adding the next
voxel o the region 
since bones usually show up brighter than the rest of
the scan and have prominent edges  region growing is
an natural way to grow a bone voxel into a bone with
minimal risk of leakage 

bone brightening

our main method for augmenting k means was a technique we called bone brightening  we observed that the
majority of a bone is surrounded by a sheath of black
voxels  this sheath can be seen in the figures included
throughout the paper  the white part of the scan  the
part that shows up as bone  corresponds to bone marrow  the black sheath surrounding the bone corresponds
to the hard bone around the marrow  which is prominent
everywhere except at the joint and cartilage areas  bone
brightening attempts to use this black sheath to brighten
the bone voxels more than the rest of the voxels  the algorithm is in some sense a bias field correction for bones 
if the bones were brightened to a level much higher than
the rest of the tissues  then k means could successfully
cluster the bones out of the rest of the image 
in our implementation  we first marked all of the voxels
in the black sheath using region growing  then  for each
marked voxel  we brightened every non marked voxel in
a circle of a certain radius by a constant factor 
the geometry of the sheath and the bone ensures that
the constant increments pile up on the bone voxels more
than the surrounding region  to see this  consider the
two dimensional case  the black sheath corresponds to an
annulus  the center of the annulus corresponds to bone 
and the outside of the annulus corresponds to non bone
voxels  assume we are brightening around a circle of
radius r  a voxel v is brightened proportional to the area
of the intersection of the annulus and the circle of radius r
centered at v  because these are the marked sheath voxels
that will brighten the bone   as long as the annulus is
not too thin  an appropriate choice of r will cause the
circles in bone voxels to intersect with the annulus at a
large area  the area of the circle increases proportional
to the square of the radius  so the area of the annulus
is usually quite large   in addition  all voxels outside of
the annuluss outer circle intersect with the annulus at at
most half their area  because the outer circle is convex 
hence the bone voxels are brightened more than the nonbone voxels 

fi 
v 

results

region growing resulted in quick and successful segmentation of a large majority of images  we visually
estimated that region growing classifies at least    percent of the obvious bone voxels  the following scans
are representative of region growing segmentation on our
data set 

fig     original wrist scan 

field correction in our region growing segmentations because it smooths the edges to some degree in the original
image  increasing the risk of leakage 
in addition  bias field correction was not effective
enough to allow k means to perform at a satisfactory
level  k means clusters solely based on voxel intensity 
and hence is extremely sensitive to global intensity inhomogeneities  thus  while k means successfully clusters
the brightest bone voxels  it often conflates dark bone
voxels and light non bone voxels 

fig     wrist after
region growing 

fig     k means on a bias field corrected image

in a completely corrected image  k means should perform very well  nevertheless  the true image could be only
partially recovered 
our other attempt at combating the bias field was bone
brightening  which tries to brighten the bones relative to
the surrounding tissue to a level where they could be
clustered 
fig     humerus after
fig     original humerus scan  region growing 

on average  region growing takes around ten minutes
per bone  where a manual segmentation might take multiple hours  the segmentations classify a majority of the
bone  and  more importantly  rarely miscategorize a nonbone voxel as bone due to the sharp edges around most of
the bone  region growing struggles most near joints and
in regions of severe intensity inhomogeneity where edges
become less clear  though we found that both of these obstacles can usually be combated with appropriate choice
of seed point and threshold 
bias field correction successfully reduced intensity inhomogeneities  brightening the images and making them
much more navigable to the human eye  as seen in figure    while bias field correction dramatically improves

fig     bias field correction on figure   makes the second
bone visible 

the process of manual segmentation  we found that bias
field correction had little effect on the quality of region
growing segmentation  in fact  we decided not to use bias

fig     bone brightening success fig      bone brightening unsucful locally 

cessful globally 

bone brightening performed exactly as desired on a
local level  but it created its own type of bias field on
a global level  the black sheath becomes narrower and
wider at different areas along the bone  since brightening
occurs proportional to the area of the circle intersecting
the local black sheath  areas with a thick sheath become
much brighter than areas with a thin sheath  we were
unable to overcome this problem in bone brightening 
though we are optimistic about the potential of some
modification of the algorithm 
vi 

analysis

the initial struggle of k means surprised us  but in
retrospect there is little mystery in the failings of the
algorithm  k means makes what turns out to be a strong
assumption that voxel intensity is spatially invariant  we
expected bias field correction to supplement k means 

fi 
but both bias field corrections that we implemented were
not strong enough to separate the bone from the rest of
the tissue 
for the same reason  region growings success is also
unmysterious  bone voxels have relatively homogeneous
intensity  especially after edge preserving smoothing 
moreover  the majority  though not all  of the bone is
surrounded by a black sheath  so the potential for region growing to leak into non bone areas is present but
minimal  region growing takes into account only local
inhomogeneities  so it still functions in a fairly efficient
manner even in the presence of a bias field 
the relative inefficiency of bias field correction  on the
other hand  is difficult to explain  while it could be
explained by failure to converge for the fuzzy c means
approach  and a poor choice of a surface polynomial and
  or datapoints for the surface fitting approach  we still
expected it to have a more noticeable effect on segmentation quality  especially given the fact that the bias field
corrected images were much easier to do manual segmentation on 
vii 

conclusion and future work

this paper implemented machine learning and segmentation algorithms with the aim of segmenting bones from
mri scans  bias field correction performed at a level adequate for human segmentation  though not enough to
aid the segmentation algorithms algorithms  k means
clustering gave subpar results despite modifications  region growing performed at a reasonable level of accuracy 
and gave rapid  quality segmentations  the region growing segmentation was at the level the project set out to
achieve in its segmentation 
we identify a number of areas in need of future work 
the most central of these is a satisfactory clustering algorithm  although it is more difficult to implement clus 

    p  perona and j  malik  scale space and edge detection using
anisotropic diffusion  pattern analysis and machine intelligence  ieee transactions on                       
    m  ahmed et al  a modified fuzzy c means algorithm for estimation and segmentation of mri data  medical imaging 
ieee transactions on                       
    r  adams and l  bischof  seeded region growing  ieee transactions on pattevn analysis and machine intelligence  vol     
no     june      

tering than region growing in the face of intensity in homogeneities  we think that the ceiling of accuracy for a
clustering algorithm is much higher than that for region
growing   because  in a true image  clustering should
work excellently  one step towards this goal would be to
cluster based on features that take into account on spatial
data  we did try some simple features that took into account neighboring voxel intensities to no avail  but perhaps some more complex features might result in more
accurate segmentation 
another step toward better clustering algorithm is a
better method of overcoming the bias field  we tried two
methods of finding the bias field that are common in the
literature  but neither was adequate  perhaps different
bias fields can be chosen to improve clustering  we are
more optimistic about the prospects of bone brightening  which was a novel algorithm developed in this paper 
k means clustering on two dimensional bone brightened
slices results in a quality clustering  so an extension of
bone brightening to the global level should enhance kmeans dramatically  the extension of bone brightening
to the global level might appear to be as difficult as correcting bias field inhomogeneities  however  we deem the
extension of bone brightening to be much more tractable
than bias field correction because  rather than attempting to calculate a low level smooth distortion over an arbitrary image  bone brightening needs to investigate the
properties of the black sheath  much of which is known
beforehand 
finally  the region growing algorithm can be improved
upon and fine tuned for better bone segmentation  this
could be done by finding a better threshold  or by running region growing in tandem with other segmentation
algorithms  such as a hypothetically improved clustering
algorithm 

    a  elnakib  g  gimelfarb  j s  suri  a  el baz  medical image
segmentation  a brief survey  multi modality state of the art
medical image segmentation and registration methodologies 
springer  new york        
    juntu  j  sijbers  d v  dyck  j  gielen  bias field correction for
mri images  m  kurzynski  e  puchala  m  wozniak  a  zolnierek  eds    proceedings of the  th international conference
on computer recognition systems  cores     may            
rydzyna castle  poland  advances in soft computing  vol     
springer         pp            

fi