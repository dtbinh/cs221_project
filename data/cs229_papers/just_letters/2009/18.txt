online parameter estimation for the adaptive control of
unmanned aerial vehicles
tristan flanzer and s  andrew ning
december         

 

introduction

 

unscented kalman filter

in an attempt to reproduce conditions in hardware 
we use a special type of kalman filter known as an
unscented kalman filter     to provide an estimate
of the aircraft state based on noisy measurements 
like extended kalman filters  ukfs allow estimation
of non linear functions  kalman filters consist of two
steps  prediction  followed by update  the prediction
phase takes the previous state estimate and produces
one for the current time step  in the update step  the
current prediction is combined with current observation to refine the estimate  the state of the filter
is represented by the a posteriori state estimate and
a posteriori error covariance matrix  the ukf preserves much of this high level architecture  it differs
in that the predict and update functions can be nonlinear  and that rather than linearizing the underlying model as done using an ekf  the ukf propagates a set of points through the nonlinear state and
measurement functions and recovers an estimate of
repeat the following until objective is obtained  e g 
the mean and covariance of the state  the underwaypoint is reached   
lying intuition is that it is easier to approximate a
probability distribution than it is to approximate an
   use a kalman filter and sensor data to provide
arbitrary nonlinear function or transformation  figestimate of aircraft state 
ure   shows output from a simulation demonstrating
the accuracy of the state estimates  here it is as   perform actions based on current control gain sumed that gps position and velocity information
matrix and current error in reaching desired is received at   hz and that imu data consisting of
state 
three axis accelerometer and gyroscopic data is used
to advance the state estimate at    hz 
   every two seconds re linearize the dynamic equations of motion about the current state and esparameter estimation
timate control gains to maximize a quadratic re   
ward function 
the objective of the parameter estimation is to
the accurate modeling of aircraft dynamics is
essential when applying optimal control algorithms
to unmanned aircraft  however  for low cost vehicles
the dynamics may be difficult to predict  a number
of factors work against the engineer  the aircraft is
more likely to suffer manufacturing imperfections
and rely on relatively crude actuation mechanisms 
atmospheric disturbances play a significant role
in performance  and under these conditions some
aerodynamic performance parameters are difficult
to accurately predict  furthermore  a hard landing
or other disturbance could easily alter the control
surface trims of the aircraft and perhaps even its
dynamic response  finally  low cost aircraft are more
susceptible to actuator failures in flight  all of these
factors motivate online parameter estimation  our
strategy is outlined as follows 

learn a linear aerodynamic model for the aircraft 
the motivation for this approach is that the aerodynamic forces of the aircraft  with the exception of
drag  are well approximated by linear functions  the
only nonlinearities that arise are in extremely rapid
maneuvers or near stall  our aircraft is not designed
for aerobatic maneuvering and is not designed to fly

   every ten seconds make a maximum a posteriori estimate of aerodynamic parameters based on
past states and prior knowledge of the parameters 
 
 

fix  m 

where a and b are nonlinear functions of the states
and actions  and  is assumed to be sampled from a
gaussian distribution    n        i   
from our sensors we will not be able to provide
p  q  and r directly  numerical differentiation is also
undesirable  since the state estimates will have some
noise  instead  we can use integration to relate s to
the state in the next time step  using a forward euler
approximation we have

true state
estimated state
gps position

   
  
 
 

 

 

 

 

 

 

 

 

 

  

 

 

 

 

 

 

 

 

 

  

  
y  m 

  
  
 
  
 

z  m 

  
 

s t     r st   st     s   s t t

 
 
 

 

 

 

 
 
 
time  seconds 

 

 

 

   

where r is a rotation matrix that rotates from the
body frame at time t to the body frame at time t   if
we insert equation     into equation     and rearrange
we have
s t     kt    ct   
   

  

figure    unscented kalman filter estimate of aircraft horizontal  lateral  and vertical position 

where
close to its stall speed  allowing us to confidently use
kt   r st   st    a st   at  t
a linear model throughout the flight regime  thus 
learning an aerodynamic model is a more promising and
ct   r st   st     s t   b st   at  t 
approach than trying to directly learn the dynamics
of the aircraft which are inherently nonlinear 
we will like to update our maximum likelihood esthe state vector for the aircraft is given by
timation of  periodically  using all the state and
action inputs from the previous update interval t  
s    u  v  w  p  q  r  x  y  z       t
to the current time t as a training set  we can make
where u v w are the velocities in the body frame  p q r a new estimate for t   before performing maximum
are the angular velocities in the body frame  x y z are likelihood we would like to incorporate some prior
the positions of the aircraft in inertial space  and   knowledge about the parameters  there are two mo   are the euler angles describing the orientation tivations for doing this  first  from simulation we
of the aircraft  the action vector for the aircraft is can often provide a reasonable starting estimate for
given by
the parameters   second  we would like to avoid our
a    e   r   a   t t
training set growing larger and larger as time passes
where e is the elevator deflection  r is the rudder since we need to provide updates to our control stratdeflection  a is the aileron deflection  and t is the egy at a consistent rate  thus  we will assume a prior
throttle setting  the parameters of the aerodynamic distribution on  of the form
model contain constant terms and the so called stat  n  t        i 
bility derivatives of the aircraft  the stability derivatives do not contain every possible term of a generic where for t       is our initial estimate provided by
 
linear model since it is known that many of these the user  thus  each update uses the previous update
terms are negligible for an aircraft   these parame  of  as its prior 
ters are arranged in to a column vector
then the maximum a posterior estimate for  is
    cl       

dcn
dcl
   
      t  
d
dp

given by

  r  

only six of the state derivatives depend on these pa  t
rameters  these we denote as
s    u  v  w  p  q  r t

 

the other six state derivatives are functions only of
the states and do not depend on the actions  we
can rearrange the equations of motion as a stochastic
linear function of the parameters 
s   a s  a    b s  a    

 

 

arg max


arg max


arg max


t
y

p s t    st   at    p  

t t  
t
x

log p s t    st   at       log p  

t t  
t
x



t t  



   
 

 
 kt   dt  t i kt   dt        
   

 
   t    t i   t    
   

fi 

t
x

arg min


 

  kt   dt           t      

t t  

where

a full six degree of freedom simulation was written
in matlab to predict the behavior of an aircraft
in flight  the aircraft equations of motion are integrated using a fourth order accurate runge kutta
scheme  aerodynamic forces and moments are assumed to be linear functions of the aircraft stability
derivatives and aircraft state  the aircraft is assumed
to have an elevator  rudder  ailerons  and single electric motor  the aerodynamic parameters are based
on mark drelas supra f j sailplane  seen in figure
  

dt   s t    ct
and
 

   


the optimization problem can be rearranged to the
equivalent least squares problem
fifi


fifi
fifi
fifi kt  
dt  
fifi
fifi

fifi

fifi
  
  

fifi

fifi
 
 
t   arg min fifi
  
fifi
 fifi k


fifi
dt
fifi
fifi  t

fifi
i
t   fifi

 

simulation and aircraft dynamics

control strategy

we use reinforcement learning to choose the optimal control policy for piloting the aircraft  we choose
a quadratic reward function  and use a linear model
of the aircraft dynamics  the full nonlinear dynamics
are available  but using a linear model greatly simplifies and speeds up the solution process  the optimization problem is given as 
min
a


x

 st  sd  t q st  sd     att rat

t tc

s t 

st     ast   bat

figure    supra f j sailplane

some basic aircraft dimensions are listed below in
table   

where sd is the desired state  and q and r are chosen
according to brysons rule     as 
qii  

 
max acceptable value of   s  sd   i  

rii  

table    aircraft characteristics
wing span
wing area
mass
cruise speed

 
max acceptable value of  a i  

    m
      m 
     kg
  m s

this problem formulation is the infinite horizon
discrete linear quadratic regulator  lqr  which has
the solution of
we assume that the aircraft is equipped with a
gps with a  hz update rate and an imu that is
queried at   hz  the gps provides positions and vewith k being a matrix of optimal control gains  the locities  while the imu provides acceleration and annonlinear equations are re linearized about the cur  gular velocities  the sensor uncertainties are shown
rent state every two seconds  and the k matrix is in table   and were based on commercially available
updated  this allows us to still capture some of the inertial measurement units and gps modules apprononlinear dynamical behavior of the aircraft 
priate for this size of vehicle 
at   k st  sd  

 

fitable    sensor uncertainties
imu sensor uncertainties
x   y acceleration
      g
z acceleration
       g
heading angular rate
    deg s
pitch   roll angular rate      deg s
gps sensor uncertainties
x   y position
    m
z position
    m
x   y velocity
    m s
z velocity
    m s

  
 
 

y  m 

  

 

  
 

 

 

  

 

  

results

  

to test the effectiveness of the method we randomly initialize the aerodynamic parameters    from
a normal distribution with a mean equal to its true
value but with a standard deviation of     of the
parameter  this is a fairly large error  in practice we
would expect to be able to provide a better starting
point using aerodynamic analysis tools  however  we
add the large uncertainty here to show robustness 
in addition  one of the critical parameters dcl  da
has its sign changed  this parameter is the change
in rolling moment with change in aileron deflection 
changing the sign of this parameter will cause the
airplane to want to turn the wrong way  finally  the
following results assume a zero wind speed 
figure   shows the path of the aircraft on a waypoint navigation mission  it starts at waypoint   and
its objective is to pass through the other waypoints
in order while maintaining a certain altitude and forward speed  we can see that initially the aircraft
turns the wrong direction because we changed the
sign of one of the parameters  however  it quickly
learns the correct sign and is able to complete the
mission successfully 
the other objectives were to climb to a steady state
altitude of   m  relative to the starting altitude  at
a forward speed of   m s  figures   shows the time
history of the altitude and forward speed  at the
beginning we can see that the altitude and forward
speed are far from their desired values  the reason
for this is that because of the parameter with the
flipped sign  the accumulated error in heading angle
gets larger and larger  consequently that term in the
lqr objective function becomes dominant and there
is less focus on trying to minimize error in altitude
or forward speed  as a better aerodynamic model is
learned  the controller adapts and brings the aircraft
to its steady state values 

 

  

   

   

x  m 

relative alt   m 

figure    top view of uav path  waypoints denoted
by circles

  
 

  
  

 

  

  
time  s 

  

  

 

  

  
time  s 

  

  

u  m s 

  
  
 
 

figure    time history of the relative altitude  and
the forward speed  in body axes 

 

fi 

we need some metric to assess how well the supervised learning algorithm is doing in predicting the
aerodynamic parameters  as mentioned   is updated every    seconds using the estimated states
from that time interval and the prior estimate for
  if  were generating a good aerodynamic model
to predict the next state  then we would expect that
  sactual  s     should be small for each time step
in the time interval  using our previous notation this
is equivalent to the term   kt   dt    being small for
t   t          t   or  in other words we expect that
the term
v
u t
u x
  kt   dt    
 t

future work

with the algorithm performing successfully in simulation  the next step will be to test its performance
in hardware  a uav is currently being designed
for this purpose  a research autopilot     developed in the aircraft aerodynamics and design group
will be used for autonomous control  the autopilot
schematic can be seen in figure    the sensor suite
will include gps  a   axis imu  an airspeed sensor 
and a barometric altitude sensor 

t t  

should get smaller as the aerodynamic model is
learned 
figure   shows the change in this parameter 
as a function of time  we see that in the first update  there is a large jump in performance  most of
this gain comes from correcting the parameter that
started out with the wrong sign  in the subsequent   
figure    tern research autopilot
seconds the error is further diminished  for longer periods of time there is essentially no additional learning  there all several reason why the error will not
go all the way to zero even in simulation  first  we references
are using estimates of the states rather than the true
states and have included both sensor noise in the esti      ea wan and r  van der merwe  the unscented
kalman filter for nonlinear estimation  in the
mation  second  we are using an euler approximation
ieee      adaptive systems for signal processfor integrating from one time step to the next as dising  communications  and control symposium
cussed previously  thus   is a measure of the sum of
      as spcc  pages              
the learning error  sensor noise  and numerical error 

  an error metric 

    a e  bryson and y c  ho  applied optimal control  wiley new york       
    c k  patel and i m  kroo  theoretical and experimental investigation of energy extraction from
atmospheric turbulence  in   th international
congress of the aeronautical sciences       

  

  

 

 

 

  

   
time  s 

   

figure    convergence of the learned aerodynamic
model to the true model as a function of time

 

fi