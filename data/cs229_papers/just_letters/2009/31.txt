portfolio optimization under time varying
economic regimes
cory turner

jiho han

icme
stanford university
cgturner stanford edu

ms e
stanford university
jihohan stanford edu

i  i ntroduction
our paper aims to answer the question  can the macroeconomic condition be used to better allocate investments
among different sectors of a market  motivated by classical
markowitz portfolio theory  and prior work in attempting to
incorporate exogenous economic factors in portfolio optimization               we explore three approaches to dynamically
rebalance a portfolio as market or economic regimes change
continuously over time  traditionally  portfolio theory assumes
that a set of assets can be characterized by a mean return and a
covariance matrix  which are stationary over time  empirically 
it has been found     that this stationary assumption does not
hold  indeed  the behavior of a group of assets is materially
dependent on many observable and unobservable economic
factors which change over time 
a  background  markowitz portfolio theory
given a vector of returns for k sectors r    r       rk   with
ri    rit        rit n    define the mean  and covariance matrix
 as
           k  
   cov ri   rj   ijk
markowitz portfolio theory states that the efficient portfolio
which gives the maximum risk adjusted return for a given level
of risk aversion factor  is the following 
w   argmaxw wt r  wt w
subject to wt      
in general  this quadratic optimization cannot be solved in
closed form  and requires the use of a quadratic programmer 
we used the cvx toolbox for matlab  and quadprog in r 
the main goal of our work is to find plug in estimates for the
mean vector  and covariance matrix  which vary over time 
b  outline
the rest of the paper is organized as follows  in section
ii  we describe the macroeconomic and sector return data
being examined and demonstrate how principle components
analysis can reduce the dimension of the economic space  in

section iii  we explore two economic proximity based weighting scheme for estimating better mean vector and covariance
matrix  the first approach identifies in discrete economic
regimes using k means  we extended this idea to continuous
space using a gaussian kernel in the second approach  in
section iv  we depart from the markowitz framework and
reformulate portfolio construction as a reinforcement learning
problem  using fitted q iteration  we look for the optimal
policy given a economic state  in section v  we evaluate
the performance of different strategies and compare to the
benchmarks  finally  section vi concludes the paper 
ii  data c ollection and pca
a  sector indices
since there are not enough sector industry indices with long
history      years   we decide to construct a set of indices
ourselves  using russell      as an underlying universe 
we group the index constituents by   digit global industry
classification standard  gics  for the period from january
     to march       then  we form    equal weighted
sector portfolios at the beginning of each month and calculate
returns assuming   month holding period  dividends are
assumed to be reinvested to the stock on the ex dividend date 
the description of the sectors is shown in appendix a 
in constructing the indices  we ensure that there is enough
number of stocks in each sector so that index returns are not
driven by a few stocks  since russell      is a well known
large cap index  we expect each constituent to have sufficient
liquidity and low transaction cost for trade  in other words 
we believe that these sector index returns can be replicated at
reasonable cost in real practice 
b  economic data
the primary source of economic data is federal reserve
bank of st  louis  the fed collects numerous economic data
from several sources and allows users to download them
as text files  we gather a set of    economic indicators we
believe has significant impact on certain sectors as well as on
general economy  the list of macroeconomic information is
shown in appendix b 

fiin order to minimize look ahead bias when trading  we lag
these economic data by     months as appropriate  for example  we assume the gdp figure for     q   which ended in
march  became available for trading on may  unfortunately 
there is no easy solution for look ahead bias due to revisions 
as far as we know  there is no comprehensive point in time
database that tracks the changes in macroeconomic indices 

  

 

  
  
lgdpc  d

  

    

payems d
credit
unrate
lpce d

  

cpifesl  d

    

gs  

    

    

    

    

comp  

 

biplot relationship of  st and  nd pc

vg

jgj
 

zgmgs

 
 
 
 
 
 
 

 

 
 

 

pc 

 

 

 

 

 

 

kgj

 

 

 

fig    

pc 

towards this  we attempt to make sense of the pca
decomposition to determine if the results make sense
fundamentally  looking at the biplot relationship between the
first two pcs in figure    we find that the first pc  clearly
indicates a clustering of projections of economic indicators
in a sensible way  in the right half of the plot  the vectors are
generally negative economic indicators  unrate  credit   while
on the left half  the vectors are generally positive indicators
 gdp  payrolls   the second pc seems to be related to an
inflation metric  with high inflation represented on the bottom
half  and low inflation on the top 

unrate d

lipmat  d lgdpc d
lindpro  d
lipcongd  d
lipbuseq  d
napm

    

recall that our goal is describe the expected relationship
between a group of sectors conditioned on the current
economic condition  towards this end  we would like for
our economic decomposition in the reduced space to cluster
when according to when economic condition is similar
in some sense  if we can get this  then we can reasonably
expect that the mean t and covariance t generated by
weighting observations at time s   t by the distance between
the economic condition at time t to that at time s 

  

 

    

comp  

lpce lgdpc 
oilprice

since our economic time series data is of varying lengths 
at each point in time for which we compute an economic
decomposition  in order to use complete series  we select
only a subset of our    economic indicators  this is achieved
heuristically by optimizing the tradeoff being number of
economic indicators  and length of the available series  by
maximizing the product of these two quantities 
having selected the economic indicators  we perform pca 
and choose the number of pcs that explain at least     of
the variance in the economic condition as our model selection
criteria  using this decomposition  we can represent an
economic state at time t as the projection of the observation
at time t onto the first n pcs  we denote this state vector as st  

  

    

c  economic dimension reduction using pca
the economic time series collected can all be thought of as
proxies for the economic condition at time t  and although
each is a different measure  it is reasonable to assume that
they can be largely described using a lower dimensional
space  to reduce complexity of optimizations in subsequent
sections of this paper  and to gain an intuitive understanding
of the underlying economic state space  we perform principle
components analysis  pca  on the standardized indicator
series to reduce the dimensionality 

  

    

  

    

fig    

    

    

    

    

projection of economic state onto first two pcs

figure   plots the projection of the economic state onto
the first two principle components since the     s  notice
that the pc clearly identifies serious recessionary periods in
history  from the oil shocks of the     s  to the credit crisis
of            this validates that our economic decomposition
is stable and is capable of identifying economic regimes  we
now proceed to condition our portfolio optimization decisions
on this information 
iii  e conomic p roximity based w eighting
a  discrete states  k means clustering
in our first approach  motivated by prior work  we attempt
to identify discrete economic regimes   e g   good vs  bad
economy in   state regime   within which we may expect the
mean vector t and covariance matrix t to be stationary 
to do this  apply k means clustering algorithm over all

fifinally  we compute the sample mean and covariance all
observations that fall into the same cluster as the current
economic state st   and use the resulting mean vector t and
covariance matrix t in our convex optimization problem
from section    please see the evaluation section for results
and discussion 
one observation made during this exploration was that it
appears to take an arbitrarily large number of clusters to
describe the n dimensional pca economic state space  as
new observations frequently generated new clusters  which
is causing us to lose a lot of training data  this motivates
the idea of using all observations  but weighting them in
continuous space 
b  continuous state  gaussian kernel
a natural extension of the discrete regime idea in the previous
section is  assuming that there are arbitarily many states in the
economy  come up with a way to generate conditional mean
vector t and covariance matrix t using weighted sample
statistics of all observations training window  weighted by
some measure of how similar the current state st is to each
of the previous si  
this is achieved by weighting each observation by a gaussian
kernel  such that wi   exp  si  st  t   si  st     where
 is a diagonal bandwidth matrix that tunes how quickly
the weights decay  the value of  was tuned by empirically
maximizing the tradeoff between assigning near zero weight to
too many observations  and not clearly discriminating between
economically dissimilar states  figure   plots a sample of the
weights for      to       notice that this was a recessionary
period  and higher weights are given to prior periods under
which the market was in distress 
next  since we want our portfolio to be fully invested  we
normalize the weights wi to sum to    and generate the
conditional mean vector t and covariance matrix t as
t  

t
  x
 ri wi  
m i tm

t   cov ri s ws   rj s ws  tmst  ijk

   
   

   

   

   

   
   
   

next  we project the current economic state into pca space
to obtain st   and attempt to determine if the current number
of clusters is sufficient  we do this by testing the hypothesis
that the current economic state is a new cluster  which is
evaluated by comparing the silhouette statistic between the
two models  if a new cluster is required  we create one 
otherwise  we assign the current economic state to an existing
cluster 

   

   

observations in the training window of m months to cluster
the economic condition in pca space  p c    p c         p cn  
around k centroids 

    

    

fig    

    

    

    

    

gaussian kernel weights wi at t     

as before  we use estimates as plug in estimates for the
convex optimization problem posted at the start  please see
the evaluation section for results and discussion 
iv  r einforced l earning   f itted q  iteration
while the previous approaches have appealing economic
logic and supportive result  they are still based on and  in
a sense  confined by markowitz framework  departing from
this classical theory  we reformulate portfolio construction
decision as a reinforced learning problem whose objective is
to find the optimal sector weighting policy given the current
economic state  in doing so  the immediate difficulty we
face is that both our state and action spaces are continuous 
high dimensional spaces  although reduced in dimension
through pca  economic state s still requires     dimensions
whereas action space a lies in    dimensional constrained
space  to solve this issue  we resort to a variant of fitted
q iteration  fqi  called advantaged weighted regression
 fqi awr      
a  fqi using advantage weighted regression
fqi is an iterative algorithm to approximate the state action
value function q   sar using historical state action pairs
 s  a   the estimated q functions are searched over the action
space a to find the optimal value function v s   the updated
value functions are subsequently used for finding better approximation of q and the process repeats  however  during the
value update  the greedy operation v s    maxa q s  a  often
becomes prohibitively expensive for the continuous action
space  fqi awr handles this situation by replacing the costly
max operator with the weighted regession estimate v s 
whose weights are derived by advantage a   q s  a   v s  
more specifically  awr algorithm performs updates according
to the following equations 
q function update
qk    s  a    sa  sa t w sa    sa t w qk
v function update
vk    s    s s t u s   s t u qk  

fi 
 
 

 
 

the awr procedures described above have two very intuitive
features that differentiate itself from the previous approaches 
first  it measures the similarity based on both state and
action  this enables us to appropriately evaluate the cases
where economic situations are similar  but the actions taken
are quite different  secondly  the value updating step based on
normalized advantage inherently awards the good actions  i e  
making positive returns  while penalizing the bad actions 
for instance  suppose we have an observation in history that
is economically similar to the current state  but the action
taken at that time resulted in a very negative return  the
natural response is not to repeat the same mistake and awr
updating policy exactly perform this task 

 

 

fittedq
gaussian
kmean
markowitz
equal

 

where sa    st   at  t   sa    sa      sa           sa t    is the
state action matrix with the associated diagonal weight matrix
wii   ws  si  wa  ai    s    st    st         stt   is the state only
matrix whose weight is given by uii   w s u s  a  where u
is the normalized advantage  a    at    at         att   represents
the action matrix      notice that  we need a distance metric
for the action space in order to compute w   as in the
economic state case  we use gaussian kernel 

 

 s    s s t u s   s t u a

markowitz optimization  we impose two constraints      the
weights add up to   and     the maximum bet of    from
the equal weighted portfolio  the backtest result for these
five portfolios is shown in figure   and in table i 

 

policy update  after vk converges 

    

    

fig    

    

    

    

    

backtest result from jan      to mar     

equal markowitz k means gaussian fitted q
ann  return            
                 
info  ratio     
    
    
    
    
table i
backtest p erformance r eturns and i nformation r atios

b  implementation issues
fqi awr framework is straightforward and  for the most
part  directly applicable to our setting  however  there are a
few places where we make implicit assumptions or deviate
from the standard model as we see necessary  we clarify
these points here  first  we set our initial policy as the
benchmark markowitz weights plus a random turbulence term 
the random turbulence is taken from a normal distribution
n              adding turbulence allows to look at the paths
different from markowitz portfolios  second  our reward function is solely the return generated from the action chosen  we
do not consider the risk implied by markowitz model  third 
during the final step of applying the optimal policy to the
current state  we rescale the weight vector s s t u s     s t u
so that it sums up to    while it is unconventional  we
need this additional step to ensure fully invested portfolios 
conceptually  this is equivalent to adjust the bandwidth of
locally weighted regression 
v  e valuation
we evaluate the efficacy of our economic similarity based
methods against two benchmark portfolios  the first is the
equal weighted index  which is equivalent to invest the same
proportion of money to each stock in the universe  the second
benchmark is the portfolio formed by markowitz optimization
with no economic prior  we simply take the past    months
of return and calculate mean and covariance matrix with
equal weights  moreover  for any portfolio that goes through

all of our three methods outperformed the benchmarks both
in term of annualized return  we repeat backtests with varying
combination of parameters  such as maximum bet  bandwidth
for gaussian kernel  etc  although the result of fqi portfolio
may vary stochastically due to the turbulence term  the overall
performance of economic similarity based methods is clearly
better than the benchmarks 
vi  c onclusion
our research is based on the presumption that sectors behaves
in similar ways under similar economic conditions  to test
our hypothesis  we first apply pca to a set of macroeconomic
variables to reduce the dimension of economic states  the
resulting principle components successfully captures the
major economic trends as well as other aspects of economy 
e g   inflation concern or credit tightening 
we compare three methods of incorporating economic
similarities into portfolio construction      k means clustering 
    gaussian kernel distance  and     fitted q iteration  fqi  
while all of the three methods outperformed the benchmarks 
the first two are a modification of classical markowitz model 
in the calculation of expected return and covariance matrix 
in a departure form the assumption that these quantities are
stationary  we compute weighted sample statistics  giving
more weight to the observations which correspond to a
similar economic state  the third approach poses the question

fiinto a reinforced learning framework  directly searching for
the optimal policy using simulated strategy return pairs  to
cope with high dimensional  continuous state action space 
we adopt advantage weighted regression technique that
expresses the optimal policy as a weighted sum of previous
actions  since we only reward return and do not penalize risk
 covariance   the resulting policy gives the highest return but
the information ratio less than the second method 
given the significant improvement in our result  we believe
that  to a certain degree  history does repeat and portfolio
optimization can benefit from not only taking economic similarities into consideration but also evaluating the effectiveness
of the actions taken under those circumstances 
vii  r eferences
    n  chen  r  roll  and s  ross  economic forces and the stock market 
journal of business  vol           
    j  stangl  b  jacobsen  and n  visaltanachoti  sector rotation over
business cycles  mar       
    r  madrid  k  mcneil  j  miller  e  slover  and b  zimmerman  economic forces and stock sectors  dec       
    j  shanken and m  i  weinstein  economic forces and the stock market
revisited  journal of empirical finance  sep       
    t  l  lai and h  xing  statistical models and methods for financial
markets  new york  ny  springer       
    g  neumann and j  peters  fitted q iteration by advantage weighted
regression  advances in neural information processing systems   
 nips             

viii  a ppendices
a  appendix a   underlying sectors
gics  code
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

description
energy
materials
capital goods
commercial services   supplies
transportation
automobiles   components
consumer durables   apparel
hotels  restaurants   leisure
media
retailing
food   staples retailing
food  beverage   tobacco
household   personal products
health care equipment   services
pharmaceuticals   biotechnology
banks
diversified financials
insurance
real estate
software   services
technology hardware   equipment
semiconductors   semiconductor equipment
telecommunication services
utilities

table ii
u nderlying s ectors   s ource   r euters

b  appendix b   economic indicators
name
umcsent
umcsent d
lgdpc  d
lgdpc d
tdsp
tdsp d
lpce d
lpce logdpc 
unrate
unrate d
payems d
credit
term
dfedtar
gs  
oilprice
cpifesl  d
dgorder  d
dgorder d
napm
tcu
lindpro  d
lipmat  d
liputil  d
lipmine  d
lipbuseq  d
lipcongd  d

description
university of michigan  consumer sentiment
  month change of umcsent
   month change in log of gdp
  month change in log of gdp
household debt service payments
  month change of tdsp
  month change in log of personal cons  exp 
log pce    log gdpc  
civilian unemployment rate
  month change of unemployment rate
  month change of nonfarm payrolls
credit spread  baa   aaa 
   year treasury     year treasury cm rate
federal funds target rate
   year treasury constant maturity rate
oil price   west texas intermediate
cpi all items ex food   energy      month change
durable goods order      month change
durable goods order     month change
ism manufacturing  pmi composite index
capacity utilization  total industry
industrial production index
industrial production  materials
industrial production  electric and gas utilities
industrial production  mining
industrial production  business equipment
industrial production  consumer goods

table iii
e conomic i ndicators   s ource   s t  l ouis f ed

fi