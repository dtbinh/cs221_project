crf based point cloud segmentation
jonathan nation
jsnation stanford edu
   introduction
the goal of the project is to use the recently proposed fully
connected conditional random field  crf  model to
segment a point cloud scene      the dense crf model has
previously been used with positive results to enhance the
accuracy of labeling of images 
since devices to capture point clouds easily are relatively
recent  kinect   there has not been much research into
segmenting out objects from a point cloud  previous work
in the segmentation of  d point cloud scenes has usually
involved the extracting geometric primitives using features
like normals and curvatures         other research has
focused on segmenting out a single object foreground from
the background in a semi supervised or unsupervised
manner      none of the prior work found covers the
segmentation of a class of objects from a single instance of
that object  which is the main focus of this current work 
segmenting objects out of a point cloud scene is a difficult
task with many steps  first is to collect a dataset of several
objects to segment out and a background  then the dense
crf model is initially used with position based point
features  position   normals   color   next  position
independent features are used  like normals calculated at
different scales  and more invariant features like point
feature histograms  the unary potentials of the dense crf
are initially determined by one or more user specified
points in the scene  providing a semi supervised
segmentation of the scene  the goal is to move towards
fully unsupervised segmentation of the scene 

with  d sift features and ransac for an initial pose
estimate and icp for refinement  due to the large amount
of variation in features between the images  due mostly to
self occlusion in the scene from the mugs  the features
based reconstruction failed to produce a high quality scene 
instead  a control point selection tool was devised to select
    corresponding points between each image and estimate
the pose to fit those selected points  and then use icp to
refine the pose  this resulted in a high quality reconstructed
scene  the process was made more efficient without much
loss of quality by using feature based pose estimation on
pairs or small groupings of images  and then using manual
control point selection to align those groups together  the
resulting point cloud scenes are shown in figure    both
scenes had a voxel grid sampling applied to them with a
grid size of    mm to reduce the abundance of overlapping
points after registration  scene   contained approximately
        points and scene   had approximately        
points 

   dataset
the data is  d point cloud scenes collected using the
microsoft kinect  the first scene consists of   mugs of
various shapes  colors  and sizes  sitting on top of a circular
wooden table  the mugs serve as the foreground object and
the table the background 

    collecting the dataset
over    point clouds snapshots were collected from all
angles around the scene  and then reconstructed using
different reconstruction techniques from point cloud
library  first  individual point clouds had to be
preprocessed to clean them up and reduce noise  for each
point cloud captured  a depth filter was used to filter all
points outside the range of the scene  table   mugs   then 
a radial outlier removal filter was applied to each point
cloud  removing all points with less than a threshold of
neighbors within a given search radius 
several techniques were attempted to get a clean
reconstruction  including using feature based reconstruction

figure    point cloud scene   with   mugs on a wooden
table

    labeling the dataset
the dataset for scene   was labeled with   categories in
order to use it to evaluate different segmentations  the
categories were mug   table   and unknown  a tool for
labeling a point cloud scene of this type efficiently was
created  allowing the user to label all points on one side of
a plane  or to label in different sized radial patches of
points  any ambiguous or spurious points in the scene 
especially around the table mug interface  were left as
unknown points  the labeled scene is shown below in
figure    with green representing table  red representing
mug  and natural pixel color representing unknown points 

fipreselected point on one mug  and a single point in the
middle of the table 

figure    crf segmented scene   using a single
preselected point on the mug and table  with
parameters adjusted by slider

figure    point cloud scene   ground truth labeled as
mug  red   table  green   or unknown  scene color  

   crf segmentation
    segmentation with position features
the crf model of segmentation was applied to the scene
to segment out mug from table  the crf model involves
both unary and pairwise potentials defined for the scene 
unary potentials should ideally be computed using point
features and define a prior probability over the label
assignments for each point  at this point  a fixed unary
potential was used for pre selected mug or table points 
using a fixed value of    for the non assignment penalty 
for all unspecified points  the unary potential for both
assignments was set to   

in order cleanly segment all three mugs from the scene
using this approach and set of features  at least one point on
each mug needs to be specified  the results of specifying a
point on each mug and   points on the table are shown
below in figure   

initially  pairwise potentials with combinations of gaussian
kernels of normals  positions  and colors were used 
pairwise potentials specified with gaussian kernels of the
form in equation   were used  with p representing the  d
position vector  n representing  d normal vector  and i
representing the   component point color 
           exp 


  


       exp 



  



 





       exp 



  







  







   

there are many free variables to be optimized in these
pairwise potentials  including the position  normal  and
color gaussian weights  the position scaling for each
feature  and the normal and color weightings  also  the
number of iterations can be adjusted  but convergence was
generally achieved within    iterations  in order to gain
intuition on the effects of the different parameters of the
pairwise potentials in potts model used  an interface with
sliders for each of the variables in the potentials was
constructed and used to vary each value and see the effect
immediately  figure   shows the sliders used to adjust the
values  and the results of a segmentation using a single

figure    crf segmented scene   using a single
preselected point on each mug and   points on the table 
brighter colors represent higher probabilities in

    segmentation in feature space
in order to have the unary potentials selected at a point on
one object propagate the labeling to the other similar
objects in the scene  non position dependent features must
be added to the pair wise potentials of the crf  these
features should be descriptive of the object  i e  by
modeling its relation to the points around it in some
meaningful way  also  these features should be poseinvariant so they are consistent on objects of the same class
in different orientations  point normals calculated at three
scales were attempted initially  and while these did provide

fia good measure of the geometry around a point  they were
not rotationally invariant  rotationally invariant nonposition based features will propagate the unary potentials
initially to object points of similar geometry  while the
position based features used earlier will allow those initial
propagations to continue to label each object correctly  for
example in scene    an initial point selected on the top of
one cup will propagate through feature space to the top of
the other cups  and then position based features will
continue the propagation down the rest of the cup 
      point feature histograms
point feature histograms  pfh   and specifically their fast
variant  fpfh  were used as a measure of the geometry in
the k neighborhood about each point         fpfh have
been shown in prior work to be a consistent and descriptive
feature used in  d scene registration  so they are well
suited to this application as well  for a given normal radius
and feature radius  for each point the fpfh looks at the
interaction of that points normal with every other point in
its feature radius neighborhood  the difference of each pair
of points normals and positions are encoded into   angular
variations  and these variations are binned  because they
have a finite range  for all pairs of points in the kneighborhood  fpfh have    bins for each of the  
independent angular features  resulting in    values total 
while these features were seen to work well at describing
the geometry of a each point  using    or more features in
the pair wise potentials is too computationally costly for
the crf model 
      pca on the fpfh
principle components analysis was used on each scale of
fpfh separately to reduce the number of features  pca
was also tried on all fpfh scales together  but this
provided less benefit as the ability to give a different
weighting to different scales of fpfh was lost when they
were all combined together  figure   shows a sample of the
pca variance curve for the fpfh features at any given
scale  from the curve we can see that choosing  
components represents      of the variance  and choosing
  components is       four components were found to
work well  considering that since   scales of fpfh were
used there would be some overlap in data 

  variance
represented

 

   

 
 

  

  

  

  

number of principle components

figure    percentage variance covered per components of the
pca on fpfh features  similar for each scale 

      results of feature space segmentation
feature space segmentation using   scales of pca
calculated fpfh features was found to provide very good
results on segmenting out multiple objects of a class given
prior knowledge of one of those objects  figure   shows the
results of a segmentation using the same initial two points
as in figure    but now all   mugs are segmented out
correctly  a measure of correctness of the labeling was
computed by finding the number of points in each label that
are within the truth label  and also the number of points
mislabeled as the wrong truth label  the labeling of the two
non selected mugs in the scene were approximately      
correct with       mislabeled points 

figure    crf segmented scene   using the same two points as
unary potentials as in figure   

   more complexity and unsupervised
    greater scene complexity
since the parameters of the dense crf model were found
to support the segmentation of scene    it is possible and
very likely that this model is over fit to the specific objects
of scene    creating new scenes is a very time consuming
process  so it was not possible to create a large number of
scenes and learn the best parameters for the crf model
under the time constraints  two other scenes was created
using a larger number of object types    or     and more
complicated orientations of objects  figure   shows one of
the new scenes collected  scene    after its reconstruction 
this scene includes   cups  one on its side   two small
orange pumpkins  and   larger white pumpkins  the
pumpkins can either be separated into two different classes 
or combined into a single pumpkin class  as their
underlying shape is the same  just their scale is different 

fifigure    scene   containing   mugs of varying orientations 
and   pumpkins  which could be divided into   size
subclasses  

the parameters used for the crf model of this more
complicated scene were nearly identical as those for those
of scene    the only difference was an increased weight for
the pca fpfh features at the largest scale  probably due to
the inclusion of objects at a larger scale such as the large
pumpkins  this suggests a limitation of the fpfh features
in that they are not scale invariant measures of shape  and
because of that different scales of fpfh features will be
necessary depending on the scale of objects you are
attempting to segment out 

figure    crf segmentation of scene   with   labels  top  and
  labels  bottom  

figure   shows the results of the crf segmentation on
scene   when using both   and   labels  for both  the same
  points are selected for the unary potentials  one on a
single object of each class  mug  small pumpkin  large

pumpkin  and table  the mug in the bottom left corner of
the scene images exhibits the largest amount of
mislabeling  this could be due to its scale and shape of the
mislabeled portion most closely resembling that of the large
pumpkin  the mislabeling of the bottom left mug can be
remedied completely by selecting a single point on that
mug as an additional unary potential  this suggests that an
iterative segmentation scheme allowing user input will help
to correct any errors obtained in an initial segmentation  as
the number of preselected points increases  the reliability of
the segmentation increases dramatically  also  it is worth
noting that the mug to the left of the center  which is tipped
over so its handle is pointing upwards  is segmented out
well in both cases  despite it being in a vastly different
orientation then the mug with the preselected point to the
right  this suggests that the fpfh features rotationinvariance will work well for discriminating between
similar object geometries in different poses 

    unsupervised segmentation
the goal of this research was to move towards fully
unsupervised segmentation of the point cloud scenes  so
far  the unary potentials for the dense crf model were
specified in advance for a single point in each object
category  and left as zero for all other points in the scene 
though it is not difficult to select one point for each object
category  this involves some user supervision of the
segmentation  to move to an unsupervised segmentation 
the unary potentials in the scene would have to be
determined without any user input other than the number of
possible classes 
one was this can be done is by using an unsupervised
clustering algorithm to cluster the scenes points  and then
using this initial clustering to generate the unary potentials
for the dense crf model of the scene  a modified version
of k means clustering was used on the fpfh features in the
scene to create the unary potentials  the normal k means
algorithm was applied  using the standard euclidean
distance between the pca fpfh features of each point 
the convergence of k means was dependent on the number
of clusters specified  for   clusters  convergence was
usually scene in     iterations for both scenes  while for  
clusters  convergence would take about    iterations  after
k means had converged  soft assignments for all points to
all cluster were computed  and then a ratio of distance to
any one cluster over the distance to all clusters combined
gave a measure of how likely a point was in any given
cluster  one minus this value  normalized by the number of
clusters minus    gave a score from   to   of how likely
each point belonged to each cluster  summing to one over
all clusters   this value was used to determine if a unary
potential should be set for the point  and what value it
should be set at  several schemes for determining the unary
potentials from the k means soft assignments were
attempted  it was generally better to only define unary
potentials on points that were clearly belonging or not
belonging to a certain label  this results in using the   

fithe results for performing k means segmentation on scene
  before and after applying the dense crf refinement are
shown below in figure    the k means only segmented
image over labels the mug points      mislabeled  
selecting some features that have similar geometric
properties  like the edges of the table  to be mugs as well 
performing the crf on using unitary potentials generated
from the k means reduces the percentage of mislabeled
mug pixels asymptotically to near      after many
iterations 

  
  mislabeld mug points

points with the most confident labeling from the k means to
seed the unary potentials  the actual level of this
confidence varies between scenes  but choosing a
percentage of the points in the scene to use seemed to work
well on the scenes used  for scene    this consisted of
taking all the points with clustering scores greater than
     higher than random       

  
  
  
 
 
 

  

  

  

iterations of crf
figure     the percentage of points mislabeled as mug  red 
for the example in figure    by the number of iterations of the
crf    crf iterations is the k means segmentation only 

figure    shows the error as   of mislabeled mug points
vs  the number of iterations used in the crf  just two
iterations reduces the error by over half to     the dense
crf model is able to quickly improve on the clusters
produced by k means alone  producing a cleaner clustering
of the input scene 

   conclusions
the dense crf model has been shown to produce good
results in segmenting point cloud scenes  a large collection
of datasets need to be examined in the future to see how
well the model generalizes a set of objects  the similarity
in parameters found for the two scenes suggests the model
should generalize well  future work include finding a
dataset and using it to learn specific parameters to the crf
model to test the models generality  preliminary tests with
unsupervised segmenting with the crf model show
promise  but more methods of initial unary potential
generation should be examined  further work also includes
finding which features are most distinctive for the data 

   acknowledgements
the author was advised by philipp krahenbuhl in the generation
of ideas and extending his earlier work in     to this new domain 
references
    krahenbuhl  p   koltun  v  efficient inference in fully connected
crfs
with
gaussian
edge
potentials 
http   graphics stanford edu projects densecrf
    t  rabbani  f  van den heuvel  and g  vosselmann  segmentation
of point clouds using smoothness constraint  in
ievm         
    r  unnikrishnan and m  hebert  robust extraction of multiple
structures from non uniformly sampled data  in iros 
volume    pages         october      
    golovinskiy  a  and funkhouser  t  min cut based segmentation of
point clouds  in ieee   th iccv workshop       
    rusu  r b   et al  persistent point feature histograms for  d point
clouds  in ias       

figure     k means only labeling  top   and k means used to
find the unary potentials for crf segmentation  bottom 

    rusu  r b   blodow  n  and beetz  m  fast point feature histograms
 fpfh 
for
 d
registration 
in
icra 
 

fi