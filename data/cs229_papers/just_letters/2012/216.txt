automated analysis of calcium imaging data
helen horan yang
cs    final project  fall     
introduction
in virtually all biological systems  calcium ions  ca    are essential intracellular signaling
molecules  but they are particularly important in the nervous system  ca   is required for neurons to
release synaptic vesicles  which is the major method by which they communicate with downstream
neurons  measuring increases in ca   concentration around these release sites is therefore a readout
of the neurons output signaling  and one can correlate this to particular stimuli presented to
characterize the neurons response properties  grienberger and konnerth         this information is
important for understanding how neural circuits respond to and shape the signals that they receive from
the environment to perform complex computations 
calcium imaging is the technique by which one measures these changes in cellular ca   levels 
briefly  cells are made to contain a calcium indicator  a molecule that fluoresces only when it binds
ca    fluorescence intensity is thereby a report of ca   concentration and the cells responses  this is
captured in real time with a fluorescence microscope and a ccd camera  raw calcium imaging data is
in the form of a time series of images where the intensity of each pixel is the fluorescence intensity at
that location  grienberger and konnerth         however  the unit of interest is a cell  not a pixel  and
typical calcium imaging experiments capture several to several dozen cells in one field of view  to be
able to make meaningful biological conclusions  each cells responses must be isolated from other
cells and the background 
despite the recent advances in calcium imaging technology to improve the performance of both
calcium indicators and fluorescence microscopes  grienberger and konnerth         the extraction of
cellular responses is mostly performed by manually or semiautomatedly selecting regions of interest
 rois  that correspond to single cellstracing cell outlines or setting an intensity threshold  for
example gbel and helmchen        ozden et al          not only is this time consuming  it can
introduce noise into the signal if the boundaries of the roi are not precise and include other cells or
background  in some situations  spatial overlap is unavoidable as the microscope captures
fluorescence from cells slightly above or below the imaging plane of focus  more clever analysis
techniques for isolating cells should be able to improve performance and decrease the amount of
human labor required 
for this project  i have applied machine learning algorithms to automatically extract cellular
responses from my own calcium imaging data  which i was previously isolating by manually outlining
rois 
data acquisition and preprocessing
the analyses described below were performed on data collected by imaging a particular cell
type in the fruit fly drosophila visual system known as l   l  receives direct input from photoreceptors
and functions as an input to a pathway specialized to detect moving dark edges  clark et al         
briefly  single flies were stably mounted such that their eyes viewed a screen on which visual
stimuli were presented  and the back of the head was exposed to allow the microscope objective
access to the brain for imaging  the calcium indicator tn xxl was expressed specifically in l   that is 
the flies were genetically engineered such that their l  cells made the tn xxl protein  l  axon
terminals in the medulla  the neuronal output sites located in a particular brain region  were imaged
using two photon fluorescence microscopy  two longer wavelength photons must be absorbed
simultaneously for one to be emitted   when stimulated at    nm  tn xxl emits at     nm when it is
bound to ca   and     nm when it is not  mank et al          both channels were collected during
imaging and are hereafter referred to as ch  and ch   respectively  tn xxl is therefore ratiometric  and
a cells ca   response is characterized by ch  ch  
imaging data was acquired at a constant frame rate of     hz using a frame size of    x    
pixels  this field of view fits approximately   to   l  terminals  the presented visual stimulus was a
light bar with a width of      of the flys visual field moving in one direction at     sec on a dark

fibackground  the bar was oriented either horizontally and moving vertically or vice versa  the screen
was dark for   seconds and then the bar moved across the screen in   seconds  the bar moved in all  
possible direction orientation combinations       imaging frames were captured while the stimulus was
presented 
although the fly is mounted to minimize movement  it is not completely eliminated  before any
analysis was performed  lateral movement artifacts were corrected for by aligning the image time series
using an imagej macro based on turboreg  which matches images based on distinctive landmarks
 thvenaz et al          alignment was done using ch   in which cellular structures are more apparent 
and ch  images were shifted to match 
analyses
manual selection of regions of interest
before discussing the approaches i took to automatically extract cellular signals from the
aligned image time series  i will first describe the method i had previously been using 
the ch  aligned image time series was collapsed along the temporal dimension by averaging
the intensity at each pixel to generate an average image  rois corresponding to individual l  terminals
were identified by eye and manually outlined  a background region in which no cellular fluorescence
was apparent was also manually defined  for each cell and the background region  the fluorescence
intensities were averaged across all of the pixels in the roi for each frame to generate average ch 
and ch  time series  the average response of the background region was subtracted from each cells
responses  and then the ratio between the two channels was determined  the end result is that the
calcium response of each l  cell is described by a single time series of ch  ch  ratio values  these
ratios generally range between   and    figure   shows a typical example of the responses derived
from   cells in one field of view 
figure   responses of cells identified by
manual selection of rois 
 a  average image for ch  
 b  in color are the rois corresponding to
individual l  terminals  the white roi is
background region 
 c  responses of the cells spatially defined in
 b   the colors of the rois and traces
correspond  the color traces are the ch  ch 
ratio values  and the desaturated traces behind
them are the ch  and ch  responses before the
ratio is taken  the step function at the bottom
describes the stimulus  with each different value
corresponding to a different direction that the bar
moves  each l  observes a point in space and
responds by decreasing and then increasing its
  
ca concentration when the bar crosses this
region  adjacent cells respond to adjacent points
in space  black arrows denote the responses to
the moving bar   

k means for region of interest identification
as stated above  the goal of this project is to automatically extract cellular responses from an
aligned image time series  for the greatest utility  the method taken should be able to identify these
responses using the image time series and as few additional parameterswhich must be manually
tunedas possible  furthermore  it should perform comparably to or better than manual roi selection 
this is therefore an unsupervised learning problem  that is  i could train a supervised learning

fialgorithm to identify rois by using the set of manually defined rois and average images i have
already collected  but this would require a large time investment if i wanted to examine other cells in the
fly visual system  and there certainly exist cells with similar response properties but different
morphologies  or if i do not have enough l  training data and is unlikely to perform substantially better
than manual roi identification 
i applied the k means clustering algorithm to the aligned image time series data  the image
time series data was collapsed from    x     x       representing spatial width x height x time  to a
       x      matrix  representing pixels x time  that is  each of the m        pixels is a training
example x i  and is described by n      variables  the value at each time point  applied to this training
set  k means identifies clusters of similar pixels  which would ideally correspond to individual cells and
the background  these can then be analyzed in the same way as the manually identified rois to
extract the cellular responses 
i first performed k means on the
raw intensities of the ch  image time
series using k    clusters for the    
cells and the background 
disappointingly  the clusters did not
correspond to individual terminals but
instead to similar regions in each of
terminals  figure  a   the identified
regions were vaguely similar to the
intensity gradients across the cells in the
average image  so i hypothesized that
similarities among pixels corresponding
to a single cell were overwhelmed by
differences in the raw intensities within a
cell  i therefore calculated the ratio
between ch  and ch  for each pixel at
each time point and performed k means
on this training set  while this did seem
to eliminate the effects of raw intensity
differences  the clusters were still
spread among multiple cells and
showed no apparent pattern within a
single cell terminal  figure  b  
however  this did clearly
separate the cells from the background 
so i repeated the clustering with k   
which did indeed form a cell cluster and
a background cluster  figure  c   in the
cell cluster  all contiguous pixels were
grouped together  and any regions
figure   rois and cellular responses identified by kexceeding     pixels in area were
means clustering 
called cell rois  figure  d   the
 a  clusters identified by performing k means on ch  raw
intensities  each gray scale value is a different cluster  k   
extraction of cellular responses from
 b  clusters identified from ch  ch  ratios  k   
these spatial rois was performed as
 c  clusters when k    cluster    black  was used as the
above  figure  e   this method of
background and cell rois were extracted from cluster    white  
identifying rois performed comparably
 d  rois called as individual cells overlayed on the average
to the manual method over many data
ch  image 
sets  not just the one shown in figure   
 e  responses of the cells defined in  d   compared to figure
in fact  the cells responses to the
 c  the responses to the moving bar  black arrows  are more
moving bar seem to be more apparent
apparent 
in these traces  possibly because they
are less noisythe standard deviation

fiof the ch  ch  ratios for each k means trace was less than that of the manual trace for the same cell
 mean difference          n    cells  
spatiotemporal independent component analysis
identifying rois using k means clustering is an improvement compared to manual roi
selection  however  averaging over rois collapses any spatial variability or noise in favor of extracting
a purely temporal response  calcium imaging data can be thought of as a mixture in both space and
time of signals from statistically independent sourcesthat is  cells  extraction of these sources would
thereby provide an estimate of the cells locations and responses  unlike roi analysis  these signals
are constrained to be independent and should therefore have less noise from crosstalk in either time or
space 
independent component analysis  ica  can be used to isolate signals from independent
sources  in the cocktail party example we discussed in class  the goal was to separate out individual
speakers captured on multiple microphones  specifically  the speakers were the independent
component sources to be isolated  and the corresponding acoustic signal over time was the signal of
interest  the goal was not to isolate independent time points  each of which has an acoustic signal over
all of the microphones  however  calcium imaging data is a time series of images and the
decompositions corresponding to both situations in the cocktail party example make sense and
generate a set of images and a set of intensity changes over time  spatial ica  sica  seeks a set of
mutually independent source images and a corresponding set of unconstrained time courses  temporal
ica  tica  seeks a set of independent source time courses and a corresponding set of unconstrained
images  however  because either space or time is unconstrained  the resulting independent
components can be biologically improbable  spatiotemporal ica  stica  maximizes the independence
of both space and time  weighting one  and the other    where  is between   and    stone et al  
       and is ideal for calcium imaging where the goal is to isolate independent component cells that
each have their own spatial location and responses 
following the methods of mukamel et al  and stone et al  for stica using the fastica algorithm
 hyvrinen and oja         i performed stica on x   the        x      matrix of ch  ch  ratios 
briefly  x was preprocessed such that each row and
each column had zero mean  and it was whitened
using singular value decomposition  which reduces
the number of parameters to be estimated
 hyvrinen and oja         stica was performed
with      to equally weight the independence of
time and space 
the resulting spatial filter and time course of
the first independent component is shown in figure
   the filter does not correspond to a cell  and the
response over time does not resemble that
observed with roi analysis  the other independent
components are similar  thinking that perhaps
independence in space or time is more significant
 e g  there is minimal spatial overlap among the
cells   i varied   including    and   for pure sica
and tica  while the independent components
changed  they did not obviously resemble cells and
cellular responses more  i also performed ica with
subsets of the principal components  that is 
whitening transforms x such that its components
are uncorrelated  which is exactly the
figure   spatial filter and time course of the
transformation performed in principal component
first independent component of stica
analysis  this can often reduce noise and prevent
analysis on ch  ch  ratios 
overfitting  hyvrinen and oja        but with this
 a  spatial filter
data  did not noticeably improve the algorithms
 b  response trace

fiperformance  this is likely because none of the principal components explained a large percentage of
the variance or contained signals that were obviously non biological  ch  ch  ratios are occasionally
abnormally large when a particular ch  value drops close to zero  so i also tried ica on data for which
any data point that exceeded a threshold was set to that threshold  this eliminated the large spikes
observed in figure  b but did not significantly change the spatial filters or make the time courses look
more like the cellular responses  finally  i used the f f  for each pixel  divide by its mean value over
time and then subtract    of ch  as x  this is the normalization used when the calcium indicator is not
ratiometric and simply fluoresces when it binds ca   and does not when it does not bind  again  this did
not improve performance  i tried various combinations of the above described variations  but none of
them resulted in an algorithm that extracted cellular responses 
discussion
mukamel et al  used stica to extract cellular responses from calcium imaging data  but i was
unable to do so successfully  i hypothesize that this is because my data was collected using a different
calcium indicator  which has a much lower signal to noise ratio  snr   mukamel et al  used oregon
green     bapta   am  which is known to have greater amplitude responses than tn xxl
 grienberger and konnerth         the responses shown in figures  c and  e are typical for this
experiment  and examining those  it is apparent that the amplitudes of the responses to the moving
bars does not significantly exceed the amplitude of the noise  snr      in contrast  mukamel et al  are
working with signal to noise ratios one to two orders of magnitude greater than this  along these same
lines  it is also possible that their cells respond more strongly to their stimulus than l  cells to moving
bars  either way  i hypothesize that the ica algorithm cannot extract meaningful cellular responses
when these responses are difficult to distinguish random fluctuations  perhaps increasing the imaging
time or using a stimulus that causes the cells to respond more often would improve the performance 
since there will be more responses  but that would not be useful given my experimental criteria 
nevertheless  i used k means to identify rois corresponding to individual cells and could
extract cellular responses in this manner  compared to manually selecting the cells  this significantly
reduces the amount of human labor required  the only parameter that needs to be specified is the
minimum area of a cell  which can be set just once since l  terminals are all approximately the same
size  furthermore  performs slightly better in that the traces have less baseline noise  overall  this
method improves how i analyze my calcium imaging data 
references
clark  d a   bursztyn  l   horowitz  m a   schnitzer  m j   and clandinin  t r          defining the computational
structure of the motion detector in drosophila  neuron              
gbel  w   and helmchen  f          in vivo calcium imaging of neural network function  physiology  bethesda 
           
grienberger  c   and konnerth  a          imaging calcium in neurons  neuron            
hyvrinen  a   and oja  e          independent component analysis  algorithms and applications  neural netw    
       
mank  m   santos  a f   direnberger  s   mrsic flogel  t d   hofer  s b   stein  v   hendel  t   reiff  d f   levelt 
c   borst  a   et al          a genetically encoded calcium indicator for chronic in vivo two photon imaging  nat 
methods           
mukamel  e a   nimmerjahn  a   and schnitzer  m j          automated analysis of cellular signals from largescale calcium imaging data  neuron            
ozden  i   lee  h m   sullivan  m r   and wang  s s  h          identification and clustering of event patterns
from in vivo multiphoton optical recordings of neuronal ensembles  j  neurophysiol              
stone  j v   porrill  j   porter  n r   and wilkinson  i d          spatiotemporal independent component analysis
of event related fmri data using skewed probability density functions  neruoimage              
thvenaz p   ruttimann u e   and unser  m          a pyramid approach to subpixel registration based on
intensity  ieee transactions on image processing           

fi