dark matter halo detection in weak lensing regimes
matt anderson
stanford university
andersme stanford edu

phil chen
stanford university
pcchen stanford edu

dustin janatpour
stanford university
dustinj stanford edu

introduction

data and evaluation

the observing dark worlds competition found on kaggle 
a website aggregating machine learning competitions  posed
the following challenge  given an image of some fraction of
a sky with information about the location and observed ellipticities of hundreds of galaxies  can we predict the location
of dark matter halos in that sky 

we are given both training data and test data  the data consists of several hundred skies  three hundred for the training
set  one hundred and twenty for the test set   each comprised
of three hundred to seven hundred and twenty galaxy observations  additionally  the training data contains the locations
of true halos 

although current methods exist to predict the location of
these centers given comprehensive amounts of data such as
three dimensional position  mass  etc   there are not many
approaches to finding the centers given two dimensional images of a sky  however  for many regions of space  the only
data collected are two dimensional images  and thus the dark
matter structures in those regions of space are as of yet unknown 

each of the galaxies is specified by its  x y  position and its
ellipticities e  and e    e  corresponds to elongation along
the x and y axes  positive e  corresponds to a horizontally
elongated galaxy  and negative e  corresponds to a vertically
elongated galaxy  e  corresponds to elongation along the
axes    degrees from the x axis  positive e  corresponds
to elongation along the    degree axis  negative e  corresponds to elongation along the negative    degree axis 

from only two dimensional images  dark matter centers can
be detected by the ellipticity distortion they cause on each
galaxy  however  the incomplete and inherently noisy nature of the data complicates the problem  this distortion
cannot be observed directly  especially under weak lensing
assumptions  as a galaxys natural ellipticity is drawn from
a complex  unknown random distribution  in addition  these
background ellipticities tend to be large relative to the dark
matter signal  especially for galaxies far from the dark matter  only by considering every galaxy and enforcing the assumption that average natural ellipticity is close to zero can
we begin to look for signs of dark matter halos 

the quality of a set of predictions is measured by a combination of distance error  the average radial distance between
the predicted halo to the true halo  and positional bias  the
average angle between a prediction and the line generated
by a reference point and the true halo 

after ruling out many of the methods discussed in the course 
we adopted several distinct approaches to the problem  the
most successful was a variation on the k means algorithm
that used a modified clustering update rule and scoring mechanism for clusters that selected the best candidates  an alternative we considered was applying a batch gradient descent
to an objective function formulated directly from the physical model  however  the complexity of this model prevented
this method from producing global minima  leading to poor
results 

 gridded signal benchmark   divides the sky into a grid 
for each grid tile  this algorithm calculates the average
signal  sum of tangential ellipticities  for that tile relative
to the tile center  then outputs grid tiles with the highest
signal 

permission to make digital or hard copies of all or part of this work for
personal or classroom use is granted without fee provided that copies are
not made or distributed for profit or commercial advantage and that copies
bear this notice and the full citation on the first page  to copy otherwise  or
republish  to post on servers or to redistribute to lists  requires prior specific
permission and or a fee 
chi       april              boston  massachusetts  usa 
copyright      acm                                 

algorithms

benchmarks

the competition provides four benchmarks with publicly available algorithms  described briefly below 
 lenstool maximum likelihood   uses lenstool software
to estimate maximum likelihood for the halo positions 

 randomly placing halos   randomly places halos in the
sky 
 single halo maximum likelihood   divides the sky into
a grid  for each grid tile  calculates the maximum likelihood that a halo will be at the center of the grid tile 
outputs the single most likely halo 

variations of k means clustering

in attempting to tackle this problem  we considered many
algorithms  we believed that the problem lent itself to the kmeans clustering algorithm in the sense that cluster centers
 

fifigure    an example sky with the halos being shown

we calculate r as the euclidean distance 
q
r    gy  hy       gx  hx   

might somehow be correlated to halos  since halos typically
affect the set of nearby nodes  we examined how we might
vary the k means clustering to achieve such a correlation 
to begin  we analyzed the k means clustering to determine
what difficulties we might have 

 centroid updating rule  in place of the usual centroid calculation  we modified the centroid update rule in an attempt to maximize local tangential ellipticity  after we
calculated the centroid for a particular cluster  we perturbed it by using neighboring points to generate an update vector 

difficulties

 susceptible to local minima  since calculating optimal
clusters is an np hard problem  the algorithms typically
used for k means are heuristic and converge to local optima  therefore  we would not be able to calculate global
optima

we know that the effect of a dark matter halo on surrounding galaxies is inversely related to the distance to
the galaxy  specifically  dark matter halos cause elongation of galaxies along the tangential axis  thus  for each
neighboring point  we construct a vector from the galaxy 
g  to the halo  h 


v  hg

 clusters  the galaxy and dark matter halo positions are
uncorrelated  rather  the ellipticities and the dark matter
halo positions are   thus  the idea of clusters  as traditionally defined  does not perfectly apply to the data 
 centroids  using the positional centroid of the points assigned to a particular cluster does not provide any information regarding the existence of a halo 

we calculate the length of this vector  distance from galaxy

to halo   we take the vector normal  
n   to the galaxys

major axis  based on its ellipse   we then project 
v onto


n as follows 



v 
n



n
p  



n  n

 number of clusters  for predicting a single halo  the algorithm would converge after only one iteration under traditional k means  as all points would be assigned to a single
cluster 
approach

we then calculate the update vector 




u  
v 
p

to deal with these difficulties  we attempted to modify the
k means algorithm as follows 

we average the update vectors for all of the neighboring
points  then  we apply this final update vector to the centroid to perturb it  we do not consider convergence until
either the cluster center has stopped changing or no new
assignments have been calculated 

 assignment rule  we attempted to use a modified distance
metric for calculating assignments based on the tangential
ellipticity  this distance metric was
dpdm  h  g     e  cos      e  sin     r 
where the angle from the galaxy center    was defined as
follows 


gy  hy
   arctan
gx  hx

 scoring function  to deal with the convergence to local
minima  we initialize the algorithm with a k parameter
that is greater than the number of halos  once the clusters
have converged  we score each cluster and return the top
 

ficlusters  after running this algorithm several times  we
take the average of the clusters 
we used two types of scoring functions  one based on
signal  tangential ellipticity  and one based on maximum
likelihood  the signal based scoring function was simply
the sum of all tangential ellipticities of its neighbors  the
maximum likelihood approach was based on single maximum likelihood  that is 

now  the assumption given is that the magnitude of the average ellipticity should be close to zero  so for the objective
function  we wish to minimize
fi 
fi
fi
fix
fi
 i  fi
es fi  
fi
fi
fi
i

from the above equations  we can write

 
f 
r

 i 
e i 
s   ec 

x

i
h
exp  i ij 

  x i 

j

f     cos    f



 j  
   y  i   y  j      

x j    

then  we have

f     sin    f

fi 
fi
fi
fix
fi
 i  fi
es fi  
j h    fi
fi
fi

c    f   e        f   e    

i

c

s   e  

fi
fi 
fi
fi
i
h
 j  
fix  i  x
fi

 ij 
fi
fi
ec 
exp  i
fi
fi
 i 
 j 
 
 i 
 j 
 
  x

x
 
 
 y

y
 
 
fi i
fi
j

batch gradient descent
introduction and formulation

we wish to formulate the halo center finding problem as a
minimization problem in order to apply the batch gradient
descent algorithm to an objective function and hopefully obtain a good set of halos  given a sky with m galaxies and n
halos  we write
  i  
  j  
x
y
 i  

y
   h j     x j  
g  i    
   
 i 
 e 
 j 
 

 i 
e 

we then wish to minimize this value with respect to  j    x j    y  j 
for j           n  since we wish to perform a batch gradient descent with constraints  in this case     x j    y  j  
       j       we could add a log barrier function to penalize values that are too close to the barriers  however 
for the sake of simplicity  we broke the function into two
parts  since the log barriers are added linearly to the objective function  we first apply the gradient descent rule under
the assumption of no log barriers  then add the barriers at the
end 

for i           m  j           n  for each galaxy and halo 
 i 
 i 
x and y represent its x and y coordinates  e  and e  are
the real and imaginary ellipticities of the ith galaxy  respectively  and  j  is the einstein radius of the jth halo  the
positional angle of the vector from the jth halo center to the
ith galaxy is

  i 
y  y  j 
 ij    arctan
x i   x j 

using eulers identity and the fact that ec is complex  we
rewrite the above as j h    a    b    with

 i 

a 

b 

x

x

 i 

e  

x

i

  ij 
b 

 i 

j



  x i 



 j  
   y  i   y  j      

x j    

 j  
  x i   x j        y  i   y  j      

noting the similarities in the equations above  we write
h
i
x  i  x
 ij 
 ij 
cos f 
f 
a 
e  

where es is the natural ellipticity of the ith galaxy    ij   
 j  
 ij 
exp   ij  i   ij     where r is the angle between the galaxy
r
and the halo with respect to the observer  since the ob ij 
server is very far away  this approximates to r   r ij   
 i 
 j   
 i 
 j       
  x x     y y       the distance between them
in the image  thus  we may write
  x i 

h
i
sin   ij 

j

j

x
ec i    e i 
exp   ij  i 
s  

h
i
cos   ij 

j

i

for galaxy i is
x

 i 

e  

i

 i 
and the observed  complex  ellipticity of each galaxy is ec  
 i 
 i 
e   ie    in the weak lensing limit  the observed ellipticity

 i 
e i 
c   es  

x

j

x

 i 

e  

i

x

i
h
 ij 
 ij 
f 
sin f 

j

where
 ij 
f 

 j  
   y  i   y  j      

 ij 

f 

x j    

 

 


    arctan

  x i 



y  i   y  j 
x i   x j 



 j  
   y  i   y  j      

x j    

fi ij 

f 
 
y  j 

update rule

with learning rate   we give the batch gradient descent rule
for our objective 
 j      j   
x j     x j   

  


j h 
 j 

 ij 

y

   y

 j 


j h 
x j 
and rx


   j  j h 
y

a
b

j h     a  j     b  j 
x j 
x
x

and
 ij 

x
a
 ij  f
 
cos f      j 
 j 


i

 ij 

  x i   x j    ry

 ij 

x
a
 ij  f
 ij  f
 ij 
 

cos f      j   sin f      j  f 
 j 
x
x
x
i


j    h 
 j 

x j     x j   


j    h 
x j 

y  j     y  j   


j    h 
y  j 

 

 
 
 ij 
 ij 
x
b
 ij  f 
 ij  f 
 ij 
 
sin f     j    cos f     j  f 
x j 
x
x
i

with
 ij 

x
a
 
 ij  f
 

cos f      j 
 j 
 j 

i

 
 
 ij 
 ij 
x
a
 ij  f 
 ij  f 
 ij 
 
cos f     j   sin f     j  f 
y  j 
y
y
i

 ij 

x
b
 
 ij  f
   j  
sin f      j 
 j 



i

 
 
 ij 
 ij 
x
b
 ij  f 
 ij  f 
 ij 
 
sin f     j    cos f     j  f 
y  j 
y
y
i

 

with

ax   
 

 ij  

ry

 
  

 ij 
 ij  f
cos f      j 

x

x

i

 j 
 ij  

  rx

 
bx   

 ij 
f 
x j 

 ij 
 ry

   
 ij 
 ij  
ry
rx
 ij 
rx

x

 
ay   

x

 ij 

f 
 rx  j  
 
 
 j 
x
 ij  
 ij  
ry
  rx

 ij 
 ij  f
sin f      j 

x

i

 ij 
 ij  f
cos f      j 

y

i
 ij 

  y  i   y  j   

 j      j   

 ij 

x
b
 ij  f
 
sin f      j 
 j 


i

 

 ij 

 
 
 
log      y  j        log   y  j        log    j      
 
 
 
we can see that as any of the parameters approaches a boundary  b goes to infinity  to keep b from dominating the objective function far away from the barrier  we add a scaling
parameter   so that our new objective function is j    h   
a    b    b h   the new gradient updates are


a
b
j h     a  j     b  j 
y  j 
y
y

 ij 
f 
 j 

 ij 

rx

to penalize values that approach the boundaries  we add a
function b h  to the objective function  where b h  is
x 
 

  log        x j         log     x j       
 
 
j


a
b
j h     a  j     b  j 
 j 




 ij 

   

adding a log barrier

where

 

 ij 
ry
 ij 
rx

f 
 ry  j  
 

 
x j 
 ij  
 ij  
ry
  rx
 ij 

 j 

 


 



 ij 
 ij  f
 ij 
sin f      j  f 

 

 

 ij 
 ij  f
 ij 
cos f      j  f 

 



 ij 
 ij  f
 ij 
sin f      j  f 

 

 

 ij 
 ij  f
 ij 
cos f      j  f 

 
by   

x
i

 

 ij 
 ij  f
sin f      j 

y

x

x

y

y

fiin addition  the signal this objective function reflects is very
weak  it is quite reasonable that  even in the absence of dark
matter  the average over the galaxys ellipticities will be nonzero 

 
 
a
   j  
  ax
x j 
x
      x j 
b
 
 
   j  
  bx
 j 
x
x
      x j 

finally  though we are in the weak lensing regime  the assumption that we are operating in the weak lensing limit may
have been inaccurate  however  the full formalism for weaklensing regime observed ellipticity is

a
 
 
   j  
  ay
 j 
y
y
      y  j 

 i 

b
 
 
   j  
  by
 j 
y
y
      y  j 
the rest of the algorithm proceeds as without the barrier 

ec i   


 
 i 

  es

es  
  

where  is convergence  which we are not given  using this
to develop the objective  however  yields a function that is
even less conducive to gradient descent 

results and discussion
modified k means

we tested the variations of the k means algorithm with all
possible combinations of traditional and different factors 

while initial progress was promising  neither our modified
clustering approach nor our batch gradient descent rule yielded
robust results  we believe that  despite our best efforts  the
former model was too coarse to adequately respond to the
highly nuanced lensing perturbations caused by the presence of halos  and the latter was subject to the limitations
of non convexity on the objective function  though we had
hoped to test alternate approaches  for instance binary classification indicating the approximate presence of halos in sky
localities or factor analytical models that acknowledge variation in mass  density  and position of halos as unobserved
variables  we struggled to adequately featurize and linearly
separate the data  we also found it difficult to formulate
linear approximations for nonlinearity intrinsic to the problem  given more time  however  we believe progress could
be made through the development of techniques for solving
nonlinear factor analytical models 

using a combination of the traditional assignment and modified update rule with the maximum likelihood scoring function produced results that were better than the random benchmark and the single maximum likelihood benchmark  the
reason for the improvement was its ability to distinguish
multiple clusters more effectively than the single maximum
likelihood  however  it performed worse than the gridded
signal benchmark 
ultimately  the performance of the k means algorithm was
slow computationally and poor relative to the benchmarks 
the computational complexity was high due to the numbers
of iterations  clusters  and averaging  the main issue was the
susceptibility to local optima  which is an intrinsic weakness
of the algorithm  for example  on a typical run  eight out of
the ten runs would be relatively accurate  but the other two
had high enough variation to introduce significant error  one
possible cause is the fact that the clusters could be surrounding the halos  but the individual centers of the clusters would
not be close to true halo 

references

   narayan  r     bartelmann  m          lectures on
gravitational lensing  arxiv preprint astro ph         
   bernstein  g  m     jarvis  m          shapes and
shears  stars and smears  optimal measurements for
weak lensing  the astronomical journal              

one potentially interesting approach would be to construct a
mixture of gaussians model that attempted to learn the density of dark matter halos with regard to galaxies  we would
then use the model to generate potential dark matter halo locations 

   bartelmann  m     schneider  p          weak
gravitational lensing  physics reports                  
   padmanabhan  n   seljak  u     pen  u  l         
mining weak lensing surveys  new astronomy       
        

batch gradient descent

we tested batch gradient descent on each training sky by discretizing and choosing many sets of initialization points and
returning the set of parameters that converged to the best
objective  unfortunately  application of this algorithm performed worse than the random benchmark  this is likely
due to a number of factors which we outline below 

   munshi  d   valageas  p   van waerbeke  l     heavens 
a          cosmology with weak lensing surveys 
physics reports                 

first and foremost  our objective function is non convex 
thus  even in instances in which the gradient converged  which
was not always the case   we could at best hope for locally
optimal results  the objective function is also highly sensitive to the behavior of galaxies that are very close to the
halos  and thus gradient descent behaves poorly 
 

fi