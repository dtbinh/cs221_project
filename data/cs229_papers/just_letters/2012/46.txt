machine learning in pairs trading strategies
yuxing chen  joseph 

weiluo ren  david 

xiaoxiong lu

department of statistics
stanford university
email  josephc  stanford edu

department of mathematics
stanford university
email  weiluo stanford edu

department of electrical
engineering
stanford university
email  lxx stanford edu

keywords  pairs trading  mean reverting  ornstein uhlenbeck
process  portfolio rebalancing  kalman filter  kalman smoother 
em

  introduction
pairs trading consists of long position in one financial
product and short position in another product and we focus
the form of statistical arbitrage instead of trend following 
these strategies are market neutral and have low risk 
choose two securities      and denote their prices as
s   s    then the spread is s    s    where  is a
carefully chosen constant depending on time  the simplest
case is that       the spread becomes simply difference
between two prices 
we assume that the spread is a mean reverting process 
meaning if deviations of spread from its mean occur  this
deviation will eventually vanish  then when deviations
arise  we long the relatively cheap securities and short sell
the relatively expensive securities and then wait for the
spread will go back to its mean level to make profit  this is
the basic idea behind many pairs trading strategies
including ours 
the question now becomes how to model the meanreverting process of spread so that entering and exiting
trading signal can be developed from that model  in this
paper  ornstein uhlenbeck process is used as the
underlying model of spread 
     
dx  t         x  t   dt   dw  t  
where x  t   is the spread at time t   measures the speed
of x  t   returning to its mean level    and  is the

volatility of spread 
in this project  two approaches are applied  one is
starting from difference of daily returns instead of spread of
prices  and integrating this process and using a linear

regression to estimate coefficients          another one is
assuming a spread model which is a latent o u process
plus some noise and building signals based on prediction
generated from kalman filter  e m algorithm modified for
kalman smoother filter is applied to estimate coefficients
in the spread model 
in section   and    models and algorithms are given in a
backwards order first  starting from models and then

introducing algorithms in order to estimate parameters in
models  very brief summaries of real procedures are given
in later part of section   and    showing the order of how
algorithms should be implements 

  portfolio rebalancing   linear regression
approach
the advantage of this approach is simplicity  linear
model is convenient to be interpreted and if anything goes
wrong  it is easy to spot the source of problem 

    assumptions and portfolio rebalancing
we assume that the daily returns of two financial
products satisfy the following stochastic differential
equation 

ds   t  
ds  t  
  dt      dx  t  
s   t  
s   t  

     

the drift term  is the trend of spread of daily returns   is
a constant which cannot change much along time  x  t   is
a mean reverting process  in practice  this equation says
that if we long    securities one and short selling
   securities two  the daily return of our portfolio should
be mean reverting given the condition that     

the

magnitude of fluctuation of x  t     which is usually the
case 
from the above explanation  we can see why

 cannot change much along time  since
                       are weights within our portfolio 
if  changes frequently and in a large magnitude  meaning

that portfolio needs rebalancing frequently and weights
change much  then the profit cannot cover the cost of
rebalancing  it is better to run a regression to find  at

t  and keep  as a constant for a short period of time e g   
or    days  and check whether x  t   from
ds  t  
ds  t  
dx  t          has mean reverting property 
s   t  
s    t  

fithus

    the o u model of spread
as stated in section    we use o u process       to
model the dynamic of the spread x  t     thus we have

dx  t         x  t   dt   dw  t  

     

integrating the above equation we have    

x  t   t    et x  t         et      a t    t  

a

t  t



e    t  t  s  dw   s  

     

t 

now let t tend to infinity  the equilibrium probability
distribution of x  t   is normal with

 
e  x  t      and var  x  t    
 

     

with       and        we are able to estimate the
parameters in the o u process 

    linear regression for estimating
weights and parameters

   log b      
m  a       b 



var       
   b 

moreover  we are able to get the equilibrium standard
deviation from       now 

 eq   var  x  t    

 
 

     

at this stage  we can use the standardized version
of x  t     called z score as trading signal  this factor
measures how far x  t   deviates from its mean level and is
a valid measure across all securities since it is
dimensionless  more details of signal will be given later 

    summary of the procedure
a summary of the whole procedure will be given and
it displays the order within the implementation of the
trading strategy 
first run a linear regression on daily returns on a

let us denote

rt  

s s
st  
 
t

 
t  

moving window to get  t and new weight   performing

  t  

 
t

rebalancing if necessary   then use  t to sum to discrete
version of x k and run another regression of x k to obtain

 
t

run a linear regression of r against r on a moving
window with length    

rt       rt    t   t  t  



  t  



and note that                       is the weight of
portfolio and also that we may run the above regression
every   days as indicated in section     
then we use the sum of residuals to obtain the discrete
version of x k
k

x k    j   k  t    t  
j t 

then use these x k and linear regression again to estimate

parameters       in the o u process and z score as
trading signal 
the buying and selling rules are
buy to open if si   sbo
sell to open if si   sso
close long position if si   ssc
close short position if si   sbc

    back test results
we use closing price  daily data  of two chosen future
contracts in china future market  the daily return plot is
shown as below 

parameters       as below 

x k    a  bx k   k     k  t    t  
by       we have

a      et   
b  et

var        

   e  t
 

figure     daily returns of two securities

fithe plot of   updated every five trading days  is

the observation process
we assume the spread process   yk   is the observation
of  xk   with gaussian noise 

yk  xk  dk

     

where  k   are also i i d gaussian n       and
independent of   k    

figure      which indicates the weight of portfolio

the trading signal

the plot of cumulative profit and summary are given 
we consider the transaction cost of buying selling plus
slippage is    basis points 

here we define

xk  l  e  xk   fl  

     

k  l  e   xk  xk      fl  

     

xk  xk  k

     

the conditional expectation given observed information
fl   either from an expanding window or a moving window 
if yk  xk  k    transaction cost   premium  here the
premium is the profit that we want to ensure when enter a
position  then the spread is regarded as too large  meaning
the securities   if relatively expensive than securities    we
would take a long position in the spread portfolio  short
selling one unit   and longing one unit of product    
expecting that the spread will shrink eventually 

figure     cumulative profit

annualized
return rate
     

volatility

sharpe

     

    

maximal
drawdown
     

similarly  if yk  xk  k    transaction cost   premium 

  kalman filter and em algorithm approach
    the spread model

we close positions when   yk  xk  k        where

the state process

 stands for one day and xk is some variable at
time tk  k for k           satisfying the following
here

mean reverting dynamic  discrete version of ou process  
     

     b     a    and   k   is i i d gaussian
n         thus   k   in the above equation is independent
of all xk   and the process mean reverts to   a   b with
where

 speed  b  therefore  we can rewrite       as follows

xk    a  bxk  c k  

 is

a predetermined threshold 

we studied   yk     the simplest spread s   s    with the
assumption that it is a noisy observation of a latent meanreverting state process  xk    

xk    xk   a  bxk      k  

then the spread is lower than the expectation significantly 
we would take a short position in the spread portfolio 

     

the state xk is hidden  which needs observations to
estimate 

    kalman filter
equiped with state equation       and observation
equation        our next step is to estimate the hidden
process 
in order to estimate xt   t   the prediction of the next day
at time t  we will start from time   and the initialization
x   y  and      d     recall the definition       to
      then perform the following procedure iteratively
until k  t  
in the prediction step  we would compute the
 prediction 

xk   k  a  bxk  k

     

k   k  b k  k  c  

     

the optimal kalman gain is

kk    k   k    k   k  d   

     

fithen we can compute our estimation with the new
observation yk   in the following update step 

xk    xk   k    xk   k  kk    yk    xk   k  

rk    k   k    d  kk    k   k  kk  k   k

k n  e   xk  xk n      fn    e   xk  xk  n            
k   k n  e   xk  xk n    xk    xk   n   

      

      

they can be computed backwards  meaning that xk  n  
      

repeat the above process to obtain xt t and xt   t  

 k  n   and k   k  n can be obtained from xk   n   k   n  
and k  k   n     
let us use first few steps to illustrate how em
algorithm works in the form of kalman smoother filter 

figure     kalman filter

the

above

algorithm is based on knowing
    a  b  c   d     but  is unknown now  we need an
extra training set to estimate the parameters a  b  c and d
before using kalman filter and these parameters are
estimated via em algorithm 
 

 

figure     em in the form of smoother filter

    estimation using em algorithm
before predicting xk   k we now use the em algorithm

from the above figure  the operation rules with blue
arrows indicating smoother and filter are known  so now

to estimate     a  b  c   d   based on the observations

we go to the rule of updating a  b  c  d using x k  n    k  n  

y    y       yk  

and k   k  n  

 

 

recall the general form of em algorithm   p is a
probability measure with parameter    

    a  b  c     d     and initial values for the
given 
j
    a   b   c   d   are
kalman filter  the update 
j  
 

step    e step 

 

calculate as follows 



compute e j log




dp
  fn 
dp j


step    m step 
update  j to  j  by maximizing conditional expectation 

      

n   
b 
n    

      

  n
      f  
c       xk  a  bx
k  
n
n k  



dp
 j    arg max e j log    fn 

 dp j


d   

here we are going to use shumwau and stoffer    
smoother to implement em algorithm  we define
smoothers for k  n  note that they have the same form of
definition for filtering when k  n   

xk n  e  xk   fn  

  
n    

a 

      

  n
   yk  xk      fn  

n    k  

where
n

n

k  

k  

  e  xk     fn     k   n  xk   n  

      

      

fin

n

k  

k  

  e  xk   xk   fn     k   k  n  xk   n xk  n  
n

  xk   n
k  

n

  xk   n    xn  n  x  n
k  

    summary of algorithms
as shown in figure      we start from

x       x          

figure     actual spread vs prediction

and continuing updating  after k        we use the
prediction xk   k as trading signal 
besides  the em algorithm in     is implementated
using expanding window as above which would cause
heavy computational burden  so we also implement the em
using moving window for updating as well 

    result of implementation
we pair two future contracts of agricultural products in
china market and estimate the process of spread 
with kalman filter and em algorithm  we can predict
the hidden state xk   k using an expanding window  plotted
in figure     

figure     cumulative profits

  conclusion and analysis
we are betting on meaning reversion of spread  thus it is
necessary to check whether the spread between two
securities has such property in historical data  if the spread
has obvious upward or downward trend  then loss may
incurr  setting a loss cutting limit can be implemented 

figure     actual spread vs prediction

as shown in figure      the actual spread yk is osillating
around our prediction  when yk deviates from xk  k  
significantly  we would expect that the spread will shrink
eventually and we will take advantage of this to make profit 

it seems that the smoother filter approach has better
returns         and        compared with the linear
regression approach  the cost of rebalancing in the latter
one may be the reason  we have to realize that linear
regression is simple and it is easy to be interpreted while
smoother filter approach is a black box 
reference
   
   
   

figure     is the prediction made from em on a moving
window  comparison of cumulative profits of using two
windows is given as well  figure      

   
   
   

statistical arbitrage in the u s  equities market  marco avellaneda and
jeong hyun lee 
sanford weisberg  applied linear regression  third edition  john
wiley   sons  inc 
david serbin  trend following signal confirmation using non price
indicators 
robert j  elliott  john van der hoek and william p  malcolm  pairs
trading  quantitative finance  vol        pp          
elliott  r j   l  aggoun and j b  moore  hidden markov models 
 springer verlag      
shumway  r h  and d s  stoer  an approach to time series
smoothing and fore casting using the em algorithm  journal of time
series                       

fi